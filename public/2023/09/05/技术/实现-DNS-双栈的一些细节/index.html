

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/logo.png">
  <link rel="icon" href="/img/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="oldwang12">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. 概述当客户端是双栈环境时，客户端在向 DNS 服务器请求地址解析时，会同时发起域名 A 记录和 AAAA 记录的解析请求，如果后台支持双栈（或者DNS自己返回了双栈的解析结果），就会拿到对应的两种解析地址结果：IPv4 和 IPv6，拿到解析结果后，由客户端选择地址发起连接。为了推广 IPv6，客户端应该从解析结果中优先选择 IPv6 进行连接，但由于当前 IPv6 基础建设尚未完善，连通性">
<meta property="og:type" content="article">
<meta property="og:title" content="实现 DNS 双栈的一些细节">
<meta property="og:url" content="http://blog.oldwang.fun/2023/09/05/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E7%8E%B0-DNS-%E5%8F%8C%E6%A0%88%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/index.html">
<meta property="og:site_name" content="oldwang12的博客">
<meta property="og:description" content="1. 概述当客户端是双栈环境时，客户端在向 DNS 服务器请求地址解析时，会同时发起域名 A 记录和 AAAA 记录的解析请求，如果后台支持双栈（或者DNS自己返回了双栈的解析结果），就会拿到对应的两种解析地址结果：IPv4 和 IPv6，拿到解析结果后，由客户端选择地址发起连接。为了推广 IPv6，客户端应该从解析结果中优先选择 IPv6 进行连接，但由于当前 IPv6 基础建设尚未完善，连通性">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-09-05T03:20:13.000Z">
<meta property="article:modified_time" content="2023-09-05T05:49:49.283Z">
<meta property="article:author" content="oldwang12">
<meta property="article:tag" content="dns">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>实现 DNS 双栈的一些细节 - oldwang12的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.oldwang.fun","root":"/","version":"1.9.5","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>oldwang12</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">实现 DNS 双栈的一些细节</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-05 11:20" pubdate>
          <!-- 2023年9月5日 上午 -->
          2023年9月6日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          27k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          68 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">实现 DNS 双栈的一些细节</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>当客户端是双栈环境时，客户端在向 DNS 服务器请求地址解析时，会同时发起域名 A 记录和 AAAA 记录的解析请求，如果后台支持双栈（或者DNS自己返回了双栈的解析结果），就会拿到对应的两种解析地址结果：IPv4 和 IPv6，拿到解析结果后，由客户端选择地址发起连接。<br>为了推广 IPv6，客户端应该从解析结果中优先选择 IPv6 进行连接，但由于当前 IPv6 基础建设尚未完善，连通性问题和可靠性问题不能得到有效保证，链接超时或失败会造成用户可感知的负面体验，有这些负面体验用户可能就完全禁止 IPv6，所以还是需要使用 IPv4 协议适当的做降级和兜底。<br>针对 IPv6 的回退和降级策略，IETF 于2012年发布 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6555">RFC6555</a> 和2017年发布 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc8305">RFC8305</a> 两版 RFC 算法来描述了关于在域名解析、地址排序和连接尝试阶段v4配合v6升级适配的详细方案，该方案称为：Happy Eyeballs。</p>
<ul>
<li>RFC6555: Happy Eyeballs: Success with Dual-Stack Hosts</li>
<li>RFC8305: Happy Eyeballs Version 2: Better Connectivity Using Concurrency</li>
</ul>
<h2 id="Why-Happy-Eyeballs"><a href="#Why-Happy-Eyeballs" class="headerlink" title="Why Happy Eyeballs ?"></a>Why Happy Eyeballs ?</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">The name <span class="hljs-string">&quot;happy eyeballs&quot;</span> derives <span class="hljs-built_in">from</span> <span class="hljs-keyword">the</span> term <span class="hljs-string">&quot;eyeball&quot;</span> <span class="hljs-built_in">to</span> describe endpoints which represent human Internet <span class="hljs-keyword">end</span>-users, <span class="hljs-keyword">as</span> opposed <span class="hljs-built_in">to</span> servers.<br></code></pre></td></tr></table></figure>
<p>我的理解是，Happy Eyeballs 的关注点是人类本身而不是机器，人类在互联网上浏览网页，观看视频，不能因为 IPv6 和 IPv4 网络的连通性问题让他们眼球停留在加载页面，而应该让他们的眼球快乐起来。</p>
<p>RFC6555 描述了 Happy Eyeballs 原始算法，RFC8305 在 RFC6555 的基础上，添加了如下内容：</p>
<ul>
<li>如何执行DNS查询以获取这些地址</li>
<li>如何处理每个地址族的多个地址</li>
<li>连接竞速时如何处理DNS更新</li>
<li>如何利用历史信息</li>
<li>如何适配使用NAT64和DNS64实现的单栈IPv6网络</li>
</ul>
<p>RFC8305 描述的算法仍然符合 RFC6555 的规范，只不过更加细节化，RFC8305 的中文版参考这里。</p>
<h1 id="2-Happy-Eyeballs-快乐眼球算法"><a href="#2-Happy-Eyeballs-快乐眼球算法" class="headerlink" title="2. Happy Eyeballs-快乐眼球算法"></a>2. Happy Eyeballs-快乐眼球算法</h1><p>RFC8305 定义的 Happy Eyeballs 归纳如下：</p>
<ol>
<li>向DNS 服务器同时发起AAAA记录和A记录解析（AAAA 先于 A）</li>
<li>如果v6地址先返回就直接开始握手建立连接，如果v4地址先返回，则等待 50ms 等待v6地址返回，以确保优先选择IPv6（AAAA响应跟随A响应几毫秒是很常见的）</li>
<li>将所有已解析的目标地址排序，排序依据 ([RFC8305], Section 4) 及 ([RFC6724], Section 6)</li>
<li>排序完成后，会依次有序的取地址发送握手请求，并启动定时任务，该任务在250ms后检查若未完成连接建立，则对第二个地址开始连接尝试</li>
<li>只有有一个握手确认成功（建立了连接），就会取消所有其他的连接尝试</li>
</ol>
<p>RFC6555 中有一点不一样的是，对解析的所有目标地址选取的算法参考的是 [RFC3484] ，[RFC3484]  已经被 [RFC6724] 取代，目的地址排序规则会影响 IPv4 及 IPv6 地址的先后顺序，具体我们在下一节分析。</p>
<p>Happy Eyeballs 要求在尝试连接之前，实现上不应该等待两个地址族都返回 answers，如果一个查询无法返回或者需要花费更长的时间返回，那么就会造成连接建立的延迟，因此，客户端应将 DNS 解析实现为异步。这一点在 curl 及 go 的实现中都没能做到，curl 会调用 getaddrinfo 方法获取所有地址解析结果后再尝试连接竞速，go 有自己实现的主机名到地址的解析函数，会根据系统及配置选择使用go原生的地址解析函数或者 getaddrinfo，但无论怎样，也是在获取所有地址解析结果后再尝试连接竞速。</p>
<p>总体来看，Happy Eyeballs 分为目的地址排序和连接竞速两个主要阶段，我们一一来看。</p>
<h2 id="2-1-目的地址排序"><a href="#2-1-目的地址排序" class="headerlink" title="2.1. 目的地址排序"></a>2.1. 目的地址排序</h2><p>目的地址选取依据 [RFC3484] 及 [RFC6724]，[RFC3484] 已经被 [RFC6724] 取代，但是 getaddrinfo 还是使用了 [RFC3484] 进行目的地址选取排序，go 实现的主机名到地址的解析函数使用了 [RFC6724]。<br>注：[RFC3484] 和 [RFC6724] 描述了源地址及目的地址选取算法，这里我们只关注目的地址选取。</p>
<p>目的地址选取遵循 10 条规则，优先级 1 &gt; 2 &gt;3 &gt; 4 …，满足一条就返回。<br>目的地址中设计到一些名词我们重点关注一下：</p>
<ul>
<li>scope</li>
<li>precedence</li>
<li>label</li>
<li>home addresses</li>
<li>care-of address</li>
</ul>
<table>
<thead>
<tr>
<th>规则</th>
<th>RFC3484</th>
<th>RFC6724</th>
</tr>
</thead>
<tbody><tr>
<td>Rule 1</td>
<td>Rule 1: Avoid unusable destinations.</td>
<td>Rule 1: Avoid unusable destinations.</td>
</tr>
<tr>
<td>避免无法使用的地址</td>
<td>If DB is known to be unreachable or if Source(DB) is undefined, then prefer DA. Similarly, if DA is known to be unreachable or if Source(DA) is undefined, then prefer DB.</td>
<td>If DB is known to be unreachable or if Source(DB) is undefined, then prefer DA. Similarly, if DA is known to be unreachable or if Source(DA) is undefined, then prefer DB.</td>
</tr>
<tr>
<td>Rule 2</td>
<td>Rule 2: Prefer matching scope.</td>
<td>Rule 2: Prefer matching scope.</td>
</tr>
<tr>
<td>匹配源地址 scope 优先</td>
<td>If Scope(DA) &#x3D; Scope(Source(DA)) and Scope(DB) &lt;&gt; Scope(Source(DB)), then prefer DA.  Similarly, if Scope(DA) &lt;&gt; Scope(Source(DA)) and Scope(DB) &#x3D; Scope(Source(DB)), then prefer DB.</td>
<td>If Scope(DA) &#x3D; Scope(Source(DA)) and Scope(DB) &lt;&gt; Scope(Source(DB)), then prefer DA.  Similarly, if Scope(DA) &lt;&gt; Scope(Source(DA)) and Scope(DB) &#x3D; Scope(Source(DB)), then prefer DB.</td>
</tr>
<tr>
<td>Rule 3</td>
<td>Rule 3: Avoid deprecated addresses.</td>
<td>Rule 3: Avoid deprecated addresses.</td>
</tr>
<tr>
<td>避免已经弃用的地址</td>
<td>If Source(DA) is deprecated and Source(DB) is not, then prefer DB. Similarly, if Source(DA) is not deprecated and Source(DB) is deprecated, then prefer DA.</td>
<td>If Source(DA) is deprecated and Source(DB) is not, then prefer DB. Similarly, if Source(DA) is not deprecated and Source(DB) is deprecated, then prefer DA.</td>
</tr>
<tr>
<td>Rule 4</td>
<td>Rule 4: Prefer home addresses.</td>
<td>Rule 4: Prefer home addresses.</td>
</tr>
<tr>
<td>home addresses 优先</td>
<td>If Source(DA) is simultaneously a home address and care-of address and Source(DB) is not, then prefer DA.  Similarly, if Source(DB) is simultaneously a home address and care-of address and Source(DA) is not, then prefer DB. If Source(DA) is just a home address and Source(DB) is just a care-of address, then prefer DA.  Similarly, if Source(DA) is just a care-of address and Source(DB) is just a home address, then prefer DB.</td>
<td>If Source(DA) is simultaneously a home address and care-of address and Source(DB) is not, then prefer DA.  Similarly, if Source(DB) is simultaneously a home address and care-of address and Source(DA) is not, then prefer DB. If Source(DA) is just a home address and Source(DB) is just a care-of address, then prefer DA.  Similarly, if Source(DA) is just a care-of address and Source(DB) is just a home address, then prefer DB.</td>
</tr>
<tr>
<td>Rule 5</td>
<td>Rule 5: Prefer matching label.</td>
<td>Rule 5: Prefer matching label. If Label(Source(DA)) &#x3D; Label(DA) and Label(Source(DB)) &lt;&gt; Label(DB), then prefer DA.  Similarly, if Label(Source(DA)) &lt;&gt; Label(DA) and Label(Source(DB)) &#x3D; Label(DB), then prefer DB.</td>
</tr>
<tr>
<td>匹配 label 优先</td>
<td>If Label(Source(DA)) &#x3D; Label(DA) and Label(Source(DB)) &lt;&gt; Label(DB), then prefer DA.  Similarly, if Label(Source(DA)) &lt;&gt; Label(DA) and Label(Source(DB)) &#x3D; Label(DB), then prefer DB.</td>
<td></td>
</tr>
<tr>
<td>Rule 6</td>
<td>Rule 6: Prefer higher precedence.</td>
<td>Rule 6: Prefer higher precedence.</td>
</tr>
<tr>
<td>高优先级优先</td>
<td>If Precedence(DA) &gt; Precedence(DB), then prefer DA.  Similarly, if Precedence(DA) &lt; Precedence(DB), then prefer DB.</td>
<td>If Precedence(DA) &gt; Precedence(DB), then prefer DA.  Similarly, if Precedence(DA) &lt; Precedence(DB), then prefer DB.</td>
</tr>
<tr>
<td>Rule 7</td>
<td>Rule 7: Prefer native transport.</td>
<td>Rule 7: Prefer native transport.</td>
</tr>
<tr>
<td>原生传输协议优先</td>
<td>If DA is reached via an encapsulating transition mechanism (e.g., IPv6 in IPv4) and DB is not, then prefer DB.  Similarly, if DB is reached via encapsulation and DA is not, then prefer DA. Discussion:  6-over-4 [15], ISATAP [16], and configured tunnels [17] are examples of encapsulating transition mechanisms for which the destination address does not have a specific prefix and hence can not be assigned a lower precedence in the policy table.  An implementation MAY generalize this rule by using a concept of interface preference, and giving virtual interfaces (like the IPv6-in-IPv4 encapsulating interfaces) a lower preference than native interfaces (like ethernet interfaces).</td>
<td>If DA is reached via an encapsulating transition mechanism (e.g., IPv6 in IPv4) and DB is not, then prefer DB.  Similarly, if DB is reached via encapsulation and DA is not, then prefer DA. Discussion: The IPv6 Rapid Deployment on IPv4 Infrastructures (6rd) Protocol [RFC5969], the Intra-Site Automatic Tunnel Addressing Protocol (ISATAP) [RFC5214], and configured tunnels [RFC4213] are examples of encapsulating transition mechanisms for which the destination address does not have a specific prefix and hence can not be assigned a lower precedence in the policy table. An implementation MAY generalize this rule by using a concept of interface preference and giving virtual interfaces (like the IPv6-in-IPv4 encapsulating interfaces) a lower preference than native interfaces (like ethernet interfaces).</td>
</tr>
<tr>
<td>Rule 8</td>
<td>Rule 8: Prefer smaller scope.</td>
<td>Rule 8: Prefer smaller scope.</td>
</tr>
<tr>
<td>更小的 scope 优先</td>
<td>If Scope(DA) &lt; Scope(DB), then prefer DA.  Similarly, if Scope(DA) &gt; Scope(DB), then prefer DB.</td>
<td>If Scope(DA) &lt; Scope(DB), then prefer DA.  Similarly, if Scope(DA) &gt; Scope(DB), then prefer DB.</td>
</tr>
<tr>
<td>Rule 9</td>
<td>Rule 9: Use longest matching prefix.</td>
<td>Rule 9: Use longest matching prefix.</td>
</tr>
<tr>
<td>前缀匹配长度优先</td>
<td>When DA and DB belong to the same address family (both are IPv6 or both are IPv4): If CommonPrefixLen(DA, Source(DA)) &gt; CommonPrefixLen(DB, Source(DB)), then prefer DA.  Similarly, if CommonPrefixLen(DA, Source(DA)) &lt; CommonPrefixLen(DB, Source(DB)), then prefer DB.</td>
<td>When DA and DB belong to the same address family (both are IPv6 or both are IPv4): If CommonPrefixLen(Source(DA), DA) &gt; CommonPrefixLen(Source(DB), DB), then prefer DA.  Similarly, if CommonPrefixLen(Source(DA), DA) &lt; CommonPrefixLen(Source(DB), DB), then prefer DB.</td>
</tr>
<tr>
<td>Rule 10</td>
<td>Rule 10: Otherwise, leave the order unchanged.</td>
<td>Rule 10: Otherwise, leave the order unchanged.</td>
</tr>
<tr>
<td>默认规则</td>
<td>If DA preceded DB in the original list, prefer DA.  Otherwise prefer DB.</td>
<td>If DA preceded DB in the original list, prefer DA.  Otherwise, prefer DB.</td>
</tr>
</tbody></table>
<p>其中 label 和 precedence 在 默认策略表中定义，10 条规则基本没变，只是对默认策略表进行了一些更改：</p>
<p>[RFC3484] 默认策略表</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Prefix        Precedence Label<br>::1/128               50     0<br>::/0                  40     1<br>2002::/16             30     2<br>::/96                 20     3<br><span class="hljs-meta">::ffff:0:0/96</span>         10     4<br></code></pre></td></tr></table></figure>

<p>[RFC6724]  默认策略表</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">Prefix        Precedence Label<br>::1/128              <span class="hljs-number"> 50 </span>    0<br>::/0                 <span class="hljs-number"> 40 </span>    1<br>::ffff:0:0/96        <span class="hljs-number"> 35 </span>    4<br>2002::/16            <span class="hljs-number"> 30 </span>   <span class="hljs-number"> 2 </span>6to4 地址<br>2001::/32             <span class="hljs-number"> 5 </span>   <span class="hljs-number"> 5 </span>Teredo 地址<br>fc00::/7              <span class="hljs-number"> 3 </span>   13<br>::/96                 <span class="hljs-number"> 1 </span>    3<br>fec0::/10             <span class="hljs-number"> 1 </span>   11<br>3ffe::/16             <span class="hljs-number"> 1 </span>   12<br></code></pre></td></tr></table></figure>
<ol>
<li>添加 Teredo [RFC4380] 地址前缀 (2001::&#x2F;32)，preference 和 label 值取自已经广泛使用的实现</li>
<li>在原生 IPv6 地址前缀下添加 ULAs (fc00::&#x2F;7) 地址，因为它不是全球可达地址，参见 Section 10.6</li>
<li>取消推荐 site-local addresses (fec0::&#x2F;10) ，因其已经被弃用 [RFC3879]</li>
<li>调整原生 IPv4 地址优先 6to4 (2002::&#x2F;32) 地址</li>
<li>取消推荐 IPv4-Compatible addresses (::&#x2F;96) 地址，因其被废弃且不再使用 [RFC4291]</li>
<li>取消推荐  6bone testing addresses (3ffe::&#x2F;16) 地址，因其已经被淘汰而不再首选 [RFC3701]</li>
<li>Added optional ability for an implementation to add automatic rows to the table for site-specific ULA prefixes and site-specific native 6to4 prefixes</li>
</ol>
<p>根据上述规则对 dns 服务器返回的地址进行初步排序，再依据 ([RFC8305], Section 4) 进行 IPv4 和 IPv6 地址交错排序，形成最终的地址排序列表：如果返回的地址包含多个 IPv6 和 IPv4 地址，([RFC8305], Section 4) 中提到了两种实现：</p>
<ul>
<li>第一种：v6 v6 v6 v4 v4 v4，地址族分段</li>
<li>第二种：v6 v4 v6 v4 v6 v4，地址族交错</li>
</ul>
<p>地址排序之后，进行连接竞速。</p>
<h3 id="2-1-1-自定义默认策略表"><a href="#2-1-1-自定义默认策略表" class="headerlink" title="2.1.1. 自定义默认策略表"></a>2.1.1. 自定义默认策略表</h3><p>策略表可以自己定义，用来控制不同地址的排序，比如 getaddrinfo 会读取 &#x2F;etc&#x2F;gai.conf 中的策略配置，如果没有特殊配置，getaddrinfo 使用默认的配置，默认将 6to4 地址排在原生 IPv4 地址前，我们可以：<br>将 precedence ::ffff:0:0&#x2F;96  10<br>改 precedence ::ffff:0:0&#x2F;96  35，使原生的 IPv4 地址优于 6to4 地址。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># Configuration for getaddrinfo(3).</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># So far only configuration for the destination address sorting is needed.</span><br><span class="hljs-comment"># RFC 3484 governs the sorting.  But the RFC also says that system</span><br><span class="hljs-comment"># administrators should be able to overwrite the defaults.  This can be</span><br><span class="hljs-comment"># achieved here.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># All lines have an initial identifier specifying the option followed by</span><br><span class="hljs-comment"># up to two values.  Information specified in this file replaces the</span><br><span class="hljs-comment"># default information.  Complete absence of data of one kind causes the</span><br><span class="hljs-comment"># appropriate default information to be used.  The supported commands include:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># reload  &lt;yes|no&gt;</span><br><span class="hljs-comment">#    If set to yes, each getaddrinfo(3) call will check whether this file</span><br><span class="hljs-comment">#    changed and if necessary reload.  This option should not really be</span><br><span class="hljs-comment">#    used.  There are possible runtime problems.  The default is no.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># label   &lt;mask&gt;   &lt;value&gt;</span><br><span class="hljs-comment">#    Add another rule to the RFC 3484 label table.  See section 2.1 in</span><br><span class="hljs-comment">#    RFC 3484.  The default is:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">label</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>       <span class="hljs-number">0</span><br><span class="hljs-attribute">label</span> ::/<span class="hljs-number">0</span>          <span class="hljs-number">1</span><br><span class="hljs-attribute">label</span> <span class="hljs-number">2002</span>::/<span class="hljs-number">16</span>     <span class="hljs-number">2</span><br><span class="hljs-attribute">label</span> ::/<span class="hljs-number">96</span>         <span class="hljs-number">3</span><br><span class="hljs-attribute">label</span> ::ffff:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>/<span class="hljs-number">96</span> <span class="hljs-number">4</span><br><span class="hljs-attribute">label</span> fec0::/<span class="hljs-number">10</span>     <span class="hljs-number">5</span><br><span class="hljs-attribute">label</span> fc00::/<span class="hljs-number">7</span>      <span class="hljs-number">6</span><br><span class="hljs-attribute">label</span> <span class="hljs-number">2001</span>:<span class="hljs-number">0</span>::/<span class="hljs-number">32</span>   <span class="hljs-number">7</span><br><span class="hljs-attribute">label</span> ::ffff:<span class="hljs-number">7</span>f00:<span class="hljs-number">0001</span>/<span class="hljs-number">128</span> <span class="hljs-number">8</span><br><br><span class="hljs-comment">#    This default differs from the tables given in RFC 3484 by handling</span><br><span class="hljs-comment">#    (now obsolete) site-local IPv6 addresses and Unique Local Addresses.</span><br><span class="hljs-comment">#    The reason for this difference is that these addresses are never</span><br><span class="hljs-comment">#    NATed while IPv4 site-local addresses most probably are.  Given</span><br><span class="hljs-comment">#    the precedence of IPv6 over IPv4 (see below) on machines having only</span><br><span class="hljs-comment">#    site-local IPv4 and IPv6 addresses a lookup for a global address would</span><br><span class="hljs-comment">#    see the IPv6 be preferred.  The result is a long delay because the</span><br><span class="hljs-comment">#    site-local IPv6 addresses cannot be used while the IPv4 address is</span><br><span class="hljs-comment">#    (at least for the foreseeable future) NATed.  We also treat Teredo</span><br><span class="hljs-comment">#    tunnels special.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># precedence  &lt;mask&gt;   &lt;value&gt;</span><br><span class="hljs-comment">#    Add another rule to the RFC 3484 precedence table.  See section 2.1</span><br><span class="hljs-comment">#    and 10.3 in RFC 3484.  The default is:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">precedence</span>  ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>       <span class="hljs-number">50</span><br><span class="hljs-attribute">precedence</span>  ::/<span class="hljs-number">0</span>          <span class="hljs-number">40</span><br><span class="hljs-attribute">precedence</span>  <span class="hljs-number">2002</span>::/<span class="hljs-number">16</span>     <span class="hljs-number">30</span><br><span class="hljs-attribute">precedence</span> ::/<span class="hljs-number">96</span>          <span class="hljs-number">20</span><br><span class="hljs-attribute">precedence</span> ::ffff:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>/<span class="hljs-number">96</span>  <span class="hljs-number">35</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    For sites which prefer IPv4 connections change the last line to</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#precedence ::ffff:0:0/96  100</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># scopev4  &lt;mask&gt;  &lt;value&gt;</span><br><span class="hljs-comment">#    Add another rule to the RFC 3484 scope table for IPv4 addresses.</span><br><span class="hljs-comment">#    By default the scope IDs described in section 3.2 in RFC 3484 are</span><br><span class="hljs-comment">#    used.  Changing these defaults should hardly ever be necessary.</span><br><span class="hljs-comment">#    The defaults are equivalent to:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">169.254.0.0</span>/<span class="hljs-number">112</span>  <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">127.0.0.0</span>/<span class="hljs-number">104</span>    <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">96</span>       <span class="hljs-number">14</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    For sites which use site-local IPv4 addresses behind NAT there is</span><br><span class="hljs-comment">#    the problem that even if IPv4 addresses are preferred they do not</span><br><span class="hljs-comment">#    have the same scope and are therefore not sorted first.  To change</span><br><span class="hljs-comment">#    this use only these rules:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">169.254.0.0</span>/<span class="hljs-number">112</span>  <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">127.0.0.0</span>/<span class="hljs-number">104</span>    <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">96</span>       <span class="hljs-number">14</span><br></code></pre></td></tr></table></figure>

<h2 id="2-2-连接竞速"><a href="#2-2-连接竞速" class="headerlink" title="2.2. 连接竞速"></a>2.2. 连接竞速</h2><p>● 为避免无意义的网络连接，连接竞速过程不应该并行，而是依次有序的单个启动<br>● 在一定的连接尝试延时（推荐250ms）过后，再使用列表中的后续ip地址开始逐个尝试连接。<br>● 一旦首个 IP 连接握手成功后，即取消其他未完成的连接尝试。另外，DNS 客户端解析器仍应在短时间内（建议为1秒）处理来自网络的DNS回复，因为它们将填充 DNS 缓存，并可用于后续连接。<br>● 连接尝试延迟推荐为250ms，可根据相同域名的历史RTT数据采集来动态调整延时，但区间应限制在100ms-2s</p>
<h1 id="3-客户端实现"><a href="#3-客户端实现" class="headerlink" title="3. 客户端实现"></a>3. 客户端实现</h1><p>依据 Happy Eyeballs 算法，各语言的类库都有各自的实现，并且不会完全遵守 Happy Eyeballs。</p>
<h2 id="3-1-Go-的实现"><a href="#3-1-Go-的实现" class="headerlink" title="3.1. Go 的实现"></a>3.1. Go 的实现</h2><p>Go 实现了自己的主机名到地址的解析函数 goLookupIPCNAMEOrder，依据操作系统版本及相关配置会选择使用 goLookupIPCNAMEOrder  或是 libc 的 getaddrinfo 。默认在 Linux 系统中如果没有特殊配置 &#x2F;etc&#x2F;nsswitch.conf 和 &#x2F;etc&#x2F;resolv.conf 的话，Go 会使用 goLookupIPCNAMEOrder 发起域名解析请求(当 &#x2F;etc&#x2F;resolv.conf 文件中配置了 single-request，Go 会使用 getaddrinfo)。 goLookupIPCNAMEOrder 使用 [RFC6724] 对返回的地址进行排序。</p>
<p>假设 <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 有下列</p>
<ul>
<li><p>2002:a40:4c07:1::faf1 （6to4）</p>
</li>
<li><p>2002:a40:4c07:1::faf2（6to4）</p>
</li>
<li><p>2002:a40:4c07:1::faf3（6to4）</p>
</li>
<li><p>10.64.78.34</p>
</li>
<li><p>10.64.78.35<br>五个解析结果。</p>
</li>
<li><p>当 Go 使用 goLookupIPCNAMEOrder：</p>
</li>
<li><p>如果 Go 使用 getaddrinfo：</p>
</li>
</ul>
<p>go 在调用 goLookupIPCNAMEOrder 或者 getaddrinfo 函数之后拿到排序过的地址解析列表，然后依据这个排序结果，如果在双栈环境下，地址列表第一个地址是 IPv4 地址，那么所有的 IPv4 放到 primaries 队列中，所有的 IPv6 地址放到 fallbacks 队列中（如果地址列表第一个地址是 IPv6 地址，所有的 IPv6 放到 primaries 队列中，所有的 IPv4 地址放到 fallbacks 队列中），接着优先顺序的对 primaries 队列中的地址尝试连接，如果 300ms（可配置）后连接未建立，那么顺序的对 fallbacks 队列中的地址发起连接（如果primaries队列地址连接出错会马上对 fallbacks 队列地址发起连接，不会等 300ms），任何一个连接成功后，其余连接将被关闭。</p>
<h1 id="4-客户端测试"><a href="#4-客户端测试" class="headerlink" title="4. 客户端测试"></a>4. 客户端测试</h1><p><strong>dns 服务器针对特殊域名，返回如下几种结果：</strong></p>
<ol>
<li>返回1个 IPv4 地址</li>
<li>返回1个 IPv6 地址</li>
<li>返回1个 IPv4 地址和1个 IPv6 地址</li>
<li>返回1个 IPv4 地址和1个 broken IPv6 地址</li>
<li>返回1个 broken IPv4 地址和1个 IPv6 地址</li>
<li>返回1个 IPv4 地址和2个 IPv6 地址，其中一个 IPv6 地址 broken</li>
<li>返回2个 IPv4 地址和1个 IPv6 地址，其中一个 IPv4 地址 broken</li>
</ol>
<div class="note note-warning">
            <p>上面的 IPv6 地址指的是 6to4 地址，broken 指的是网络包丢失的场景，这里我们使用 iptables DROP 掉特殊的地址来模拟 broken。</p>
          </div>

<p><strong>测试环境：</strong></p>
<ul>
<li>内核版本：Linux 4.1.0-15.el6.ucloud.x86_64</li>
<li>操作系统：CentOS release 6.3 (Final)</li>
<li>glibc 版本：2.12</li>
<li>curl 版本：curl 7.72.0 (x86_64-redhat-linux-gnu)</li>
<li>go 版本：go1.15 linux&#x2F;amd64</li>
<li>python 版本：Python 2.6.6</li>
<li>nodejs 版本：v0.10.36</li>
<li>java 版本：”11.0.8” 2020-07-14 LTS</li>
<li>nginx 版本：nginx&#x2F;1.14.2</li>
</ul>
<p><strong>使用 coredns file 插件进行测试，针对上面七种场景，配置7个文件：</strong></p>
<ul>
<li>返回1个 IPv4 地址</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">$<span class="hljs-keyword">ORIGIN </span>example.<span class="hljs-keyword">org.</span><br><span class="hljs-keyword"></span>@	<span class="hljs-number">3600</span> IN	SOA sns.dns.icann.<span class="hljs-keyword">org. </span>noc.dns.icann.<span class="hljs-keyword">org. </span>(<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> IN NS a.iana-servers.net.<br>	<span class="hljs-number">3600</span> IN NS <span class="hljs-keyword">b.iana-servers.net.</span><br><span class="hljs-keyword"></span><br>WWW     IN A     <span class="hljs-number">10</span>.<span class="hljs-number">64</span>.<span class="hljs-number">78</span>.<span class="hljs-number">34</span><br></code></pre></td></tr></table></figure>
<ul>
<li>返回1个 IPv6 地址</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">$<span class="hljs-keyword">ORIGIN </span>example.<span class="hljs-keyword">org.</span><br><span class="hljs-keyword"></span>@	<span class="hljs-number">3600</span> IN	SOA sns.dns.icann.<span class="hljs-keyword">org. </span>noc.dns.icann.<span class="hljs-keyword">org. </span>(<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> IN NS a.iana-servers.net.<br>	<span class="hljs-number">3600</span> IN NS <span class="hljs-keyword">b.iana-servers.net.</span><br><span class="hljs-keyword"></span><br>WWW     IN AAAA  <span class="hljs-number">2002</span>:a40:<span class="hljs-number">4</span>c07:<span class="hljs-number">1</span>::faf1<br></code></pre></td></tr></table></figure>

<ul>
<li>返回1个 IPv4 地址和1个 IPv6 地址</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span>	<span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure>

<ul>
<li>返回1个 IPv4 地址和1个 broken IPv6 地址</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span>	<span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf2</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure>

<ul>
<li>返回1个 broken IPv4 地址和1个 IPv6 地址</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns">@	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span>	<span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.35</span><br></code></pre></td></tr></table></figure>

<ul>
<li>返回1个 IPv4 地址和2个 IPv6 地址，其中一个 IPv6 地址 broken</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span>	<span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::aaa1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure>

<ul>
<li>返回2个 IPv4 地址和1个 IPv6 地址，其中一个 IPv4 地址 broken</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span>	<span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br>				<span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br>				<span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br>				<span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br>				<span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>				)<br><br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br>	<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.33</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure>

<h2 id="4-1-IPv4-only"><a href="#4-1-IPv4-only" class="headerlink" title="4.1. IPv4 only"></a>4.1. IPv4 only</h2><p>执行命令禁用 IPv6:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sysctl net.ipv6.conf.all.disable_ipv6=1<br>sysctl net.ipv6.conf.default.disable_ipv6=1<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>go</th>
<th>curl</th>
<th>python</th>
<th>node.js</th>
<th>java</th>
<th>nginx</th>
</tr>
</thead>
<tbody><tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务 返回 NOERROR，客户端无法完成连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务 返回 NOERROR，nginx 无法启动</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 broken IPv4 地址，客户端无法完成连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 broken IPv4 地址，客户端无法完成连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待client 超时后（设置为5s）连接未建立，对正常的 IPv4 地址发起连接，连接成功</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待client 超时后（设置为5s）连接未建立，对正常的 IPv4 地址发起连接，连接成功</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，根据传递给 urllib2.urlopen 的 timeout 时间(设置为1s)，1s后对正常的 IPv4 地址发起连接，连接成功</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td>
<td>客户端只发起 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td>
<td>客户端只发起 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待 proxy_connect_timeout（默认1m） 时间后连接未建立，再使用正常 IPv4 地址发起连接，连接成功，后续连接如此循环</td>
</tr>
</tbody></table>
<h2 id="4-2-Dual-stack"><a href="#4-2-Dual-stack" class="headerlink" title="4.2. Dual-stack"></a>4.2. Dual-stack</h2><table>
<thead>
<tr>
<th>go</th>
<th>curl</th>
<th>python</th>
<th>node.js</th>
<th>java</th>
<th>nginx</th>
</tr>
</thead>
<tbody><tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端随机使用IPv4 和 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端随机使用 IPv4 和 IPv6 地址建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果使用 broken 的 IPv6 地址发起连接，200ms 后连接未建立，客户端使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv6 地址建立连接，根据传递给 urllib2.urlopen 的 timeout 时间(设置为1s)，1s IPv6 连接未建立，客户端再使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端随机使用 IPv4 和 IPv6 地址，如果使用了 broken 的 IPv6 地址，等待 proxy_connect_timeout（默认1m） 时间后连接未建立再使用 IPv4 建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端首先使用 IPv4 地址建立连接，300ms IPv4 连接未建立，客户端再使用 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果使用 broken 的 IPv4 地址发起连接，200ms 后连接未建立，客户端使用 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端首先使用 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，连接失败</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，连接失败</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端随机使用 IPv4 和 IPv6 地址，如果使用了 broken 的 IPv4 地址，等待 proxy_connect_timeout（默认1m） 时间后连接未建立再使用 IPv6 建立连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv6 地址在排在正常的 IPv6 地址前，客户端首先使用 broken 地址发起连接，200ms 后连接未建立，客户端直接使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv6 地址发起连接，如果 broken 的 IPv6 地址在排在正常的 IPv6 地址前，客户端首先使用 broken 地址发起连接，根据传递给 urllib2.urlopen 的 timeout 时间(设置为1s)，1s IPv6 连接未建立，对正常的 IPv6 地址发起连接，连接成功</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv4 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv6 地址在排在正常的 IPv6 地址前，客户端首先使用 broken 地址发起连接，等待proxy_connect_timeout（默认1m） 连接未建立，再使用正常 IPv6 地址发起连接</td>
</tr>
<tr>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待 300ms 连接未建立，对正常的 IPv4 地址发起连接，连接成功</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，200ms 后连接未建立，客户端直接使用 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv6 地址建立连接</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td>
<td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待proxy_connect_timeout（默认1m） 连接未建立，再使用正常 IPv4 地址发起连接</td>
</tr>
</tbody></table>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h1><p><strong>集群中主要存在以下集中域名解析请求：</strong></p>
<ol>
<li>Kubernetes IPv6 service 域名</li>
<li>Kubernetes IPv4 service 域名</li>
<li>特殊域名</li>
<li>管理网服务域名</li>
<li>科学上网域名</li>
<li>外网域名</li>
</ol>
<ul>
<li>对于第 1、2 两类域名，coredns Kubernetes  插件可以根据 service 的类别只返回对应的 IPv6 或者 IPv4 地址；</li>
<li>对于第 3 类域名我们可以特殊配置 hosts，返回 IPv6 或 IPv4 地址；</li>
<li>对于第 4 类域名，管理网服务可能不支持 IPv6，dns 服务器也不能直接探测管理网服务是否支持 IPv6，所以dns服务器返回 IPv4 地址和 6to4 地址，由客户端使用 Happy Eyeballs 算法进行连接竞速选择可用的服务地址，如果 IPv6 是不可达、不存在的地址或者没有listen对应的端口，那么连接竞速会快速完成，不会等待连接尝试延迟时间(go默认 300ms)；如果 IPv6 包被丢了，客户端可能会等待尝试延迟时间后再对另一个地址族发起连接，某些客户端比如 nginx 需要设置 proxy_connect_timeout，python urllib2.urlopen 需要设置timeout 时间，不然建立连接很慢；</li>
<li>对于第 5、6 类地址由于集群现在只支持通过 IPv6 访问公网，所以直接返回 IPv6 地址；</li>
</ul>
<h1 id="6-附录"><a href="#6-附录" class="headerlink" title="6. 附录"></a>6. 附录</h1><h2 id="6-1-客户端测试代码"><a href="#6-1-客户端测试代码" class="headerlink" title="6.1. 客户端测试代码"></a>6.1. 客户端测试代码</h2><h3 id="6-1-1-go"><a href="#6-1-1-go" class="headerlink" title="6.1.1. go"></a>6.1.1. go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bufio&quot;</span><br>	<span class="hljs-string">&quot;bytes&quot;</span><br>	<span class="hljs-string">&quot;crypto/tls&quot;</span><br>	<span class="hljs-string">&quot;flag&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>	defaultHttpClientTimeout = <span class="hljs-number">5</span> * time.Second<br>)<br><br><span class="hljs-keyword">var</span> (<br>	httpReqTimeoutFlag = flag.Duration(<span class="hljs-string">&quot;timeout&quot;</span>, defaultHttpClientTimeout, <span class="hljs-string">&quot;Connection and read timeout value (for http)&quot;</span>)<br>	numConnFlag        = flag.Int(<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;Number of connections per host&quot;</span>)<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) &lt; <span class="hljs-number">2</span> &#123;<br>		usageErr(<span class="hljs-string">&quot;Error: need at least 1 command parameter&quot;</span>)<br>	&#125;<br><br>	flag.Parse()<br><br>	<span class="hljs-keyword">var</span> client runner<br><br>	fmt.Println(<span class="hljs-string">&quot;Use Http for dr testing&quot;</span>)<br>	client = newHttpClient()<br><br>	<span class="hljs-keyword">if</span> res, err := client.do(<span class="hljs-string">&quot;first&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;Error: query failed, %v\n&quot;</span>, err)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;Info: receive response, %s\n&quot;</span>, res)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// Prints usage and error messages with StdErr writer.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">usageErr</span><span class="hljs-params">(msgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>	fmt.Println(msgs...)<br>	os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> runner <span class="hljs-keyword">interface</span> &#123;<br>	do(<span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> httpClient <span class="hljs-keyword">struct</span> &#123;<br>	url    <span class="hljs-type">string</span><br>	client *http.Client<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newHttpClient</span><span class="hljs-params">()</span></span> runner &#123;<br>	url := strings.TrimLeft(flag.Arg(<span class="hljs-number">0</span>), <span class="hljs-string">&quot; \t\r\n&quot;</span>)<br><br>	timeout := httpReqTimeoutFlag<br>	transport := http.Transport&#123;<br>		TLSClientConfig: &amp;tls.Config&#123;<br>			InsecureSkipVerify: <span class="hljs-literal">true</span>,<br>		&#125;,<br>		<span class="hljs-comment">//DisableKeepAlives:   false,</span><br>		MaxConnsPerHost:     *numConnFlag,<br>		MaxIdleConns:        *numConnFlag,<br>		MaxIdleConnsPerHost: *numConnFlag,<br>	&#125;<br><br>	client := &amp;http.Client&#123;<br>		Transport: &amp;transport,<br>		Timeout:   *timeout,<br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;httpClient&#123;<br>		url:    url,<br>		client: client,<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *httpClient)</span></span> do(payload <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	req, err := http.NewRequest(<span class="hljs-string">&quot;GET&quot;</span>, c.url, bytes.NewBufferString(time.Now().String()+<span class="hljs-string">&quot;--&quot;</span>+payload))<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	resp, err := c.client.Do(req)<br>	<span class="hljs-keyword">if</span> resp != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">defer</span> resp.Body.Close()<br>	&#125;<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> resp.StatusCode != http.StatusOK &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<br>			<span class="hljs-string">&quot;error get health information about Grafana, expected status 200 but got %v&quot;</span>,<br>			resp.StatusCode)<br>	&#125;<br><br>	data, err := ioutil.ReadAll(resp.Body)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(data), <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-1-2-getaddrinfo"><a href="#6-1-2-getaddrinfo" class="headerlink" title="6.1.2. getaddrinfo"></a>6.1.2. getaddrinfo</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">printAddr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr * res)</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hints</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> * <span class="hljs-title">result</span>, * <span class="hljs-title">rp</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage: %s host port...\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <br>    <span class="hljs-built_in">memset</span>( &amp; hints, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> addrinfo));<br>    hints.ai_family = AF_UNSPEC; <span class="hljs-comment">/* Allow IPv4 or IPv6 */</span><br>    hints.ai_socktype = SOCK_STREAM; <span class="hljs-comment">/* Stream socket */</span><br>    hints.ai_flags = (AI_CANONNAME | AI_V4MAPPED | AI_ALL);<br>    <span class="hljs-comment">//hints.ai_flags = 0;</span><br>    <span class="hljs-comment">//hints.ai_protocol = 0;          /* Any protocol */</span><br><br>    s = getaddrinfo(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], &amp; hints, &amp; result);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getaddrinfo: %s\n&quot;</span>, gai_strerror(s));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* getaddrinfo() returns a list of address structures.*/</span><br><br>    <span class="hljs-keyword">for</span> (rp = result; rp != <span class="hljs-literal">NULL</span>; rp = rp -&gt; ai_next) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Received ai_family:%d ai_socktype:%d ai_protocol:%d ai_addrlen:%d\n&quot;</span>,<br>            rp -&gt; ai_family, rp -&gt; ai_socktype, rp -&gt; ai_protocol, rp -&gt; ai_addrlen);<br>        printAddr(rp -&gt; ai_addr);<br>    &#125;<br><br>    freeaddrinfo(result); <span class="hljs-comment">/* No longer needed */</span><br><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">printAddr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr * res)</span> &#123;<br>    <span class="hljs-type">char</span> * s = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">switch</span> (res -&gt; sa_family) &#123;<br>    <span class="hljs-keyword">case</span> AF_INET: &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> * <span class="hljs-title">addr_in</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr_in * ) res;<br>        s = <span class="hljs-built_in">malloc</span>(INET_ADDRSTRLEN);<br>        inet_ntop(AF_INET, &amp; (addr_in -&gt; sin_addr), s, INET_ADDRSTRLEN);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> AF_INET6: &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in6</span> * <span class="hljs-title">addr_in6</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr_in6 * ) res;<br>        s = <span class="hljs-built_in">malloc</span>(INET6_ADDRSTRLEN);<br>        inet_ntop(AF_INET6, &amp; (addr_in6 -&gt; sin6_addr), s, INET6_ADDRSTRLEN);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IP address: %s\n&quot;</span>, s);<br>    <span class="hljs-built_in">free</span>(s);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-1-3-python"><a href="#6-1-3-python" class="headerlink" title="6.1.3. python"></a>6.1.3. python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><br><span class="hljs-keyword">import</span> urllib<br><span class="hljs-keyword">import</span> urllib2<br><br>url = <span class="hljs-string">&#x27;http://www.example.org:8080&#x27;</span><br>values = &#123;<span class="hljs-string">&#x27;name&#x27;</span> : <span class="hljs-string">&#x27;Michael&#x27;</span>&#125;<br>data = urllib.urlencode(values)<br>req = urllib2.Request(url, data)<br>response = urllib2.urlopen(req,timeout=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span> response.read()<br><span class="hljs-number">6.1</span><span class="hljs-number">.4</span>. node.js<br>var http = require(<span class="hljs-string">&#x27;http&#x27;</span>);<br><br>var options = &#123;<br>  host: <span class="hljs-string">&#x27;www.example.org&#x27;</span>,<br>  path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>  port: <span class="hljs-string">&#x27;8080&#x27;</span>,<br>  method: <span class="hljs-string">&#x27;POST&#x27;</span><br>&#125;;<br><br>callback = function(response) &#123;<br>  var <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span><br>  response.on(<span class="hljs-string">&#x27;data&#x27;</span>, function (chunk) &#123;<br>    <span class="hljs-built_in">str</span> += chunk;<br>  &#125;);<br><br>  response.on(<span class="hljs-string">&#x27;end&#x27;</span>, function () &#123;<br>    console.log(<span class="hljs-built_in">str</span>);<br>  &#125;);<br>&#125;<br><br>var req = http.request(options, callback);<br>req.write(<span class="hljs-string">&quot;hello world!&quot;</span>);<br>req.end();<br><span class="hljs-number">6.1</span><span class="hljs-number">.5</span>. java<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.URI;<br><span class="hljs-keyword">import</span> java.net.http.HttpClient;<br><span class="hljs-keyword">import</span> java.net.http.HttpRequest;<br><span class="hljs-keyword">import</span> java.net.http.HttpResponse;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetRequestJava11</span> &#123;<br><br>    public static void main(String[] args) throws IOException, InterruptedException &#123;<br><br>        HttpClient client = HttpClient.newHttpClient();<br>        HttpRequest request = HttpRequest.newBuilder()<br>                .uri(URI.create(<span class="hljs-string">&quot;http://www.example.org:8080/&quot;</span>))<br>                .build();<br><br>        HttpResponse&lt;String&gt; response = client.send(request,<br>                HttpResponse.BodyHandlers.ofString());<br><br>        System.out.println(response.body());<br>    &#125;<br>&#125;<br><span class="hljs-number">6.1</span><span class="hljs-number">.6</span>. nginx<br>server &#123;<br>    listen       [::]:<span class="hljs-number">9901</span>;<br>    listen       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">9901</span>;<br>    server_name  localhost;<br><br>    location / &#123;<br>        proxy_pass   http://www.example.org:<span class="hljs-number">8080</span>;<br>    &#125;<br>&#125;<br><br>upstream myserver &#123;<br>    server  www.example.org:<span class="hljs-number">8080</span>;<br>&#125;<br><br>server &#123;<br>    listen       [::]:<span class="hljs-number">9902</span>;<br>    listen       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">9902</span>;<br>    server_name  localhost;<br><br>    location / &#123;<br>        proxy_pass   http://myserver;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>原文链接： <a target="_blank" rel="noopener" href="https://www.yuque.com/dogbrother-5valv/tzhl7q/rpuusg#tImdq">https://www.yuque.com/dogbrother-5valv/tzhl7q/rpuusg#tImdq</a></p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc3484">https://tools.ietf.org/html/rfc3484</a><br><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6724">https://tools.ietf.org/html/rfc6724</a><br><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6555">https://tools.ietf.org/html/rfc6555</a><br><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8305">https://tools.ietf.org/html/rfc8305</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/dns/" class="print-no-link">#dns</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>实现 DNS 双栈的一些细节</div>
      <div>http://blog.oldwang.fun/2023/09/05/技术/实现-DNS-双栈的一些细节/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>oldwang12</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年9月5日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2023年9月5日</div>
        </div>
      
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>








  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
