<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="http://blog.caiplus.pro/atom.xml" rel="self"/>
  
  <link href="http://blog.caiplus.pro/"/>
  <updated>2023-08-08T08:29:17.603Z</updated>
  <id>http://blog.caiplus.pro/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>重命名文件</title>
    <link href="http://blog.caiplus.pro/2023/08/08/linux/%E9%87%8D%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6/"/>
    <id>http://blog.caiplus.pro/2023/08/08/linux/%E9%87%8D%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6/</id>
    <published>2023-08-08T08:29:04.000Z</published>
    <updated>2023-08-08T08:29:17.603Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span>=<span class="variable">$1</span>  <span class="comment"># 指定目录路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入目录</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> || <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换文件名中的abcd1至abcd9为abcd01至abcd09</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *S01E[1-9].*; <span class="keyword">do</span></span><br><span class="line">  new_file=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span> | sed <span class="string">&#x27;s/S01E\([1-9]\)/S01E0\1/&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$new_file</span></span><br><span class="line">  <span class="built_in">mv</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;<span class="variable">$new_file</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;l</summary>
      
    
    
    
    
    <category term="linux" scheme="http://blog.caiplus.pro/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>快速开启http服务</title>
    <link href="http://blog.caiplus.pro/2023/08/07/linux/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%90%AFhttp%E6%9C%8D%E5%8A%A1/"/>
    <id>http://blog.caiplus.pro/2023/08/07/linux/%E5%BF%AB%E9%80%9F%E5%BC%80%E5%90%AFhttp%E6%9C%8D%E5%8A%A1/</id>
    <published>2023-08-07T09:22:35.000Z</published>
    <updated>2023-08-07T09:23:38.137Z</updated>
    
    <content type="html"><![CDATA[<h4 id="快速开启http服务"><a href="#快速开启http服务" class="headerlink" title="快速开启http服务"></a>快速开启http服务</h4><p>这将监听本地 80 端口，响应 OK</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\nOK&#x27;</span> | sudo socat - TCP-LISTEN:80</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;快速开启http服务&quot;&gt;&lt;a href=&quot;#快速开启http服务&quot; class=&quot;headerlink&quot; title=&quot;快速开启http服务&quot;&gt;&lt;/a&gt;快速开启http服务&lt;/h4&gt;&lt;p&gt;这将监听本地 80 端口，响应 OK&lt;/p&gt;
&lt;figure class=&quot;</summary>
      
    
    
    
    
    <category term="linux" scheme="http://blog.caiplus.pro/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>进入pod网络命名空间</title>
    <link href="http://blog.caiplus.pro/2023/08/03/k8s/%E8%BF%9B%E5%85%A5pod%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4/"/>
    <id>http://blog.caiplus.pro/2023/08/03/k8s/%E8%BF%9B%E5%85%A5pod%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4/</id>
    <published>2023-08-03T08:35:39.000Z</published>
    <updated>2023-08-03T09:01:02.876Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-找到-pod-所在节点"><a href="#1-找到-pod-所在节点" class="headerlink" title="1. 找到 pod 所在节点"></a>1. 找到 pod 所在节点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k get po -owide</span><br><span class="line"></span><br><span class="line">ssh root@xx.xx.xx.xx</span><br></pre></td></tr></table></figure><h4 id="2-获取容器-pid"><a href="#2-获取容器-pid" class="headerlink" title="2. 获取容器 pid"></a>2. 获取容器 pid</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker</span></span><br><span class="line">docker inspect --format <span class="string">&#x27;&#123;&#123; .State.Pid &#125;&#125;&#x27;</span> 容器名/ID</span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd</span></span><br><span class="line">crictl inspect 容器ID | grep pid</span><br></pre></td></tr></table></figure><h4 id="3-进入容器网络"><a href="#3-进入容器网络" class="headerlink" title="3. 进入容器网络"></a>3. 进入容器网络</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nsenter -t <span class="variable">$PID</span> -n</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;1-找到-pod-所在节点&quot;&gt;&lt;a href=&quot;#1-找到-pod-所在节点&quot; class=&quot;headerlink&quot; title=&quot;1. 找到 pod 所在节点&quot;&gt;&lt;/a&gt;1. 找到 pod 所在节点&lt;/h4&gt;&lt;figure class=&quot;highlight sh</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://blog.caiplus.pro/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>解压、压缩</title>
    <link href="http://blog.caiplus.pro/2023/08/03/linux/%E8%A7%A3%E5%8E%8B%E3%80%81%E5%8E%8B%E7%BC%A9/"/>
    <id>http://blog.caiplus.pro/2023/08/03/linux/%E8%A7%A3%E5%8E%8B%E3%80%81%E5%8E%8B%E7%BC%A9/</id>
    <published>2023-08-03T07:43:09.000Z</published>
    <updated>2023-08-10T06:29:45.804Z</updated>
    
    <content type="html"><![CDATA[<h2 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 压缩</span></span><br><span class="line">tar -czvf test.tar.gz README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -xzvf test.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压到指定文件夹</span></span><br><span class="line">tar -xzvf test.tar.gz -C /home/test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出压缩文件内容</span></span><br><span class="line">tar -tzvf test.tar.gz </span><br></pre></td></tr></table></figure><h4 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h4><ul><li>-v 显示指令执行过程。</li><li>-c 建立新的备份文件。</li><li>-f 指定备份文件。</li><li>-z 通过gzip指令处理备份文件。</li><li>-x 从备份文件中还原文件。</li></ul><h4 id="加密压缩"><a href="#加密压缩" class="headerlink" title="加密压缩"></a>加密压缩</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将当前目录下的files文件夹打包压缩，密码为password</span></span><br><span class="line">tar -czvf - files | openssl des3 -salt -k password -out files.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前目录下的files.tar.gz进行解密解压</span></span><br><span class="line">openssl des3 -d -k password -salt -<span class="keyword">in</span> files.tar.gz | tar xzvf -</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;tar&quot;&gt;&lt;a href=&quot;#tar&quot; class=&quot;headerlink&quot; title=&quot;tar&quot;&gt;&lt;/a&gt;tar&lt;/h2&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span</summary>
      
    
    
    
    
    <category term="linux" scheme="http://blog.caiplus.pro/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>buildx构建多版本镜像</title>
    <link href="http://blog.caiplus.pro/2023/08/03/docker/buildx%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%89%88%E6%9C%AC%E9%95%9C%E5%83%8F/"/>
    <id>http://blog.caiplus.pro/2023/08/03/docker/buildx%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%89%88%E6%9C%AC%E9%95%9C%E5%83%8F/</id>
    <published>2023-08-03T07:23:18.000Z</published>
    <updated>2023-08-03T07:37:35.288Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p><a href="http://blog.naturelr.cc/2023/06/16/%E4%BD%BF%E7%94%A8buildx%E7%BC%96%E8%AF%91%E5%A4%9A%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F/">参考资料</a></p><p>目前大部分使用docker的场景中不单单只是 amd64 平台了有时我们需要再 arm 和 adm64 上都能运行</p><p>新版本的docker默认自带</p><h4 id="创建buildx"><a href="#创建buildx" class="headerlink" title="创建buildx"></a>创建buildx</h4><ul><li>查看当前buildx实例</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker buildx <span class="built_in">ls</span></span><br><span class="line">NAME/NODE DRIVER/ENDPOINT STATUS  BUILDKIT PLATFORMS</span><br><span class="line">default * docker</span><br><span class="line">  default default         running 23.0.5   linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/386</span><br></pre></td></tr></table></figure><blockquote><p>默认会有个实例叫default，default实例下有一个default的node，一个实例下可以有多个node,星号是默认使用的实例,node有很多种类型</p></blockquote><ul><li>创建buildx</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker buildx create --name all --node local --driver docker-container --platform linux/amd64,linux/arm64,linux/arm/v8 --use</span><br></pre></td></tr></table></figure><ul><li>使用这个实例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker buildx use all</span><br></pre></td></tr></table></figure><ul><li>当我们执行编译的时候会先下载buildx镜像并运行起来，然后使用这个容器运行的buildx来编译镜像</li></ul><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><ul><li>–platform执行要编译的平台，其他的参数和普通的build差不多</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接上传到仓库</span></span><br><span class="line">docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t bearking0425/m3u8-downloader -o type=registry .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出本地</span></span><br><span class="line">docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t bearking0425/m3u8-downloader -o type=local,dest=./output .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tar包</span></span><br><span class="line">docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t bearking0425/m3u8-downloader --output type=tar,dest=./output.tar .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接导入到本地 docker 中，只支持单平台架构</span></span><br><span class="line">docker buildx build --platform linux/arm64 -t bearking0425/m3u8-downloader --load . </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;p&gt;&lt;a href=&quot;http://blog.naturelr.cc/2023/06/16/%E4%BD%BF%E7%94%A8buildx%E7%BC%96%E8%AF%91%E5%A4%9A%E5%B9%B3%E5%8F%B</summary>
      
    
    
    
    
    <category term="docker" scheme="http://blog.caiplus.pro/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>cronjob 定时任务</title>
    <link href="http://blog.caiplus.pro/2023/08/01/linux/cronjob%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    <id>http://blog.caiplus.pro/2023/08/01/linux/cronjob%20%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</id>
    <published>2023-08-01T07:49:05.000Z</published>
    <updated>2023-08-03T07:43:02.604Z</updated>
    
    <content type="html"><![CDATA[<h4 id="cronjob-定时任务"><a href="#cronjob-定时任务" class="headerlink" title="cronjob 定时任务"></a>cronjob 定时任务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crontab -e 命令以编辑当前用户的cron表。</span></span><br><span class="line">crontab -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每分钟执行一次 ls</span></span><br><span class="line">*/1 * * * * <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;cronjob-定时任务&quot;&gt;&lt;a href=&quot;#cronjob-定时任务&quot; class=&quot;headerlink&quot; title=&quot;cronjob 定时任务&quot;&gt;&lt;/a&gt;cronjob 定时任务&lt;/h4&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;tab</summary>
      
    
    
    
    
    <category term="linux" scheme="http://blog.caiplus.pro/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>grpc如何使用</title>
    <link href="http://blog.caiplus.pro/2023/07/31/golang/grpc%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://blog.caiplus.pro/2023/07/31/golang/grpc%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/</id>
    <published>2023-07-31T09:04:16.000Z</published>
    <updated>2023-08-01T07:59:35.124Z</updated>
    
    <content type="html"><![CDATA[<h4 id="安装grpc"><a href="#安装grpc" class="headerlink" title="安装grpc"></a>安装grpc</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get google.golang.org/grpc@latest</span><br></pre></td></tr></table></figure><h4 id="安装Protocol-Buffers-v3"><a href="#安装Protocol-Buffers-v3" class="headerlink" title="安装Protocol Buffers v3"></a>安装Protocol Buffers v3</h4><p>protoc <a href="https://github.com/google/protobuf/releases">下载</a></p><h4 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</span><br><span class="line">go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2</span><br></pre></td></tr></table></figure><h1 id="入门示例"><a href="#入门示例" class="headerlink" title="入门示例"></a>入门示例</h1><p><a href="https://github.com/oldwang12/grpc-demo">代码实现</a></p><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><h4 id="编写proto代码"><a href="#编写proto代码" class="headerlink" title="编写proto代码"></a>编写proto代码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; pb/hello.proto</span></span><br><span class="line"><span class="string">syntax = &quot;proto3&quot;; // 版本声明，使用Protocol Buffers v3版本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">option go_package = &quot;server/pb&quot;;  // 指定生成的Go代码在你项目中的导入路径</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">package pb; // 包名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 定义服务</span></span><br><span class="line"><span class="string">service Greeter &#123;</span></span><br><span class="line"><span class="string">    // SayHello 方法</span></span><br><span class="line"><span class="string">    rpc SayHello (HelloRequest) returns (HelloResponse) &#123;&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 请求消息</span></span><br><span class="line"><span class="string">message HelloRequest &#123;</span></span><br><span class="line"><span class="string">    string name = 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 响应消息</span></span><br><span class="line"><span class="string">message HelloResponse &#123;</span></span><br><span class="line"><span class="string">    string reply = 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul><li>执行命令：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative pb/hello.proto</span><br></pre></td></tr></table></figure></li></ul><h4 id="编写Server端Go代码"><a href="#编写Server端Go代码" class="headerlink" title="编写Server端Go代码"></a>编写Server端Go代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;hello_server/pb&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello server</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span> &#123;</span><br><span class="line">pb.UnimplementedGreeterServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloResponse, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;pb.HelloResponse&#123;Reply: <span class="string">&quot;Hello &quot;</span> + in.Name&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 监听本地的8972端口</span></span><br><span class="line">lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:8972&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">s := grpc.NewServer()                  <span class="comment">// 创建gRPC服务器</span></span><br><span class="line">pb.RegisterGreeterServer(s, &amp;server&#123;&#125;) <span class="comment">// 在gRPC服务端注册服务</span></span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line">err = s.Serve(lis)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;failed to serve: %v&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── main.go</span><br><span class="line">└── pb</span><br><span class="line">    ├── hello.pb.go</span><br><span class="line">    ├── hello.proto</span><br><span class="line">    └── hello_grpc.pb.go</span><br></pre></td></tr></table></figure><h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><h4 id="编写proto代码-1"><a href="#编写proto代码-1" class="headerlink" title="编写proto代码"></a>编写proto代码</h4><p>新建 client 项目</p><p>将 go_package 改为 “client&#x2F;db”</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; pb/hello.proto</span></span><br><span class="line"><span class="string">syntax = &quot;proto3&quot;; // 版本声明，使用Protocol Buffers v3版本</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">option go_package = &quot;client/pb&quot;;  // 指定生成的Go代码在你项目中的导入路径</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">package pb; // 包名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 定义服务</span></span><br><span class="line"><span class="string">service Greeter &#123;</span></span><br><span class="line"><span class="string">    // SayHello 方法</span></span><br><span class="line"><span class="string">    rpc SayHello (HelloRequest) returns (HelloResponse) &#123;&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 请求消息</span></span><br><span class="line"><span class="string">message HelloRequest &#123;</span></span><br><span class="line"><span class="string">    string name = 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 响应消息</span></span><br><span class="line"><span class="string">message HelloResponse &#123;</span></span><br><span class="line"><span class="string">    string reply = 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul><li>执行命令<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative pb/hello.proto</span><br></pre></td></tr></table></figure></li></ul><h4 id="client-端代码"><a href="#client-端代码" class="headerlink" title="client 端代码"></a>client 端代码</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;hello_client/pb&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"><span class="string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello_client</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">defaultName = <span class="string">&quot;world&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">addr = flag.String(<span class="string">&quot;addr&quot;</span>, <span class="string">&quot;127.0.0.1:8972&quot;</span>, <span class="string">&quot;the address to connect to&quot;</span>)</span><br><span class="line">name = flag.String(<span class="string">&quot;name&quot;</span>, defaultName, <span class="string">&quot;Name to greet&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line"><span class="comment">// 连接到server端，此处禁用安全传输</span></span><br><span class="line">conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials()))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;did not connect: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line">c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行RPC调用并打印收到的响应数据</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line">r, err := c.SayHello(ctx, &amp;pb.HelloRequest&#123;Name: *name&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;could not greet: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">&quot;Greeting: %s&quot;</span>, r.GetReply())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代码结构-1"><a href="#代码结构-1" class="headerlink" title="代码结构"></a>代码结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http_client</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── main.go</span><br><span class="line">└── pb</span><br><span class="line">    ├── hello.pb.go</span><br><span class="line">    ├── hello.proto</span><br><span class="line">    └── hello_grpc.pb.go</span><br></pre></td></tr></table></figure><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go -name=李四</span><br><span class="line">Greeting: Hello 李四</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;安装grpc&quot;&gt;&lt;a href=&quot;#安装grpc&quot; class=&quot;headerlink&quot; title=&quot;安装grpc&quot;&gt;&lt;/a&gt;安装grpc&lt;/h4&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter</summary>
      
    
    
    
    
    <category term="golang" scheme="http://blog.caiplus.pro/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>golang细节</title>
    <link href="http://blog.caiplus.pro/2023/07/29/golang/golang%E7%BB%86%E8%8A%82/"/>
    <id>http://blog.caiplus.pro/2023/07/29/golang/golang%E7%BB%86%E8%8A%82/</id>
    <published>2023-07-29T05:20:35.000Z</published>
    <updated>2023-07-29T05:59:21.089Z</updated>
    
    <content type="html"><![CDATA[<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><p><a href="#1">1. 结构体打印时，%v 和 %+v 的区别</a><br><a href="#2">2. new和make的区别</a><br><a href="#3">3. slice扩容机制？</a></p><p id="1"></p> <h4 id="结构体打印时，-v-和-v-的区别"><a href="#结构体打印时，-v-和-v-的区别" class="headerlink" title="结构体打印时，%v 和 %+v 的区别"></a>结构体打印时，%v 和 %+v 的区别</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printStruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">people := People&#123;</span><br><span class="line">Name: <span class="string">&quot;lisi&quot;</span>,</span><br><span class="line">Age:  <span class="number">18</span>,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, people)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, people)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%#v\n&quot;</span>, people)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// &#123;lisi 18&#125;</span></span><br><span class="line"><span class="comment">// &#123;Name:lisi Age:18&#125;</span></span><br><span class="line"><span class="comment">// People&#123;Name:&quot;lisi&quot;, Age:18&#125;</span></span><br></pre></td></tr></table></figure><p id="2"></p> <h4 id="new-和-make的区别"><a href="#new-和-make的区别" class="headerlink" title="new 和 make的区别"></a>new 和 make的区别</h4><ul><li>new只用于分配内存，返回一个指向地址的指针。它为每个新类型分配一片内存，初始化为0且返回类型*T的内存地址，它相当于&amp;T{}</li><li>make只可用于slice,map,channel的初始化,返回的是引用。</li></ul><p id="3"></p><h4 id="slice扩容机制？"><a href="#slice扩容机制？" class="headerlink" title="slice扩容机制？"></a>slice扩容机制？</h4><p>Go &lt;&#x3D; 1.17</p><p>如果当前容量小于1024，则判断所需容量是否大于原来容量2倍，如果大于，当前容量加上所需容量；否则当前容量乘2。</p><p>如果当前容量大于1024，则每次按照1.25倍速度递增容量，也就是每次加上cap&#x2F;4。</p><p>Go1.18之后，引入了新的扩容规则：浅谈 Go 1.18.1的切片扩容机制</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; title=&quot;目录&quot;&gt;&lt;/a&gt;目录&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;#1&quot;&gt;1. 结构体打印时，%v 和 %+v 的区别&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;#2&quot;&gt;2. new和make的区别</summary>
      
    
    
    
    
    <category term="golang" scheme="http://blog.caiplus.pro/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>viper配置文件</title>
    <link href="http://blog.caiplus.pro/2023/07/29/golang/viper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    <id>http://blog.caiplus.pro/2023/07/29/golang/viper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</id>
    <published>2023-07-29T05:08:23.000Z</published>
    <updated>2023-07-29T05:10:06.008Z</updated>
    
    <content type="html"><![CDATA[<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">isvalid:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 设置配置文件的名字</span></span><br><span class="line">viper.SetConfigName(<span class="string">&quot;config&quot;</span>)</span><br><span class="line"><span class="comment">// 设置配置文件的类型</span></span><br><span class="line">viper.SetConfigType(<span class="string">&quot;yaml&quot;</span>)</span><br><span class="line"><span class="comment">// 添加配置文件的路径，指定 config 目录下寻找</span></span><br><span class="line">viper.AddConfigPath(<span class="string">&quot;./config&quot;</span>)</span><br><span class="line"><span class="comment">// 寻找配置文件并读取</span></span><br><span class="line">err := viper.ReadInConfig()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;fatal error config file: %w&quot;</span>, err))</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(viper.Get(<span class="string">&quot;mysql&quot;</span>))</span><br><span class="line">fmt.Println(viper.GetString(<span class="string">&quot;mysql.url&quot;</span>))</span><br><span class="line">fmt.Println(viper.GetInt(<span class="string">&quot;mysql.port&quot;</span>))</span><br><span class="line">fmt.Println(viper.GetBool(<span class="string">&quot;isvalid&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;配置文件&quot;&gt;&lt;a href=&quot;#配置文件&quot; class=&quot;headerlink&quot; title=&quot;配置文件&quot;&gt;&lt;/a&gt;配置文件&lt;/h4&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre</summary>
      
    
    
    
    
    <category term="golang" scheme="http://blog.caiplus.pro/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>xui客户端配置</title>
    <link href="http://blog.caiplus.pro/2023/07/28/%E5%B7%A5%E5%85%B7/xui%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE/"/>
    <id>http://blog.caiplus.pro/2023/07/28/%E5%B7%A5%E5%85%B7/xui%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE/</id>
    <published>2023-07-28T07:46:40.000Z</published>
    <updated>2023-07-29T05:47:42.238Z</updated>
    
    <content type="html"><![CDATA[<p>注意: 只适用于linux环境，下载 <a href="https://github.com/v2ray/v2ray-core/releases">v2ray-core</a>，解压后替换 config.yaml 如下。执行 .&#x2F;v2ray</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;log&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;loglevel&quot;:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;routing&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;domainStrategy&quot;:</span> <span class="string">&quot;AsIs&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;rules&quot;:</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;ip&quot;:</span> [</span><br><span class="line">                    <span class="string">&quot;geoip:private&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;outboundTag&quot;:</span> <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;:</span> <span class="string">&quot;field&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;inbounds&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;port&quot;:</span> <span class="number">1080</span>,</span><br><span class="line">            <span class="attr">&quot;protocol&quot;:</span> <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;auth&quot;:</span> <span class="string">&quot;noauth&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;udp&quot;:</span> <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;tag&quot;:</span> <span class="string">&quot;socks&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;outbounds&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;protocol&quot;:</span> <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;settings&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;vnext&quot;:</span> [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;users&quot;:</span> [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;id&quot;:</span> <span class="string">&quot;&lt;uuid&gt;&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        <span class="attr">&quot;port&quot;:</span> <span class="string">&lt;服务端端口&gt;</span>,</span><br><span class="line">                        <span class="attr">&quot;address&quot;:</span> <span class="string">&quot;&lt;服务端IP&gt;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;protocol&quot;:</span> <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;tag&quot;:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;注意: 只适用于linux环境，下载 &lt;a href=&quot;https://github.com/v2ray/v2ray-core/releases&quot;&gt;v2ray-core&lt;/a&gt;，解压后替换 config.yaml 如下。执行 .&amp;#x2F;v2ray&lt;/p&gt;
&lt;figure</summary>
      
    
    
    
    
    <category term="工具" scheme="http://blog.caiplus.pro/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>chatgpt</title>
    <link href="http://blog.caiplus.pro/2023/07/28/%E5%B7%A5%E5%85%B7/chatgpt/"/>
    <id>http://blog.caiplus.pro/2023/07/28/%E5%B7%A5%E5%85%B7/chatgpt/</id>
    <published>2023-07-28T03:00:52.000Z</published>
    <updated>2023-07-28T05:38:09.860Z</updated>
    
    <content type="html"><![CDATA[<h4 id="测试-key"><a href="#测试-key" class="headerlink" title="测试 key"></a>测试 key</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl https://api.openai.com/v1/chat/completions \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span>  \</span><br><span class="line">-H <span class="string">&quot;Authorization: Bearer <span class="variable">$1</span>&quot;</span>  \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;model&quot;: &quot;gpt-3.5-turbo&quot;, </span></span><br><span class="line"><span class="string">    &quot;messages&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;role&quot;: &quot;user&quot;, </span></span><br><span class="line"><span class="string">            &quot;content&quot;: &quot;Hello!&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;测试-key&quot;&gt;&lt;a href=&quot;#测试-key&quot; class=&quot;headerlink&quot; title=&quot;测试 key&quot;&gt;&lt;/a&gt;测试 key&lt;/h4&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter</summary>
      
    
    
    
    
    <category term="工具" scheme="http://blog.caiplus.pro/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>oh my zsh 让终端飞</title>
    <link href="http://blog.caiplus.pro/2023/07/27/%E5%B7%A5%E5%85%B7/oh-my-zsh-%E8%AE%A9%E7%BB%88%E7%AB%AF%E9%A3%9E/"/>
    <id>http://blog.caiplus.pro/2023/07/27/%E5%B7%A5%E5%85%B7/oh-my-zsh-%E8%AE%A9%E7%BB%88%E7%AB%AF%E9%A3%9E/</id>
    <published>2023-07-27T10:31:40.000Z</published>
    <updated>2023-07-28T11:05:32.600Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum先安装，如果是ubuntu使用 apt-get install zsh </span></span><br><span class="line">yum -y install zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装脚本</span></span><br><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插件安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 高亮插件</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line"></span><br><span class="line"><span class="comment">## 自动补全</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="variable">$ZSH_CUSTOM</span>/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure><h4 id="手动更改插件配置"><a href="#手动更改插件配置" class="headerlink" title="手动更改插件配置"></a>手动更改插件配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># plugins 更改如下</span></span><br><span class="line">plugins=(</span><br><span class="line">  git</span><br><span class="line">  zsh-autosuggestions</span><br><span class="line">  zsh-syntax-highlighting</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换主题</span></span><br><span class="line">ZSH_THEME=<span class="string">&quot;ys&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载</span></span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;l</summary>
      
    
    
    
    
    <category term="工具" scheme="http://blog.caiplus.pro/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>Dockerfile模版</title>
    <link href="http://blog.caiplus.pro/2023/07/27/docker/Dockerfile%E6%A8%A1%E7%89%88/"/>
    <id>http://blog.caiplus.pro/2023/07/27/docker/Dockerfile%E6%A8%A1%E7%89%88/</id>
    <published>2023-07-27T07:34:10.000Z</published>
    <updated>2023-08-03T07:36:47.672Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-一个适用于我自己的模板"><a href="#1-一个适用于我自己的模板" class="headerlink" title="1. 一个适用于我自己的模板"></a>1. 一个适用于我自己的模板</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.20</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> GOOS=linux GOARCH=amd64 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o app main.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================== 分层编译 ==============================================</span></span><br><span class="line"><span class="keyword">FROM</span> alpine AS final</span><br><span class="line"></span><br><span class="line"><span class="comment"># 国内使用的goproxy</span></span><br><span class="line"><span class="keyword">ENV</span> GOPROXY=https://goproxy.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --update tzdata \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/cache/apk/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /root/app .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./mydir/  ./mydir/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x app \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; wget  https://storage.googleapis.com/kubernetes-release/release/v1.14.7/bin/linux/amd64/kubectl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x kubectl</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/root/app&quot;</span>]</span></span><br></pre></td></tr></table></figure><h4 id="2-COPY-vs-ADD"><a href="#2-COPY-vs-ADD" class="headerlink" title="2. COPY vs ADD"></a>2. COPY vs ADD</h4><p>没有特殊需求情况下，建议使用COPY</p><h6 id="1-ADD-会自动解压压缩文件。"><a href="#1-ADD-会自动解压压缩文件。" class="headerlink" title="1. ADD 会自动解压压缩文件。"></a>1. ADD 会自动解压压缩文件。</h6><h6 id="2-ADD-支持源文件URL形式。"><a href="#2-ADD-支持源文件URL形式。" class="headerlink" title="2. ADD 支持源文件URL形式。"></a>2. ADD 支持源文件URL形式。</h6><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> http://example.com/example.txt /app/</span></span><br></pre></td></tr></table></figure><h4 id="3-CMD-vs-ENTRYPOINT"><a href="#3-CMD-vs-ENTRYPOINT" class="headerlink" title="3. CMD vs ENTRYPOINT"></a>3. CMD vs ENTRYPOINT</h4><h6 id="1-docker-run-如果指定了命令会覆盖"><a href="#1-docker-run-如果指定了命令会覆盖" class="headerlink" title="1. docker run 如果指定了命令会覆盖"></a>1. docker run 如果指定了命令会覆盖</h6><h6 id="2-下面是等价的"><a href="#2-下面是等价的" class="headerlink" title="2. 下面是等价的"></a>2. 下面是等价的</h6><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由 CMD 指令指定默认的可选参数：</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;1-一个适用于我自己的模板&quot;&gt;&lt;a href=&quot;#1-一个适用于我自己的模板&quot; class=&quot;headerlink&quot; title=&quot;1. 一个适用于我自己的模板&quot;&gt;&lt;/a&gt;1. 一个适用于我自己的模板&lt;/h4&gt;&lt;figure class=&quot;highlight do</summary>
      
    
    
    
    
    <category term="docker" scheme="http://blog.caiplus.pro/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>golang time包用法</title>
    <link href="http://blog.caiplus.pro/2023/07/27/golang/golang-time%E5%8C%85%E7%94%A8%E6%B3%95/"/>
    <id>http://blog.caiplus.pro/2023/07/27/golang/golang-time%E5%8C%85%E7%94%A8%E6%B3%95/</id>
    <published>2023-07-27T07:33:31.000Z</published>
    <updated>2023-07-27T07:33:50.769Z</updated>
    
    <content type="html"><![CDATA[<h4 id="时间格式"><a href="#时间格式" class="headerlink" title="时间格式"></a>时间格式</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">timelocal, err := time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">time.Local = timelocal</span><br><span class="line">fmt.Println(time.Now().Local().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br></pre></td></tr></table></figure><h4 id="超时处理"><a href="#超时处理" class="headerlink" title="超时处理"></a>超时处理</h4><ul><li><ol><li>使用select<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">    c1 &lt;- <span class="string">&quot;result 1&quot;</span></span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> res := &lt;-c1:</span><br><span class="line">    fmt.Println(res)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(time.Second * <span class="number">1</span>):</span><br><span class="line">    fmt.Println(<span class="string">&quot;timeout 1&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><ol start="2"><li>使用 time.Since<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">startTime := time.Now()</span><br><span class="line">timeout := <span class="number">5</span> * time.Second</span><br><span class="line"></span><br><span class="line">   time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> time.Since(startTime) &gt; timeout &#123;</span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ol></li></ul><h4 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h4><ul><li><ol><li>timer<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// NewTimer 创建一个 Timer，它会在最少过去时间段 d 后到期，向其自身的 C 字段发送当时的时间</span></span><br><span class="line">timer1 := time.NewTimer(<span class="number">5</span> * time.Second)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;开始时间：&quot;</span>, time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(t *time.Timer)</span></span> &#123;</span><br><span class="line">times := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">&lt;-t.C</span><br><span class="line">fmt.Println(<span class="string">&quot;timer&quot;</span>, time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br><span class="line"></span><br><span class="line">times++</span><br><span class="line">fmt.Println(<span class="string">&quot;调用 reset 重新设置一次timer定时器，并将时间修改为2秒&quot;</span>)</span><br><span class="line">t.Reset(<span class="number">2</span> * time.Second)</span><br><span class="line"><span class="keyword">if</span> times &gt; <span class="number">3</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;调用 stop 停止定时器&quot;</span>)</span><br><span class="line">t.Stop()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;(timer1)</span><br><span class="line"></span><br><span class="line">time.Sleep(<span class="number">30</span> * time.Second)</span><br><span class="line">fmt.Println(<span class="string">&quot;结束时间：&quot;</span>, time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></li><li><ol start="2"><li>ticker</li></ol></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ticker1 := time.NewTicker(<span class="number">5</span> * time.Second)</span><br><span class="line"><span class="keyword">defer</span> ticker1.Stop() <span class="comment">// 一定要调用Stop()，回收资源</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(t *time.Ticker)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="comment">// 每5秒中从chan t.C 中读取一次</span></span><br><span class="line">&lt;-t.C</span><br><span class="line">fmt.Println(<span class="string">&quot;Ticker:&quot;</span>, time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line">&#125;(ticker1)</span><br><span class="line"></span><br><span class="line">time.Sleep(<span class="number">30</span> * time.Second)</span><br><span class="line">fmt.Println(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;时间格式&quot;&gt;&lt;a href=&quot;#时间格式&quot; class=&quot;headerlink&quot; title=&quot;时间格式&quot;&gt;&lt;/a&gt;时间格式&lt;/h4&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>容器网络接口（CNI）</title>
    <link href="http://blog.caiplus.pro/2023/07/27/k8s/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%EF%BC%88CNI%EF%BC%89/"/>
    <id>http://blog.caiplus.pro/2023/07/27/k8s/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%EF%BC%88CNI%EF%BC%89/</id>
    <published>2023-07-27T06:31:00.000Z</published>
    <updated>2023-08-10T08:45:01.120Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h1><h2 id="1-交互逻辑"><a href="#1-交互逻辑" class="headerlink" title="1. 交互逻辑"></a>1. 交互逻辑</h2><h4 id="1-1-Pod-IP地址分配机制"><a href="#1-1-Pod-IP地址分配机制" class="headerlink" title="1.1 Pod IP地址分配机制"></a>1.1 Pod IP地址分配机制</h4><p><img src="pod-allow-ip.png" alt="image"></p><h4 id="1-2-CRI插件与CNI插件的交互"><a href="#1-2-CRI插件与CNI插件的交互" class="headerlink" title="1.2 CRI插件与CNI插件的交互"></a>1.2 CRI插件与CNI插件的交互</h4><p><img src="cri-cni.png" alt="cri-cni"></p><h4 id="1-3-CNI插件间的交互"><a href="#1-3-CNI插件间的交互" class="headerlink" title="1.3 CNI插件间的交互"></a>1.3 CNI插件间的交互</h4><p><img src="cni-plugins.png" alt="cni"></p><h1 id="2-flannel-3种模式"><a href="#2-flannel-3种模式" class="headerlink" title="2. flannel 3种模式"></a>2. flannel 3种模式</h1><p><img src="flannel-modes.jpg" alt="flannel"></p><p>UDP、VXLAN模式基于三层网络，host-gateway需要在二层网络同一个交换机下才能实现。</p><h2 id="2-1-vxlan模式"><a href="#2-1-vxlan模式" class="headerlink" title="2.1 vxlan模式"></a>2.1 vxlan模式</h2><p>VXLAN是Flannel默认和推荐的模式。当我们使用默认配置安装Flannel时，它会为每个节点分配一个24位子网，并在每个节点上创建两张虚机网卡： cni0 和 flannel.1 。 cni0 是一个网桥设备，类似于 docker0 ，节点上所有的Pod都通过veth pair的形式与 cni0 相连。 flannel.1 则是一个VXLAN类型的设备，充当VTEP的角色，实现对VXLAN报文的封包解包。</p><h3 id="2-1-1-节点内通信"><a href="#2-1-1-节点内通信" class="headerlink" title="2.1.1 节点内通信"></a>2.1.1 节点内通信</h3><p><img src="flannel-vxlan-1.png" alt="flannel-vxlan-1"></p><h3 id="2-1-2-跨节点通信"><a href="#2-1-2-跨节点通信" class="headerlink" title="2.1.2 跨节点通信"></a>2.1.2 跨节点通信</h3><p><img src="flannel-vxlan-2.png" alt="flannel-vxlan-2"></p><h4 id="大致过程："><a href="#大致过程：" class="headerlink" title="大致过程："></a>大致过程：</h4><ul><li>发送端：在PodA中发起 ping 10.244.1.21 ，ICMP 报文经过 cni0 网桥后交由 flannel.1 设备处理。 flannel.1 设备是一个VXLAN类型的设备，负责VXLAN封包解包。 因此，在发送端，flannel.1 将原始L2报文封装成VXLAN UDP报文，然后从 eth0 发送。</li><li>接收端：Node2收到UDP报文，发现是一个VXLAN类型报文，交由 flannel.1 进行解包。根据解包后得到的原始报文中的目的IP，将原始报文经由 cni0 网桥发送给PodB。</li></ul><h4 id="哪些IP要交由-flannel-1-处理"><a href="#哪些IP要交由-flannel-1-处理" class="headerlink" title="哪些IP要交由 flannel.1 处理?"></a>哪些IP要交由 flannel.1 处理?</h4><p>flanneld 从 etcd 中可以获取所有节点的子网情况，以此为依据为各节点配置路由，将属于非本节点的子网IP都路由到 flannel.1 处理，本节点的子网路由到 cni0 网桥处理。</p><h4 id="flannel-封包过程"><a href="#flannel-封包过程" class="headerlink" title="flannel 封包过程"></a>flannel 封包过程</h4><p>VXLAN的封包是将二层以太网帧封装到四层UDP报文中的过程。</p><h4 id="原始L2帧"><a href="#原始L2帧" class="headerlink" title="原始L2帧"></a>原始L2帧</h4><p>要生成原始的L2帧， flannel.1 需要得知：</p><ul><li>内层源&#x2F;目的IP地址</li><li>内层源&#x2F;目的MAC地址</li></ul><p>内层的源&#x2F;目的IP地址是已知的，即为PodA&#x2F;PodB的PodIP，在图例中，分别为10.224.0.20和10.224.1.20。<br>内层源&#x2F;目的MAC地址要结合路由表和ARP表来获取。根据路由表①得知：</p><p>下一跳地址是10.224.1.0，关联ARP表②，得到下一跳的MAC地址，也就是目的MAC地址：Node2_flannel.1_MAC；<br>报文要从 flannel.1 虚拟网卡发出，因此源MAC地址为 flannel.1 的MAC地址。</p><p>要注意的是，这里ARP表的表项②并不是通过ARP学习得到的，而是 flanneld 预先为每个节点设置好的，由 flanneld负责维护，没有过期时间。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看ARP表</span></span><br><span class="line">[root@Node1 ~]<span class="comment"># ip n | grep flannel.1</span></span><br><span class="line">10.244.1.0 dev flannel.1 lladdr ba:74:f9:db:69:c1 PERMANENT <span class="comment"># PERMANENT 表示永不过期</span></span><br></pre></td></tr></table></figure><p>有了上面的信息， flannel.1 就可以构造出内层的2层以太网帧：</p><p><img src="flannel-vxlan-3.png" alt="flannel_packet_1.png"></p><h4 id="外层VXLAN-UDP报文"><a href="#外层VXLAN-UDP报文" class="headerlink" title="外层VXLAN UDP报文"></a>外层VXLAN UDP报文</h4><p>要将原始L2帧封装成VXLAN UDP报文， flannel.1 还需要填充源&#x2F;目的IP地址。前面提到，VTEP是VXLAN隧道的起点或终点。因此，目的IP地址即为对端VTEP的IP地址，通过FDB表获取。在FDB表③中，dst字段表示的即为VXLAN隧道目的端点（对端VTEP）的IP地址，也就是VXLAN DUP报文的目的IP地址。FDB表也是由 flanneld 在每个节点上预设并负责维护的。</p><p>FDB表（Forwarding database）用于保存二层设备中MAC地址和端口的关联关系，就像交换机中的MAC地址表一样。在二层设备转发二层以太网帧时，根据FDB表项来找到对应的端口。例如cni0网桥上连接了很多veth pair网卡，当网桥要将以太网帧转发给Pod时，FDB表根据Pod网卡的MAC地址查询FDB表，就能找到其对应的veth网卡，从而实现联通。</p><p>可以使用 bridge fdb show 查看FDB表：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Node1 ~]<span class="comment"># bridge fdb show | grep flannel.1</span></span><br><span class="line">ba:74:f9:db:69:c1 dev flannel.1 dst 192.168.50.3 self permanent</span><br></pre></td></tr></table></figure><p>源IP地址信息来自于 flannel.1 网卡设置本身，根据 local 192.168.50.2 可以得知源IP地址为192.168.50.2。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@Node1 ~]<span class="comment"># ip -d a show flannel.1</span></span><br><span class="line">6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 32:02:78:2f:02:cb brd ff:ff:ff:ff:ff:ff promiscuity 0</span><br><span class="line">    vxlan <span class="built_in">id</span> 1 <span class="built_in">local</span> 192.168.50.2 dev eth0 srcport 0 0 dstport 8472 nolearning ageing 300 noudpcsum noudp6zerocsumtx noudp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535</span><br><span class="line">    inet 10.244.0.0/32 brd 10.244.0.0 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::3002:78ff:fe2f:2cb/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>至此， flannel.1 已经得到了所有完成VXLAN封包所需的信息，最终通过 eth0 发送一个VXLAN UDP报文：</p><p>Flannel的VXLAN模式通过静态配置路由表，ARP表和FDB表的信息，结合VXLAN虚拟网卡 flannel.1 ，实现了一个所有Pod同属一个大二层网络的VXLAN网络模型。</p><h2 id="2-1-host-gw模式"><a href="#2-1-host-gw模式" class="headerlink" title="2.1 host-gw模式"></a>2.1 host-gw模式</h2><p><img src="flannel-host-gw-1.png" alt="host-gw模式"></p><p>在host-gw模式下，由于不涉及VXLAN的封包解包，不再需要<code>flannel.1</code>虚机网卡。 <code>flanneld</code> 负责为各节点设置路由 ，将对应节点Pod子网的下一跳地址指向对应的节点的IP，如图中<code>路由表①</code>所示。</p><p>要使用<code>host-gw</code>模式，需要修改 ConfigMap <code>kube-flannel-cfg</code> ，将 <code>Backend.Type</code> 从 <code>vxlan</code>改为<code>host-gw</code>，然后重启所有<code>kube-flannel Pod</code>即可：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-flannel edit configmap kube-flannel-cfg</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.244.0.0/16&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Backend&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;host-gw&quot;</span> // &lt;- 改成host-gw</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h1 id="3-calico-两种网络模式"><a href="#3-calico-两种网络模式" class="headerlink" title="3. calico 两种网络模式"></a>3. calico 两种网络模式</h1><h2 id="3-1-IPIP-模式"><a href="#3-1-IPIP-模式" class="headerlink" title="3.1 IPIP 模式"></a>3.1 IPIP 模式</h2><h4 id="3-1-1-概要"><a href="#3-1-1-概要" class="headerlink" title="3.1.1 概要"></a>3.1.1 概要</h4><p>IPIP模式是calico的默认网络架构，calico中用环境变量<code>CALICO_IPV4POOL_IPIP</code>来标识是否开启<code>IPIP Mode</code>， 如果该变量的值为<code>Always</code>那么就是开启<code>IPIP</code>，如果关闭需要设置为<code>Never</code>(大小写不敏感，代码里有strings.ToLower操作)。</p><ul><li>从字面来理解，就是把一个IP数据包又套在一个IP包里，即把 IP 层封装到 IP 层的一个 tunnel，看起来似乎是浪费，实则不然。</li><li>它的作用其实基本上就相当于一个基于IP层的网桥！</li><li>一般来说，普通的网桥是基于mac层的，根本不需 IP，而这个 ipip 则是通过两端的路由做一个 tunnel，把两个本来不通的网络通过点对点连接起来。</li><li>ipip 的源代码在内核 net&#x2F;ipv4&#x2F;ipip.c 中可以找到。</li></ul><h4 id="3-1-2-工作原理"><a href="#3-1-2-工作原理" class="headerlink" title="3.1.2 工作原理"></a>3.1.2 工作原理</h4><p><img src="calico-ipip-1.png" alt="ipip"></p><p>Calico使用的这个tunl0设备，是一个IP隧道（IP tunnel）设备</p><p>在上面的例子中，IP包进入IP隧道设备之后，就会被Linux内核的IPIP驱动接管。IPIP驱动会将这个IP包直接封装在一个宿主机网络的IP包中，如下所示：</p><p><img src="calico-ipip-2.png" alt="ipip"></p><h2 id="3-2-BGP-模式"><a href="#3-2-BGP-模式" class="headerlink" title="3.2 BGP 模式"></a>3.2 BGP 模式</h2><h4 id="3-2-1-概要"><a href="#3-2-1-概要" class="headerlink" title="3.2.1 概要"></a>3.2.1 概要</h4><ul><li>边界网关协议（Border Gateway Protocol, BGP）是互联网上一个核心的去中心化自治路由协议。</li><li>它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。</li><li>BGP不使用传统的内部网关协议（IGP）的指标，而使用基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议。</li><li>BGP，通俗的讲就是讲接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP，BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统。</li><li>BGP网络相比较IPIP网络，最大的不同之处就是没有了隧道设备 tunl0。前面介绍过<code>IPIP</code>网络pod之间的流量发送tunl0，然后tunl0发送对端设备。BGP网络中，pod之间的流量直接从网卡发送目的地，减少了<code>tunl0</code>这个环节。</li></ul><h4 id="3-2-2-工作原理"><a href="#3-2-2-工作原理" class="headerlink" title="3.2.2 工作原理"></a>3.2.2 工作原理</h4><p><img src="calico-bgp-1.png" alt="bgp"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://ost.51cto.com/posts/15845">https://ost.51cto.com/posts/15845</a><br><a href="https://juejin.cn/post/6994825163757846565">https://juejin.cn/post/6994825163757846565</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CNI&quot;&gt;&lt;a href=&quot;#CNI&quot; class=&quot;headerlink&quot; title=&quot;CNI&quot;&gt;&lt;/a&gt;CNI&lt;/h1&gt;&lt;h2 id=&quot;1-交互逻辑&quot;&gt;&lt;a href=&quot;#1-交互逻辑&quot; class=&quot;headerlink&quot; title=&quot;1. 交互逻辑&quot;&gt;</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://blog.caiplus.pro/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>使用kubeadm安装集群</title>
    <link href="http://blog.caiplus.pro/2023/07/26/k8s/%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4/"/>
    <id>http://blog.caiplus.pro/2023/07/26/k8s/%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4/</id>
    <published>2023-07-26T02:09:12.000Z</published>
    <updated>2023-08-15T08:11:34.128Z</updated>
    
    <content type="html"><![CDATA[<h4 id="图解k8s"><a href="#图解k8s" class="headerlink" title="图解k8s"></a>图解k8s</h4><p><img src="master-worker.png" alt="master-worker"></p><h3 id="1-安装containerd"><a href="#1-安装containerd" class="headerlink" title="1 安装containerd"></a>1 安装containerd</h3><p><a href="https://github.com/containerd/containerd/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/containerd/releases/download/v1.7.2/containerd-1.7.2-linux-amd64.tar.gz</span><br><span class="line">tar Cxzvf /usr/local containerd-1.7.2-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/lib/systemd/system</span><br><span class="line">wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service</span><br><span class="line"><span class="built_in">mv</span> containerd.service /usr/local/lib/systemd/system/containerd.service</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now containerd</span><br></pre></td></tr></table></figure><h3 id="2-安装runc"><a href="#2-安装runc" class="headerlink" title="2 安装runc"></a>2 安装runc</h3><p><a href="https://github.com/opencontainers/runc/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/opencontainers/runc/releases/download/v1.1.8/runc.amd64</span><br><span class="line">install -m 755 runc.amd64 /usr/local/sbin/runc</span><br></pre></td></tr></table></figure><h3 id="3-安装ctrctl"><a href="#3-安装ctrctl" class="headerlink" title="3 安装ctrctl"></a>3 安装ctrctl</h3><p><a href="https://github.com/kubernetes-sigs/cri-tools/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意: 下载对应的集群版本，crictl版本列表：https://github.com/kubernetes-sigs/cri-tools/tags</span></span><br><span class="line">VERSION=<span class="string">&quot;v1.26.0&quot;</span> <span class="comment"># check latest version in /releases page</span></span><br><span class="line">curl -L https://github.com/kubernetes-sigs/cri-tools/releases/download/<span class="variable">$VERSION</span>/crictl-<span class="variable">$&#123;VERSION&#125;</span>-linux-amd64.tar.gz --output crictl-<span class="variable">$&#123;VERSION&#125;</span>-linux-amd64.tar.gz</span><br><span class="line">sudo tar zxvf crictl-<span class="variable">$VERSION</span>-linux-amd64.tar.gz -C /usr/local/bin</span><br><span class="line"><span class="built_in">rm</span> -f crictl-<span class="variable">$VERSION</span>-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="3-1-ctrctl-报错文件找不到"><a href="#3-1-ctrctl-报错文件找不到" class="headerlink" title="3.1 ctrctl 报错文件找不到"></a>3.1 ctrctl 报错文件找不到</h4><ul><li>不同的部署方式，文件路径可能不同。</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以 k3s 为例，指定 .sock 文件</span></span><br><span class="line">crictl --runtime-endpoint /var/run/k3s/containerd/containerd.sock ps -a</span><br></pre></td></tr></table></figure><h4 id="3-2-查看-ctrctl-配置"><a href="#3-2-查看-ctrctl-配置" class="headerlink" title="3.2 查看 ctrctl 配置"></a>3.2 查看 ctrctl 配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/crictl.yaml</span><br></pre></td></tr></table></figure><h3 id="4-安装kubeadm、kubelet、kubectl"><a href="#4-安装kubeadm、kubelet、kubectl" class="headerlink" title="4 安装kubeadm、kubelet、kubectl"></a>4 安装kubeadm、kubelet、kubectl</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOAD_DIR=<span class="string">&quot;/usr/local/bin&quot;</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$DOWNLOAD_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装最新版</span></span><br><span class="line">RELEASE=<span class="string">&quot;<span class="subst">$(curl -sSL https://dl.k8s.io/release/stable.txt)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本</span></span><br><span class="line"><span class="comment"># RELEASE=&quot;v1.26.7&quot;</span></span><br><span class="line"></span><br><span class="line">ARCH=<span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$DOWNLOAD_DIR</span></span><br><span class="line">sudo curl -L --remote-name-all https://dl.k8s.io/release/<span class="variable">$&#123;RELEASE&#125;</span>/bin/linux/<span class="variable">$&#123;ARCH&#125;</span>/&#123;kubeadm,kubelet,kubectl&#125;</span><br><span class="line">sudo <span class="built_in">chmod</span> +x &#123;kubeadm,kubelet,kubectl&#125;</span><br><span class="line"></span><br><span class="line">RELEASE_VERSION=<span class="string">&quot;v0.15.1&quot;</span></span><br><span class="line">curl -sSL <span class="string">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class="variable">$&#123;RELEASE_VERSION&#125;</span>/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&quot;</span> | sed <span class="string">&quot;s:/usr/bin:<span class="variable">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | sudo <span class="built_in">tee</span> /etc/systemd/system/kubelet.service</span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/systemd/system/kubelet.service.d</span><br><span class="line">curl -sSL <span class="string">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class="variable">$&#123;RELEASE_VERSION&#125;</span>/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&quot;</span> | sed <span class="string">&quot;s:/usr/bin:<span class="variable">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | sudo <span class="built_in">tee</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 激活并启动 kubelet</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure><h3 id="5-安装conntrack"><a href="#5-安装conntrack" class="headerlink" title="5 安装conntrack"></a>5 安装conntrack</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install conntrack-tools -y</span><br></pre></td></tr></table></figure><h4 id="5-1-测试"><a href="#5-1-测试" class="headerlink" title="5.1 测试"></a>5.1 测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conntrack -L</span><br></pre></td></tr></table></figure><h3 id="6-设置内核参数"><a href="#6-设置内核参数" class="headerlink" title="6 设置内核参数"></a>6 设置内核参数</h3><p>如果不设置参数，使用 kubeadm join 时可能会导致报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">W0726 10:29:26.474684    8216 checks.go:1064] [preflight] WARNING: Couldn&#x27;t create the interface used for talking to the container runtime: crictl is required by the container runtime: executable file not found in $PATH</span><br><span class="line">[WARNING FileExisting-socat]: socat not found in system path</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">[ERROR FileExisting-crictl]: crictl not found in system path</span><br><span class="line">[ERROR FileExisting-conntrack]: conntrack not found in system path</span><br><span class="line">[ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridge-nf-call-iptables does not exist</span><br><span class="line">[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br></pre></td></tr></table></figure><h4 id="6-1-加载-bridge-内核模块"><a href="#6-1-加载-bridge-内核模块" class="headerlink" title="6.1 加载 bridge 内核模块"></a>6.1 加载 bridge 内核模块</h4><p>查看是否加载 br_netfilter 模块</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure><p>如果没加载执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe br_netfilter</span><br></pre></td></tr></table></figure><h4 id="6-2-更改内核参数"><a href="#6-2-更改内核参数" class="headerlink" title="6.2 更改内核参数"></a>6.2 更改内核参数</h4><p>打开 &#x2F;etc&#x2F;sysctl.conf 文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br></pre></td></tr></table></figure><h4 id="6-3-重新加载-sysctl-配置"><a href="#6-3-重新加载-sysctl-配置" class="headerlink" title="6.3 重新加载 sysctl 配置"></a>6.3 重新加载 sysctl 配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h3 id="7-kubeadm部署集群"><a href="#7-kubeadm部署集群" class="headerlink" title="7 kubeadm部署集群"></a>7 kubeadm部署集群</h3><h4 id="7-1-Master"><a href="#7-1-Master" class="headerlink" title="7.1 Master"></a>7.1 Master</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --v=5</span><br></pre></td></tr></table></figure><p>此时，正常情况下你应该看到master安装成功提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.7.130.29:6443 --token kqi9ve.dvcyddrn9527rvnu \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:67c19abd79fhjkl1cc5a04e2192bf3bc335d41f2f4a76084adcc4cda3d48804</span><br></pre></td></tr></table></figure><h4 id="7-2-Node"><a href="#7-2-Node" class="headerlink" title="7.2 Node"></a>7.2 Node</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> 10.7.130.29:6443 --token kqi9ve.dvcyddrn9527rvnu \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:67c19abd79fhjkl1cc5a04e2192bf3bc335d41f2f4a76084adcc4cda3d48804</span><br></pre></td></tr></table></figure><h4 id="7-3-参数说明"><a href="#7-3-参数说明" class="headerlink" title="7.3 参数说明"></a>7.3 参数说明</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定版本</span></span><br><span class="line">--kubernetes-version=v1.26.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定镜像源为阿里</span></span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定pod网段</span></span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure><h4 id="7-4-重新生成-token"><a href="#7-4-重新生成-token" class="headerlink" title="7.4 重新生成 token"></a>7.4 重新生成 token</h4><p>当忘记kubeadm join命令时，可以重新生成token。以此来获得 kubeadm join 命令。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure><h4 id="7-5-查看-token"><a href="#7-5-查看-token" class="headerlink" title="7.5 查看 token"></a>7.5 查看 token</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm token list</span><br></pre></td></tr></table></figure><h4 id="8-kubeconfig-配置文件"><a href="#8-kubeconfig-配置文件" class="headerlink" title="8 kubeconfig 配置文件"></a>8 kubeconfig 配置文件</h4><p>默认生成的 kubeconfig 文件在 &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">cp</span> /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl get no</span><br></pre></td></tr></table></figure><h4 id="9-安装网络插件"><a href="#9-安装网络插件" class="headerlink" title="9. 安装网络插件"></a>9. 安装网络插件</h4><h5 id="9-1-先安装官方插件"><a href="#9-1-先安装官方插件" class="headerlink" title="9.1 先安装官方插件"></a>9.1 先安装官方插件</h5><p><a href="https://github.com/containernetworking/plugins/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz</span><br><span class="line">tar -zxvf cni-plugins-linux-amd64-v1.3.0.tgz -C /opt/cni/bin</span><br><span class="line"><span class="built_in">rm</span> -f cni-plugins-linux-amd64-v1.3.0.tgz</span><br></pre></td></tr></table></figure><h4 id="9-2-安装-flannel-或-calico"><a href="#9-2-安装-flannel-或-calico" class="headerlink" title="9.2 安装 flannel 或 calico"></a>9.2 安装 flannel 或 calico</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flannel</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># calico</span></span><br><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure><p>安装完<code>cni</code>后，此时<code>coredns</code>应该为<code>running</code></p><h4 id="9-2-1-查看flannel模式"><a href="#9-2-1-查看flannel模式" class="headerlink" title="9.2.1 查看flannel模式"></a>9.2.1 查看flannel模式</h4><p><code>flannel</code> 默认的模式为 <code>vxlan</code>，如果需要修改，可以修改<code>configmap</code> <code>kube-flannel-cfg</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-flannel get configmap kube-flannel-cfg -oyaml</span><br></pre></td></tr></table></figure><h4 id="9-2-2-创建测试pod"><a href="#9-2-2-创建测试pod" class="headerlink" title="9.2.2 创建测试pod"></a>9.2.2 创建测试pod</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run my-pod --image=nginx:latest</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;图解k8s&quot;&gt;&lt;a href=&quot;#图解k8s&quot; class=&quot;headerlink&quot; title=&quot;图解k8s&quot;&gt;&lt;/a&gt;图解k8s&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;master-worker.png&quot; alt=&quot;master-worker&quot;&gt;&lt;/p&gt;
&lt;h3 </summary>
      
    
    
    
    
    <category term="k8s" scheme="http://blog.caiplus.pro/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>使用client-go操作自定义CRD</title>
    <link href="http://blog.caiplus.pro/2023/07/25/k8s/%E4%BD%BF%E7%94%A8client-go%E6%93%8D%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89CRD/"/>
    <id>http://blog.caiplus.pro/2023/07/25/k8s/%E4%BD%BF%E7%94%A8client-go%E6%93%8D%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89CRD/</id>
    <published>2023-07-25T09:18:17.000Z</published>
    <updated>2023-07-28T03:26:12.458Z</updated>
    
    <content type="html"><![CDATA[<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>简洁、高效、无需定义 CR 相关结构体，实现了四种方法： Get、List、Update、Delete 来操作 CR。</p><p>个人觉得这只适合对 CR 字段更改不是很多的环境，如果参数过多可能会有些繁琐。</p><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"></span><br><span class="line">metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1/unstructured&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/client-go/dynamic&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span></span><br><span class="line"><span class="string">&quot;k8s.io/client-go/util/homedir&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> KubernetesCrdExec <span class="keyword">interface</span> &#123;</span><br><span class="line">Get(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="type">string</span>) (*unstructured.Unstructured, <span class="type">error</span>)</span><br><span class="line">List(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace <span class="type">string</span>) (*unstructured.UnstructuredList, <span class="type">error</span>)</span><br><span class="line">Update(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, result *unstructured.Unstructured, namespace, name <span class="type">string</span>) (*unstructured.Unstructured, <span class="type">error</span>)</span><br><span class="line">Delete(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Alertmanager <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">resource := schema.GroupVersionResource&#123;</span><br><span class="line">Group:    <span class="string">&quot;monitoring.coreos.com&quot;</span>,</span><br><span class="line">Version:  <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">Resource: <span class="string">&quot;alertmanagers&quot;</span>, <span class="comment">// 这里必须是复数形式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace := <span class="string">&quot;default&quot;</span></span><br><span class="line">name := <span class="string">&quot;my-alertmanager&quot;</span></span><br><span class="line"></span><br><span class="line">dynamicClient, err := getClient()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err.Error())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> crd KubernetesCrdExec</span><br><span class="line">crd = Alertmanager&#123;&#125;</span><br><span class="line"></span><br><span class="line">result, err := crd.Get(dynamicClient, resource, namespace, name)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(result.Object[<span class="string">&quot;spec&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)[<span class="string">&quot;externalUrl&quot;</span>])</span><br><span class="line"></span><br><span class="line">resultLists, err := crd.List(dynamicClient, resource, namespace)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> resultLists.Items &#123;</span><br><span class="line">name := item.Object[<span class="string">&quot;metadata&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">namespace := item.Object[<span class="string">&quot;metadata&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)[<span class="string">&quot;namespace&quot;</span>]</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v/%v\n&quot;</span>, namespace, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里对 Object 进行修改，更新字段值。这里相当于更新了 spec.externalUrl = http://127.0.0.1:9093</span></span><br><span class="line">result.Object[<span class="string">&quot;spec&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)[<span class="string">&quot;externalUrl&quot;</span>] = <span class="string">&quot;http://127.0.0.1:9093&quot;</span></span><br><span class="line">result, err = crd.Update(dynamicClient, resource, result, namespace, name)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = crd.Delete(dynamicClient, resource, namespace, name)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Alertmanager)</span></span> Get(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="type">string</span>) (*unstructured.Unstructured, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).Get(context.TODO(), name, metav1.GetOptions&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Alertmanager)</span></span> List(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace <span class="type">string</span>) (*unstructured.UnstructuredList, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).List(context.TODO(), metav1.ListOptions&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Alertmanager)</span></span> Update(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, result *unstructured.Unstructured, namespace, name <span class="type">string</span>) (*unstructured.Unstructured, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).Update(context.TODO(), result, metav1.UpdateOptions&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Alertmanager)</span></span> Delete(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).Delete(context.TODO(), name, metav1.DeleteOptions&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getClient</span><span class="params">()</span></span> (dynamic.Interface, <span class="type">error</span>) &#123;</span><br><span class="line">kubeconfig := filepath.Join(homedir.HomeDir(), <span class="string">&quot;.kube&quot;</span>, <span class="string">&quot;config&quot;</span>)</span><br><span class="line">config, err := clientcmd.BuildConfigFromFlags(<span class="string">&quot;&quot;</span>, kubeconfig)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> dynamic.NewForConfig(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h4&gt;&lt;p&gt;简洁、高效、无需定义 CR 相关结构体，实现了四种方法： Get、List、Update、Delete 来操作 CR。&lt;/p&gt;
&lt;p&gt;个人觉</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://blog.caiplus.pro/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>文件、磁盘相关命令</title>
    <link href="http://blog.caiplus.pro/2023/07/25/linux/%E6%96%87%E4%BB%B6%E3%80%81%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/"/>
    <id>http://blog.caiplus.pro/2023/07/25/linux/%E6%96%87%E4%BB%B6%E3%80%81%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/</id>
    <published>2023-07-25T08:03:37.000Z</published>
    <updated>2023-07-25T08:39:20.998Z</updated>
    
    <content type="html"><![CDATA[<h4 id="查看某个目录下所有文件夹大小"><a href="#查看某个目录下所有文件夹大小" class="headerlink" title="查看某个目录下所有文件夹大小"></a>查看某个目录下所有文件夹大小</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只能查看文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前目录</span></span><br><span class="line"><span class="built_in">du</span> -h --max-depth=1 | <span class="built_in">sort</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定目录</span></span><br><span class="line"><span class="built_in">du</span> -h <span class="variable">$DIR</span> --max-depth=1 | <span class="built_in">sort</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数解析</span></span><br><span class="line"><span class="comment"># --max-depth 深度</span></span><br><span class="line"><span class="comment"># sort -h 从小到大排序</span></span><br><span class="line"><span class="comment"># sort -rh 从大到小排序</span></span><br></pre></td></tr></table></figure><h4 id="查看磁盘"><a href="#查看磁盘" class="headerlink" title="查看磁盘"></a>查看磁盘</h4><ol><li>显示系统中每个文件系统的磁盘使用情况</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><ol start="2"><li>显示系统中所有的块设备，包括硬盘和分区。通常，系统盘的挂载点是根目录 &#x2F;，而数据盘则可能挂载在其他目录上，如&#x2F;home、&#x2F;mnt等。</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br></pre></td></tr></table></figure><ol start="3"><li>显示所有在启动时挂载的文件系统，包括系统盘和数据盘的信息。一般情况下，系统盘的挂载信息会在此文件中。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/fstab</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;查看某个目录下所有文件夹大小&quot;&gt;&lt;a href=&quot;#查看某个目录下所有文件夹大小&quot; class=&quot;headerlink&quot; title=&quot;查看某个目录下所有文件夹大小&quot;&gt;&lt;/a&gt;查看某个目录下所有文件夹大小&lt;/h4&gt;&lt;figure class=&quot;highlight </summary>
      
    
    
    
    
    <category term="linux" scheme="http://blog.caiplus.pro/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>如何分配IP</title>
    <link href="http://blog.caiplus.pro/2023/07/24/golang/%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8DIP/"/>
    <id>http://blog.caiplus.pro/2023/07/24/golang/%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8DIP/</id>
    <published>2023-07-24T10:33:58.000Z</published>
    <updated>2023-07-24T10:39:31.221Z</updated>
    
    <content type="html"><![CDATA[<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>当我们有一段或者多段IP时，如何从IP池中分配出一个IP？</p><h4 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; ipam.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;ranges&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;start&quot;: &quot;10.172.16.2&quot;,</span></span><br><span class="line"><span class="string">      &quot;end&quot;: &quot;10.172.16.3&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;start&quot;: &quot;10.172.17.2&quot;,</span></span><br><span class="line"><span class="string">      &quot;end&quot;: &quot;10.172.17.3&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p><a href="https://github.com/oldwang12/ipam">ipam</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h4&gt;&lt;p&gt;当我们有一段或者多段IP时，如何从IP池中分配出一个IP？&lt;/p&gt;
&lt;h4 id=&quot;创建配置文件&quot;&gt;&lt;a href=&quot;#创建配置文件&quot; cl</summary>
      
    
    
    
    
    <category term="golang" scheme="http://blog.caiplus.pro/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>安装kubectl快捷命令</title>
    <link href="http://blog.caiplus.pro/2023/07/23/k8s/%E5%AE%89%E8%A3%85kubectl%E5%BF%AB%E6%8D%B7%E5%91%BD%E4%BB%A4/"/>
    <id>http://blog.caiplus.pro/2023/07/23/k8s/%E5%AE%89%E8%A3%85kubectl%E5%BF%AB%E6%8D%B7%E5%91%BD%E4%BB%A4/</id>
    <published>2023-07-23T07:12:24.000Z</published>
    <updated>2023-07-28T10:33:58.434Z</updated>
    
    <content type="html"><![CDATA[<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>k8s 的命令不算长，也很好记，但身为一个偷懒者，我想我可以更简洁、高效。</p><p>默认快捷命令保存在 ～&#x2F;.bash_profile 文件。</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_install.sh | sh -</span><br></pre></td></tr></table></figure><h6 id="如果你想指定保存文件"><a href="#如果你想指定保存文件" class="headerlink" title="如果你想指定保存文件"></a>如果你想指定保存文件</h6><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_install.sh | bash -s ~/.zshrc</span><br></pre></td></tr></table></figure><p>执行完记得source &lt;～&#x2F;FILE_NAME&gt;，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ～/.bash_profile</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取pod</span></span><br><span class="line">$ p</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-deployment-d5b769945-q29d4   1/1     Running   0          6d7h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入pod</span></span><br><span class="line">$ ke test-deployment-d5b769945-q29d4</span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">$ kl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助</span></span><br><span class="line">$ kh</span><br><span class="line"><span class="built_in">alias</span> k=<span class="string">&quot;kubectl&quot;</span></span><br><span class="line"><span class="built_in">alias</span> kk=<span class="string">&quot;kubectl -n kube-system&quot;</span></span><br><span class="line"><span class="built_in">alias</span> kl=<span class="string">&quot;kubectl logs -f&quot;</span></span><br><span class="line"><span class="built_in">alias</span> kd=<span class="string">&quot;kubectl describe&quot;</span></span><br><span class="line"><span class="built_in">alias</span> p=<span class="string">&quot;kubectl get po&quot;</span></span><br><span class="line"><span class="built_in">alias</span> svc=<span class="string">&quot;kubectl get svc&quot;</span></span><br><span class="line"><span class="built_in">alias</span> no=<span class="string">&quot;kubectl get no&quot;</span></span><br><span class="line"><span class="built_in">alias</span> pvc=<span class="string">&quot;kubectl get pvc&quot;</span></span><br><span class="line"><span class="built_in">alias</span> sa=<span class="string">&quot;kubectl get sa&quot;</span></span><br><span class="line"><span class="built_in">alias</span> ds=<span class="string">&quot;kubectl get ds&quot;</span></span><br><span class="line"><span class="built_in">alias</span> rs=<span class="string">&quot;kubectl get rs&quot;</span></span><br><span class="line"><span class="built_in">alias</span> ep=<span class="string">&quot;kubectl get ep&quot;</span></span><br><span class="line">ke=kubectl <span class="built_in">exec</span> -it POD_NAME sh</span><br></pre></td></tr></table></figure><h4 id="kubens、kubectx"><a href="#kubens、kubectx" class="headerlink" title="kubens、kubectx"></a>kubens、kubectx</h4><p>你可以通过修改环境变量更改 fzf 的背景颜色和字体颜色</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 颜色对照表参考: https://github.com/medikoo/cli-color</span></span><br><span class="line"><span class="built_in">export</span> KUBECTX_CURRENT_FGCOLOR=$(tput setaf 6) <span class="comment"># blue text</span></span><br><span class="line"><span class="built_in">export</span> KUBECTX_CURRENT_BGCOLOR=$(tput setab 7) <span class="comment"># white background</span></span><br></pre></td></tr></table></figure><h1 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_uninstall.sh | sh -</span><br></pre></td></tr></table></figure><p>如果你的文件不是 ～&#x2F;.bashrc，需要替换为对应文件，以 ~&#x2F;.zshrc 为例</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_uninstall.sh | bash -s ~/.zshrc</span><br></pre></td></tr></table></figure><p>执行完记得source &lt;～&#x2F;FILE_NAME&gt;，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ～/.bashrc</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h4&gt;&lt;p&gt;k8s 的命令不算长，也很好记，但身为一个偷懒者，我想我可以更简洁、高效。&lt;/p&gt;
&lt;p&gt;默认快捷命令保存在 ～&amp;#x2F;.bash_pr</summary>
      
    
    
    
    
    <category term="k8s" scheme="http://blog.caiplus.pro/tags/k8s/"/>
    
  </entry>
  
</feed>
