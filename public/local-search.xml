<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>kubernetes 1.26版本解读</title>
    <link href="/2023/09/06/kubernetes%201.26%E7%89%88%E6%9C%AC%E8%A7%A3%E8%AF%BB/"/>
    <url>/2023/09/06/kubernetes%201.26%E7%89%88%E6%9C%AC%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h1><span id="1-重大变化">1. 重大变化</span></h1><h2><span id="11-containerd">1.1 containerd</span></h2><p>1.26 不支持 CRI v1alpha2，并且要求容器运行时必须支持 CRI v1。因此必须要求 Containerd 最低版本为 1.6</p><div class="note note-warning">            <p>升级集群时，需先将Containerd升级到1.6.0及以上版本后，才能将节点升级到Kubernetes 1.26。</p>          </div><h2><span id="12-podsecuritypolicy">1.2 PodSecurityPolicy</span></h2><p>Kubernetes在1.21版本中弃用PodSecurityPolicy，在Kubernetes 1.25版本中彻底移除。</p><h2><span id></span></h2>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>实现 DNS 双栈的一些细节</title>
    <link href="/2023/09/05/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E7%8E%B0-DNS-%E5%8F%8C%E6%A0%88%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/"/>
    <url>/2023/09/05/%E6%8A%80%E6%9C%AF/%E5%AE%9E%E7%8E%B0-DNS-%E5%8F%8C%E6%A0%88%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82/</url>
    
    <content type="html"><![CDATA[<h1><span id="1-概述">1. 概述</span></h1><p>当客户端是双栈环境时，客户端在向 DNS 服务器请求地址解析时，会同时发起域名 A 记录和 AAAA 记录的解析请求，如果后台支持双栈（或者DNS自己返回了双栈的解析结果），就会拿到对应的两种解析地址结果：IPv4 和 IPv6，拿到解析结果后，由客户端选择地址发起连接。<br>为了推广 IPv6，客户端应该从解析结果中优先选择 IPv6 进行连接，但由于当前 IPv6 基础建设尚未完善，连通性问题和可靠性问题不能得到有效保证，链接超时或失败会造成用户可感知的负面体验，有这些负面体验用户可能就完全禁止 IPv6，所以还是需要使用 IPv4 协议适当的做降级和兜底。<br>针对 IPv6 的回退和降级策略，IETF 于2012年发布 <a href="https://datatracker.ietf.org/doc/html/rfc6555">RFC6555</a> 和2017年发布 <a href="https://datatracker.ietf.org/doc/html/rfc8305">RFC8305</a> 两版 RFC 算法来描述了关于在域名解析、地址排序和连接尝试阶段v4配合v6升级适配的详细方案，该方案称为：Happy Eyeballs。</p><ul><li>RFC6555: Happy Eyeballs: Success with Dual-Stack Hosts</li><li>RFC8305: Happy Eyeballs Version 2: Better Connectivity Using Concurrency</li></ul><h2><span id="why-happy-eyeballs">Why Happy Eyeballs ?</span></h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">The name <span class="hljs-string">&quot;happy eyeballs&quot;</span> derives <span class="hljs-built_in">from</span> <span class="hljs-keyword">the</span> term <span class="hljs-string">&quot;eyeball&quot;</span> <span class="hljs-built_in">to</span> describe endpoints which represent human Internet <span class="hljs-keyword">end</span>-users, <span class="hljs-keyword">as</span> opposed <span class="hljs-built_in">to</span> servers.<br></code></pre></td></tr></table></figure><p>我的理解是，Happy Eyeballs 的关注点是人类本身而不是机器，人类在互联网上浏览网页，观看视频，不能因为 IPv6 和 IPv4 网络的连通性问题让他们眼球停留在加载页面，而应该让他们的眼球快乐起来。</p><p>RFC6555 描述了 Happy Eyeballs 原始算法，RFC8305 在 RFC6555 的基础上，添加了如下内容：</p><ul><li>如何执行DNS查询以获取这些地址</li><li>如何处理每个地址族的多个地址</li><li>连接竞速时如何处理DNS更新</li><li>如何利用历史信息</li><li>如何适配使用NAT64和DNS64实现的单栈IPv6网络</li></ul><p>RFC8305 描述的算法仍然符合 RFC6555 的规范，只不过更加细节化，RFC8305 的中文版参考这里。</p><h1><span id="2-happy-eyeballs-快乐眼球算法">2. Happy Eyeballs-快乐眼球算法</span></h1><p>RFC8305 定义的 Happy Eyeballs 归纳如下：</p><ol><li>向DNS 服务器同时发起AAAA记录和A记录解析（AAAA 先于 A）</li><li>如果v6地址先返回就直接开始握手建立连接，如果v4地址先返回，则等待 50ms 等待v6地址返回，以确保优先选择IPv6（AAAA响应跟随A响应几毫秒是很常见的）</li><li>将所有已解析的目标地址排序，排序依据 ([RFC8305], Section 4) 及 ([RFC6724], Section 6)</li><li>排序完成后，会依次有序的取地址发送握手请求，并启动定时任务，该任务在250ms后检查若未完成连接建立，则对第二个地址开始连接尝试</li><li>只有有一个握手确认成功（建立了连接），就会取消所有其他的连接尝试</li></ol><p>RFC6555 中有一点不一样的是，对解析的所有目标地址选取的算法参考的是 [RFC3484] ，[RFC3484]  已经被 [RFC6724] 取代，目的地址排序规则会影响 IPv4 及 IPv6 地址的先后顺序，具体我们在下一节分析。</p><p>Happy Eyeballs 要求在尝试连接之前，实现上不应该等待两个地址族都返回 answers，如果一个查询无法返回或者需要花费更长的时间返回，那么就会造成连接建立的延迟，因此，客户端应将 DNS 解析实现为异步。这一点在 curl 及 go 的实现中都没能做到，curl 会调用 getaddrinfo 方法获取所有地址解析结果后再尝试连接竞速，go 有自己实现的主机名到地址的解析函数，会根据系统及配置选择使用go原生的地址解析函数或者 getaddrinfo，但无论怎样，也是在获取所有地址解析结果后再尝试连接竞速。</p><p>总体来看，Happy Eyeballs 分为目的地址排序和连接竞速两个主要阶段，我们一一来看。</p><h2><span id="21-目的地址排序">2.1. 目的地址排序</span></h2><p>目的地址选取依据 [RFC3484] 及 [RFC6724]，[RFC3484] 已经被 [RFC6724] 取代，但是 getaddrinfo 还是使用了 [RFC3484] 进行目的地址选取排序，go 实现的主机名到地址的解析函数使用了 [RFC6724]。<br>注：[RFC3484] 和 [RFC6724] 描述了源地址及目的地址选取算法，这里我们只关注目的地址选取。</p><p>目的地址选取遵循 10 条规则，优先级 1 &gt; 2 &gt;3 &gt; 4 …，满足一条就返回。<br>目的地址中设计到一些名词我们重点关注一下：</p><ul><li>scope</li><li>precedence</li><li>label</li><li>home addresses</li><li>care-of address</li></ul><table><thead><tr><th>规则</th><th>RFC3484</th><th>RFC6724</th></tr></thead><tbody><tr><td>Rule 1</td><td>Rule 1: Avoid unusable destinations.</td><td>Rule 1: Avoid unusable destinations.</td></tr><tr><td>避免无法使用的地址</td><td>If DB is known to be unreachable or if Source(DB) is undefined, then prefer DA. Similarly, if DA is known to be unreachable or if Source(DA) is undefined, then prefer DB.</td><td>If DB is known to be unreachable or if Source(DB) is undefined, then prefer DA. Similarly, if DA is known to be unreachable or if Source(DA) is undefined, then prefer DB.</td></tr><tr><td>Rule 2</td><td>Rule 2: Prefer matching scope.</td><td>Rule 2: Prefer matching scope.</td></tr><tr><td>匹配源地址 scope 优先</td><td>If Scope(DA) &#x3D; Scope(Source(DA)) and Scope(DB) &lt;&gt; Scope(Source(DB)), then prefer DA.  Similarly, if Scope(DA) &lt;&gt; Scope(Source(DA)) and Scope(DB) &#x3D; Scope(Source(DB)), then prefer DB.</td><td>If Scope(DA) &#x3D; Scope(Source(DA)) and Scope(DB) &lt;&gt; Scope(Source(DB)), then prefer DA.  Similarly, if Scope(DA) &lt;&gt; Scope(Source(DA)) and Scope(DB) &#x3D; Scope(Source(DB)), then prefer DB.</td></tr><tr><td>Rule 3</td><td>Rule 3: Avoid deprecated addresses.</td><td>Rule 3: Avoid deprecated addresses.</td></tr><tr><td>避免已经弃用的地址</td><td>If Source(DA) is deprecated and Source(DB) is not, then prefer DB. Similarly, if Source(DA) is not deprecated and Source(DB) is deprecated, then prefer DA.</td><td>If Source(DA) is deprecated and Source(DB) is not, then prefer DB. Similarly, if Source(DA) is not deprecated and Source(DB) is deprecated, then prefer DA.</td></tr><tr><td>Rule 4</td><td>Rule 4: Prefer home addresses.</td><td>Rule 4: Prefer home addresses.</td></tr><tr><td>home addresses 优先</td><td>If Source(DA) is simultaneously a home address and care-of address and Source(DB) is not, then prefer DA.  Similarly, if Source(DB) is simultaneously a home address and care-of address and Source(DA) is not, then prefer DB. If Source(DA) is just a home address and Source(DB) is just a care-of address, then prefer DA.  Similarly, if Source(DA) is just a care-of address and Source(DB) is just a home address, then prefer DB.</td><td>If Source(DA) is simultaneously a home address and care-of address and Source(DB) is not, then prefer DA.  Similarly, if Source(DB) is simultaneously a home address and care-of address and Source(DA) is not, then prefer DB. If Source(DA) is just a home address and Source(DB) is just a care-of address, then prefer DA.  Similarly, if Source(DA) is just a care-of address and Source(DB) is just a home address, then prefer DB.</td></tr><tr><td>Rule 5</td><td>Rule 5: Prefer matching label.</td><td>Rule 5: Prefer matching label. If Label(Source(DA)) &#x3D; Label(DA) and Label(Source(DB)) &lt;&gt; Label(DB), then prefer DA.  Similarly, if Label(Source(DA)) &lt;&gt; Label(DA) and Label(Source(DB)) &#x3D; Label(DB), then prefer DB.</td></tr><tr><td>匹配 label 优先</td><td>If Label(Source(DA)) &#x3D; Label(DA) and Label(Source(DB)) &lt;&gt; Label(DB), then prefer DA.  Similarly, if Label(Source(DA)) &lt;&gt; Label(DA) and Label(Source(DB)) &#x3D; Label(DB), then prefer DB.</td><td></td></tr><tr><td>Rule 6</td><td>Rule 6: Prefer higher precedence.</td><td>Rule 6: Prefer higher precedence.</td></tr><tr><td>高优先级优先</td><td>If Precedence(DA) &gt; Precedence(DB), then prefer DA.  Similarly, if Precedence(DA) &lt; Precedence(DB), then prefer DB.</td><td>If Precedence(DA) &gt; Precedence(DB), then prefer DA.  Similarly, if Precedence(DA) &lt; Precedence(DB), then prefer DB.</td></tr><tr><td>Rule 7</td><td>Rule 7: Prefer native transport.</td><td>Rule 7: Prefer native transport.</td></tr><tr><td>原生传输协议优先</td><td>If DA is reached via an encapsulating transition mechanism (e.g., IPv6 in IPv4) and DB is not, then prefer DB.  Similarly, if DB is reached via encapsulation and DA is not, then prefer DA. Discussion:  6-over-4 [15], ISATAP [16], and configured tunnels [17] are examples of encapsulating transition mechanisms for which the destination address does not have a specific prefix and hence can not be assigned a lower precedence in the policy table.  An implementation MAY generalize this rule by using a concept of interface preference, and giving virtual interfaces (like the IPv6-in-IPv4 encapsulating interfaces) a lower preference than native interfaces (like ethernet interfaces).</td><td>If DA is reached via an encapsulating transition mechanism (e.g., IPv6 in IPv4) and DB is not, then prefer DB.  Similarly, if DB is reached via encapsulation and DA is not, then prefer DA. Discussion: The IPv6 Rapid Deployment on IPv4 Infrastructures (6rd) Protocol [RFC5969], the Intra-Site Automatic Tunnel Addressing Protocol (ISATAP) [RFC5214], and configured tunnels [RFC4213] are examples of encapsulating transition mechanisms for which the destination address does not have a specific prefix and hence can not be assigned a lower precedence in the policy table. An implementation MAY generalize this rule by using a concept of interface preference and giving virtual interfaces (like the IPv6-in-IPv4 encapsulating interfaces) a lower preference than native interfaces (like ethernet interfaces).</td></tr><tr><td>Rule 8</td><td>Rule 8: Prefer smaller scope.</td><td>Rule 8: Prefer smaller scope.</td></tr><tr><td>更小的 scope 优先</td><td>If Scope(DA) &lt; Scope(DB), then prefer DA.  Similarly, if Scope(DA) &gt; Scope(DB), then prefer DB.</td><td>If Scope(DA) &lt; Scope(DB), then prefer DA.  Similarly, if Scope(DA) &gt; Scope(DB), then prefer DB.</td></tr><tr><td>Rule 9</td><td>Rule 9: Use longest matching prefix.</td><td>Rule 9: Use longest matching prefix.</td></tr><tr><td>前缀匹配长度优先</td><td>When DA and DB belong to the same address family (both are IPv6 or both are IPv4): If CommonPrefixLen(DA, Source(DA)) &gt; CommonPrefixLen(DB, Source(DB)), then prefer DA.  Similarly, if CommonPrefixLen(DA, Source(DA)) &lt; CommonPrefixLen(DB, Source(DB)), then prefer DB.</td><td>When DA and DB belong to the same address family (both are IPv6 or both are IPv4): If CommonPrefixLen(Source(DA), DA) &gt; CommonPrefixLen(Source(DB), DB), then prefer DA.  Similarly, if CommonPrefixLen(Source(DA), DA) &lt; CommonPrefixLen(Source(DB), DB), then prefer DB.</td></tr><tr><td>Rule 10</td><td>Rule 10: Otherwise, leave the order unchanged.</td><td>Rule 10: Otherwise, leave the order unchanged.</td></tr><tr><td>默认规则</td><td>If DA preceded DB in the original list, prefer DA.  Otherwise prefer DB.</td><td>If DA preceded DB in the original list, prefer DA.  Otherwise, prefer DB.</td></tr></tbody></table><p>其中 label 和 precedence 在 默认策略表中定义，10 条规则基本没变，只是对默认策略表进行了一些更改：</p><p>[RFC3484] 默认策略表</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Prefix        Precedence Label<br>::1/128               50     0<br>::/0                  40     1<br>2002::/16             30     2<br>::/96                 20     3<br><span class="hljs-meta">::ffff:0:0/96</span>         10     4<br></code></pre></td></tr></table></figure><p>[RFC6724]  默认策略表</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">Prefix        Precedence Label<br>::1/128              <span class="hljs-number"> 50 </span>    0<br>::/0                 <span class="hljs-number"> 40 </span>    1<br>::ffff:0:0/96        <span class="hljs-number"> 35 </span>    4<br>2002::/16            <span class="hljs-number"> 30 </span>   <span class="hljs-number"> 2 </span>6to4 地址<br>2001::/32             <span class="hljs-number"> 5 </span>   <span class="hljs-number"> 5 </span>Teredo 地址<br>fc00::/7              <span class="hljs-number"> 3 </span>   13<br>::/96                 <span class="hljs-number"> 1 </span>    3<br>fec0::/10             <span class="hljs-number"> 1 </span>   11<br>3ffe::/16             <span class="hljs-number"> 1 </span>   12<br></code></pre></td></tr></table></figure><ol><li>添加 Teredo [RFC4380] 地址前缀 (2001::&#x2F;32)，preference 和 label 值取自已经广泛使用的实现</li><li>在原生 IPv6 地址前缀下添加 ULAs (fc00::&#x2F;7) 地址，因为它不是全球可达地址，参见 Section 10.6</li><li>取消推荐 site-local addresses (fec0::&#x2F;10) ，因其已经被弃用 [RFC3879]</li><li>调整原生 IPv4 地址优先 6to4 (2002::&#x2F;32) 地址</li><li>取消推荐 IPv4-Compatible addresses (::&#x2F;96) 地址，因其被废弃且不再使用 [RFC4291]</li><li>取消推荐  6bone testing addresses (3ffe::&#x2F;16) 地址，因其已经被淘汰而不再首选 [RFC3701]</li><li>Added optional ability for an implementation to add automatic rows to the table for site-specific ULA prefixes and site-specific native 6to4 prefixes</li></ol><p>根据上述规则对 dns 服务器返回的地址进行初步排序，再依据 ([RFC8305], Section 4) 进行 IPv4 和 IPv6 地址交错排序，形成最终的地址排序列表：如果返回的地址包含多个 IPv6 和 IPv4 地址，([RFC8305], Section 4) 中提到了两种实现：</p><ul><li>第一种：v6 v6 v6 v4 v4 v4，地址族分段</li><li>第二种：v6 v4 v6 v4 v6 v4，地址族交错</li></ul><p>地址排序之后，进行连接竞速。</p><h3><span id="211-自定义默认策略表">2.1.1. 自定义默认策略表</span></h3><p>策略表可以自己定义，用来控制不同地址的排序，比如 getaddrinfo 会读取 &#x2F;etc&#x2F;gai.conf 中的策略配置，如果没有特殊配置，getaddrinfo 使用默认的配置，默认将 6to4 地址排在原生 IPv4 地址前，我们可以：<br>将 precedence ::ffff:0:0&#x2F;96  10<br>改 precedence ::ffff:0:0&#x2F;96  35，使原生的 IPv4 地址优于 6to4 地址。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># Configuration for getaddrinfo(3).</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># So far only configuration for the destination address sorting is needed.</span><br><span class="hljs-comment"># RFC 3484 governs the sorting.  But the RFC also says that system</span><br><span class="hljs-comment"># administrators should be able to overwrite the defaults.  This can be</span><br><span class="hljs-comment"># achieved here.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># All lines have an initial identifier specifying the option followed by</span><br><span class="hljs-comment"># up to two values.  Information specified in this file replaces the</span><br><span class="hljs-comment"># default information.  Complete absence of data of one kind causes the</span><br><span class="hljs-comment"># appropriate default information to be used.  The supported commands include:</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># reload  &lt;yes|no&gt;</span><br><span class="hljs-comment">#    If set to yes, each getaddrinfo(3) call will check whether this file</span><br><span class="hljs-comment">#    changed and if necessary reload.  This option should not really be</span><br><span class="hljs-comment">#    used.  There are possible runtime problems.  The default is no.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># label   &lt;mask&gt;   &lt;value&gt;</span><br><span class="hljs-comment">#    Add another rule to the RFC 3484 label table.  See section 2.1 in</span><br><span class="hljs-comment">#    RFC 3484.  The default is:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">label</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>       <span class="hljs-number">0</span><br><span class="hljs-attribute">label</span> ::/<span class="hljs-number">0</span>          <span class="hljs-number">1</span><br><span class="hljs-attribute">label</span> <span class="hljs-number">2002</span>::/<span class="hljs-number">16</span>     <span class="hljs-number">2</span><br><span class="hljs-attribute">label</span> ::/<span class="hljs-number">96</span>         <span class="hljs-number">3</span><br><span class="hljs-attribute">label</span> ::ffff:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>/<span class="hljs-number">96</span> <span class="hljs-number">4</span><br><span class="hljs-attribute">label</span> fec0::/<span class="hljs-number">10</span>     <span class="hljs-number">5</span><br><span class="hljs-attribute">label</span> fc00::/<span class="hljs-number">7</span>      <span class="hljs-number">6</span><br><span class="hljs-attribute">label</span> <span class="hljs-number">2001</span>:<span class="hljs-number">0</span>::/<span class="hljs-number">32</span>   <span class="hljs-number">7</span><br><span class="hljs-attribute">label</span> ::ffff:<span class="hljs-number">7</span>f00:<span class="hljs-number">0001</span>/<span class="hljs-number">128</span> <span class="hljs-number">8</span><br><br><span class="hljs-comment">#    This default differs from the tables given in RFC 3484 by handling</span><br><span class="hljs-comment">#    (now obsolete) site-local IPv6 addresses and Unique Local Addresses.</span><br><span class="hljs-comment">#    The reason for this difference is that these addresses are never</span><br><span class="hljs-comment">#    NATed while IPv4 site-local addresses most probably are.  Given</span><br><span class="hljs-comment">#    the precedence of IPv6 over IPv4 (see below) on machines having only</span><br><span class="hljs-comment">#    site-local IPv4 and IPv6 addresses a lookup for a global address would</span><br><span class="hljs-comment">#    see the IPv6 be preferred.  The result is a long delay because the</span><br><span class="hljs-comment">#    site-local IPv6 addresses cannot be used while the IPv4 address is</span><br><span class="hljs-comment">#    (at least for the foreseeable future) NATed.  We also treat Teredo</span><br><span class="hljs-comment">#    tunnels special.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># precedence  &lt;mask&gt;   &lt;value&gt;</span><br><span class="hljs-comment">#    Add another rule to the RFC 3484 precedence table.  See section 2.1</span><br><span class="hljs-comment">#    and 10.3 in RFC 3484.  The default is:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">precedence</span>  ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>       <span class="hljs-number">50</span><br><span class="hljs-attribute">precedence</span>  ::/<span class="hljs-number">0</span>          <span class="hljs-number">40</span><br><span class="hljs-attribute">precedence</span>  <span class="hljs-number">2002</span>::/<span class="hljs-number">16</span>     <span class="hljs-number">30</span><br><span class="hljs-attribute">precedence</span> ::/<span class="hljs-number">96</span>          <span class="hljs-number">20</span><br><span class="hljs-attribute">precedence</span> ::ffff:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>/<span class="hljs-number">96</span>  <span class="hljs-number">35</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    For sites which prefer IPv4 connections change the last line to</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#precedence ::ffff:0:0/96  100</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># scopev4  &lt;mask&gt;  &lt;value&gt;</span><br><span class="hljs-comment">#    Add another rule to the RFC 3484 scope table for IPv4 addresses.</span><br><span class="hljs-comment">#    By default the scope IDs described in section 3.2 in RFC 3484 are</span><br><span class="hljs-comment">#    used.  Changing these defaults should hardly ever be necessary.</span><br><span class="hljs-comment">#    The defaults are equivalent to:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">169.254.0.0</span>/<span class="hljs-number">112</span>  <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">127.0.0.0</span>/<span class="hljs-number">104</span>    <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">96</span>       <span class="hljs-number">14</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    For sites which use site-local IPv4 addresses behind NAT there is</span><br><span class="hljs-comment">#    the problem that even if IPv4 addresses are preferred they do not</span><br><span class="hljs-comment">#    have the same scope and are therefore not sorted first.  To change</span><br><span class="hljs-comment">#    this use only these rules:</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">169.254.0.0</span>/<span class="hljs-number">112</span>  <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">127.0.0.0</span>/<span class="hljs-number">104</span>    <span class="hljs-number">2</span><br><span class="hljs-attribute">scopev4</span> ::ffff:<span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">96</span>       <span class="hljs-number">14</span><br></code></pre></td></tr></table></figure><h2><span id="22-连接竞速">2.2. 连接竞速</span></h2><p>● 为避免无意义的网络连接，连接竞速过程不应该并行，而是依次有序的单个启动<br>● 在一定的连接尝试延时（推荐250ms）过后，再使用列表中的后续ip地址开始逐个尝试连接。<br>● 一旦首个 IP 连接握手成功后，即取消其他未完成的连接尝试。另外，DNS 客户端解析器仍应在短时间内（建议为1秒）处理来自网络的DNS回复，因为它们将填充 DNS 缓存，并可用于后续连接。<br>● 连接尝试延迟推荐为250ms，可根据相同域名的历史RTT数据采集来动态调整延时，但区间应限制在100ms-2s</p><h1><span id="3-客户端实现">3. 客户端实现</span></h1><p>依据 Happy Eyeballs 算法，各语言的类库都有各自的实现，并且不会完全遵守 Happy Eyeballs。</p><h2><span id="31-go-的实现">3.1. Go 的实现</span></h2><p>Go 实现了自己的主机名到地址的解析函数 goLookupIPCNAMEOrder，依据操作系统版本及相关配置会选择使用 goLookupIPCNAMEOrder  或是 libc 的 getaddrinfo 。默认在 Linux 系统中如果没有特殊配置 &#x2F;etc&#x2F;nsswitch.conf 和 &#x2F;etc&#x2F;resolv.conf 的话，Go 会使用 goLookupIPCNAMEOrder 发起域名解析请求(当 &#x2F;etc&#x2F;resolv.conf 文件中配置了 single-request，Go 会使用 getaddrinfo)。 goLookupIPCNAMEOrder 使用 [RFC6724] 对返回的地址进行排序。</p><p>假设 <a href="http://www.example.com/">www.example.com</a> 有下列</p><ul><li><p>2002:a40:4c07:1::faf1 （6to4）</p></li><li><p>2002:a40:4c07:1::faf2（6to4）</p></li><li><p>2002:a40:4c07:1::faf3（6to4）</p></li><li><p>10.64.78.34</p></li><li><p>10.64.78.35<br>五个解析结果。</p></li><li><p>当 Go 使用 goLookupIPCNAMEOrder：</p></li><li><p>如果 Go 使用 getaddrinfo：</p></li></ul><p>go 在调用 goLookupIPCNAMEOrder 或者 getaddrinfo 函数之后拿到排序过的地址解析列表，然后依据这个排序结果，如果在双栈环境下，地址列表第一个地址是 IPv4 地址，那么所有的 IPv4 放到 primaries 队列中，所有的 IPv6 地址放到 fallbacks 队列中（如果地址列表第一个地址是 IPv6 地址，所有的 IPv6 放到 primaries 队列中，所有的 IPv4 地址放到 fallbacks 队列中），接着优先顺序的对 primaries 队列中的地址尝试连接，如果 300ms（可配置）后连接未建立，那么顺序的对 fallbacks 队列中的地址发起连接（如果primaries队列地址连接出错会马上对 fallbacks 队列地址发起连接，不会等 300ms），任何一个连接成功后，其余连接将被关闭。</p><h1><span id="4-客户端测试">4. 客户端测试</span></h1><p><strong>dns 服务器针对特殊域名，返回如下几种结果：</strong></p><ol><li>返回1个 IPv4 地址</li><li>返回1个 IPv6 地址</li><li>返回1个 IPv4 地址和1个 IPv6 地址</li><li>返回1个 IPv4 地址和1个 broken IPv6 地址</li><li>返回1个 broken IPv4 地址和1个 IPv6 地址</li><li>返回1个 IPv4 地址和2个 IPv6 地址，其中一个 IPv6 地址 broken</li><li>返回2个 IPv4 地址和1个 IPv6 地址，其中一个 IPv4 地址 broken</li></ol><div class="note note-warning">            <p>上面的 IPv6 地址指的是 6to4 地址，broken 指的是网络包丢失的场景，这里我们使用 iptables DROP 掉特殊的地址来模拟 broken。</p>          </div><p><strong>测试环境：</strong></p><ul><li>内核版本：Linux 4.1.0-15.el6.ucloud.x86_64</li><li>操作系统：CentOS release 6.3 (Final)</li><li>glibc 版本：2.12</li><li>curl 版本：curl 7.72.0 (x86_64-redhat-linux-gnu)</li><li>go 版本：go1.15 linux&#x2F;amd64</li><li>python 版本：Python 2.6.6</li><li>nodejs 版本：v0.10.36</li><li>java 版本：”11.0.8” 2020-07-14 LTS</li><li>nginx 版本：nginx&#x2F;1.14.2</li></ul><p><strong>使用 coredns file 插件进行测试，针对上面七种场景，配置7个文件：</strong></p><ul><li>返回1个 IPv4 地址</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">$<span class="hljs-keyword">ORIGIN </span>example.<span class="hljs-keyword">org.</span><br><span class="hljs-keyword"></span>@<span class="hljs-number">3600</span> INSOA sns.dns.icann.<span class="hljs-keyword">org. </span>noc.dns.icann.<span class="hljs-keyword">org. </span>(<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> IN NS a.iana-servers.net.<br><span class="hljs-number">3600</span> IN NS <span class="hljs-keyword">b.iana-servers.net.</span><br><span class="hljs-keyword"></span><br>WWW     IN A     <span class="hljs-number">10</span>.<span class="hljs-number">64</span>.<span class="hljs-number">78</span>.<span class="hljs-number">34</span><br></code></pre></td></tr></table></figure><ul><li>返回1个 IPv6 地址</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">$<span class="hljs-keyword">ORIGIN </span>example.<span class="hljs-keyword">org.</span><br><span class="hljs-keyword"></span>@<span class="hljs-number">3600</span> INSOA sns.dns.icann.<span class="hljs-keyword">org. </span>noc.dns.icann.<span class="hljs-keyword">org. </span>(<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> IN NS a.iana-servers.net.<br><span class="hljs-number">3600</span> IN NS <span class="hljs-keyword">b.iana-servers.net.</span><br><span class="hljs-keyword"></span><br>WWW     IN AAAA  <span class="hljs-number">2002</span>:a40:<span class="hljs-number">4</span>c07:<span class="hljs-number">1</span>::faf1<br></code></pre></td></tr></table></figure><ul><li>返回1个 IPv4 地址和1个 IPv6 地址</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span><span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure><ul><li>返回1个 IPv4 地址和1个 broken IPv6 地址</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span><span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf2</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure><ul><li>返回1个 broken IPv4 地址和1个 IPv6 地址</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns">@<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span><span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.35</span><br></code></pre></td></tr></table></figure><ul><li>返回1个 IPv4 地址和2个 IPv6 地址，其中一个 IPv6 地址 broken</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span><span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::aaa1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure><ul><li>返回2个 IPv4 地址和1个 IPv6 地址，其中一个 IPv4 地址 broken</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-meta">$ORIGIN</span> example.org.<br>@<span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span><span class="hljs-keyword">SOA</span> sns.dns.icann.org. noc.dns.icann.org. (<br><span class="hljs-number">2017042745</span> <span class="hljs-comment">; serial</span><br><span class="hljs-number">7200</span>       <span class="hljs-comment">; refresh (2 hours)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; retry (1 hour)</span><br><span class="hljs-number">1209600</span>    <span class="hljs-comment">; expire (2 weeks)</span><br><span class="hljs-number">3600</span>       <span class="hljs-comment">; minimum (1 hour)</span><br>)<br><br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> a.iana-servers.net.<br><span class="hljs-number">3600</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NS</span> b.iana-servers.net.<br><br>WWW     <span class="hljs-keyword">IN</span> <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2002:a40:4c07:1::faf1</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.33</span><br>        <span class="hljs-keyword">IN</span> <span class="hljs-keyword">A</span>     <span class="hljs-number">10.64.78.34</span><br></code></pre></td></tr></table></figure><h2><span id="41-ipv4-only">4.1. IPv4 only</span></h2><p>执行命令禁用 IPv6:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sysctl net.ipv6.conf.all.disable_ipv6=1<br>sysctl net.ipv6.conf.default.disable_ipv6=1<br></code></pre></td></tr></table></figure><table><thead><tr><th>go</th><th>curl</th><th>python</th><th>node.js</th><th>java</th><th>nginx</th></tr></thead><tbody><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端无法完成连接</td><td>客户端只发起 A 记录解析请求，DNS服务 返回 NOERROR，客户端无法完成连接</td><td>客户端只发起 A 记录解析请求，DNS服务 返回 NOERROR，nginx 无法启动</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4和1个 broken IPv6 地址，客户端直接使用 IPv4 地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，无法完成连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 broken IPv4 地址，客户端无法完成连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 broken IPv4 地址，客户端无法完成连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端直接使用 IPv4 地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端只发起 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待client 超时后（设置为5s）连接未建立，对正常的 IPv4 地址发起连接，连接成功</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待client 超时后（设置为5s）连接未建立，对正常的 IPv4 地址发起连接，连接成功</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，根据传递给 urllib2.urlopen 的 timeout 时间(设置为1s)，1s后对正常的 IPv4 地址发起连接，连接成功</td><td>客户端同时发起 AAAA 和 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td><td>客户端只发起 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td><td>客户端只发起 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待 proxy_connect_timeout（默认1m） 时间后连接未建立，再使用正常 IPv4 地址发起连接，连接成功，后续连接如此循环</td></tr></tbody></table><h2><span id="42-dual-stack">4.2. Dual-stack</span></h2><table><thead><tr><th>go</th><th>curl</th><th>python</th><th>node.js</th><th>java</th><th>nginx</th></tr></thead><tbody><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 地址，客户端直接使用该地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 地址，客户端直接使用该地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端随机使用IPv4 和 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6和1个 IPv4 地址，客户端随机使用 IPv4 和 IPv6 地址建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果使用 broken 的 IPv6 地址发起连接，200ms 后连接未建立，客户端使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv6 地址建立连接，根据传递给 urllib2.urlopen 的 timeout 时间(设置为1s)，1s IPv6 连接未建立，客户端再使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端随机使用 IPv4 和 IPv6 地址，如果使用了 broken 的 IPv6 地址，等待 proxy_connect_timeout（默认1m） 时间后连接未建立再使用 IPv4 建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端首先使用 IPv4 地址建立连接，300ms IPv4 连接未建立，客户端再使用 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果使用 broken 的 IPv4 地址发起连接，200ms 后连接未建立，客户端使用 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端首先使用 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，连接失败</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv6 和1个 broken IPv4 地址，客户端只使用 IPv4 地址建立连接，连接失败</td><td>客户端同时发起 AAAA 和 A 记录解析请求，DNS服务器返回1个 IPv4 和1个 broken IPv6 地址，客户端随机使用 IPv4 和 IPv6 地址，如果使用了 broken 的 IPv4 地址，等待 proxy_connect_timeout（默认1m） 时间后连接未建立再使用 IPv6 建立连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv6 地址在排在正常的 IPv6 地址前，客户端首先使用 broken 地址发起连接，200ms 后连接未建立，客户端直接使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv6 地址发起连接，如果 broken 的 IPv6 地址在排在正常的 IPv6 地址前，客户端首先使用 broken 地址发起连接，根据传递给 urllib2.urlopen 的 timeout 时间(设置为1s)，1s IPv6 连接未建立，对正常的 IPv6 地址发起连接，连接成功</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv4 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv6 地址在排在正常的 IPv6 地址前，客户端首先使用 broken 地址发起连接，等待proxy_connect_timeout（默认1m） 连接未建立，再使用正常 IPv6 地址发起连接</td></tr><tr><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先以顺序的形式对所有 IPv4 地址发起连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待 300ms 连接未建立，对正常的 IPv4 地址发起连接，连接成功</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，200ms 后连接未建立，客户端直接使用 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端首先使用 IPv6 地址建立连接</td><td>客户端同时发起 AAAA 和 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td><td>客户端同时发起 AAAA 和 A 记录解析请求，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端只使用 broken 地址发起连接，连接失败</td><td>客户端同时发起 AAAA 和 A 记录解析请求，客户端随机使用IPv4 和 IPv6 地址建立连接，如果 broken 的 IPv4 地址在排在正常的 IPv4 地址前，客户端首先使用 broken 地址发起连接，等待proxy_connect_timeout（默认1m） 连接未建立，再使用正常 IPv4 地址发起连接</td></tr></tbody></table><h1><span id="5-总结">5. 总结</span></h1><p><strong>集群中主要存在以下集中域名解析请求：</strong></p><ol><li>Kubernetes IPv6 service 域名</li><li>Kubernetes IPv4 service 域名</li><li>特殊域名</li><li>管理网服务域名</li><li>科学上网域名</li><li>外网域名</li></ol><ul><li>对于第 1、2 两类域名，coredns Kubernetes  插件可以根据 service 的类别只返回对应的 IPv6 或者 IPv4 地址；</li><li>对于第 3 类域名我们可以特殊配置 hosts，返回 IPv6 或 IPv4 地址；</li><li>对于第 4 类域名，管理网服务可能不支持 IPv6，dns 服务器也不能直接探测管理网服务是否支持 IPv6，所以dns服务器返回 IPv4 地址和 6to4 地址，由客户端使用 Happy Eyeballs 算法进行连接竞速选择可用的服务地址，如果 IPv6 是不可达、不存在的地址或者没有listen对应的端口，那么连接竞速会快速完成，不会等待连接尝试延迟时间(go默认 300ms)；如果 IPv6 包被丢了，客户端可能会等待尝试延迟时间后再对另一个地址族发起连接，某些客户端比如 nginx 需要设置 proxy_connect_timeout，python urllib2.urlopen 需要设置timeout 时间，不然建立连接很慢；</li><li>对于第 5、6 类地址由于集群现在只支持通过 IPv6 访问公网，所以直接返回 IPv6 地址；</li></ul><h1><span id="6-附录">6. 附录</span></h1><h2><span id="61-客户端测试代码">6.1. 客户端测试代码</span></h2><h3><span id="611-go">6.1.1. go</span></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bufio&quot;</span><br><span class="hljs-string">&quot;bytes&quot;</span><br><span class="hljs-string">&quot;crypto/tls&quot;</span><br><span class="hljs-string">&quot;flag&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;io/ioutil&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>defaultHttpClientTimeout = <span class="hljs-number">5</span> * time.Second<br>)<br><br><span class="hljs-keyword">var</span> (<br>httpReqTimeoutFlag = flag.Duration(<span class="hljs-string">&quot;timeout&quot;</span>, defaultHttpClientTimeout, <span class="hljs-string">&quot;Connection and read timeout value (for http)&quot;</span>)<br>numConnFlag        = flag.Int(<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;Number of connections per host&quot;</span>)<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) &lt; <span class="hljs-number">2</span> &#123;<br>usageErr(<span class="hljs-string">&quot;Error: need at least 1 command parameter&quot;</span>)<br>&#125;<br><br>flag.Parse()<br><br><span class="hljs-keyword">var</span> client runner<br><br>fmt.Println(<span class="hljs-string">&quot;Use Http for dr testing&quot;</span>)<br>client = newHttpClient()<br><br><span class="hljs-keyword">if</span> res, err := client.do(<span class="hljs-string">&quot;first&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Error: query failed, %v\n&quot;</span>, err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Info: receive response, %s\n&quot;</span>, res)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Prints usage and error messages with StdErr writer.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">usageErr</span><span class="hljs-params">(msgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>fmt.Println(msgs...)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> runner <span class="hljs-keyword">interface</span> &#123;<br>do(<span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> httpClient <span class="hljs-keyword">struct</span> &#123;<br>url    <span class="hljs-type">string</span><br>client *http.Client<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newHttpClient</span><span class="hljs-params">()</span></span> runner &#123;<br>url := strings.TrimLeft(flag.Arg(<span class="hljs-number">0</span>), <span class="hljs-string">&quot; \t\r\n&quot;</span>)<br><br>timeout := httpReqTimeoutFlag<br>transport := http.Transport&#123;<br>TLSClientConfig: &amp;tls.Config&#123;<br>InsecureSkipVerify: <span class="hljs-literal">true</span>,<br>&#125;,<br><span class="hljs-comment">//DisableKeepAlives:   false,</span><br>MaxConnsPerHost:     *numConnFlag,<br>MaxIdleConns:        *numConnFlag,<br>MaxIdleConnsPerHost: *numConnFlag,<br>&#125;<br><br>client := &amp;http.Client&#123;<br>Transport: &amp;transport,<br>Timeout:   *timeout,<br>&#125;<br><span class="hljs-keyword">return</span> &amp;httpClient&#123;<br>url:    url,<br>client: client,<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *httpClient)</span></span> do(payload <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>req, err := http.NewRequest(<span class="hljs-string">&quot;GET&quot;</span>, c.url, bytes.NewBufferString(time.Now().String()+<span class="hljs-string">&quot;--&quot;</span>+payload))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><br>resp, err := c.client.Do(req)<br><span class="hljs-keyword">if</span> resp != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">defer</span> resp.Body.Close()<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><br><span class="hljs-keyword">if</span> resp.StatusCode != http.StatusOK &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<br><span class="hljs-string">&quot;error get health information about Grafana, expected status 200 but got %v&quot;</span>,<br>resp.StatusCode)<br>&#125;<br><br>data, err := ioutil.ReadAll(resp.Body)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(data), <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3><span id="612-getaddrinfo">6.1.2. getaddrinfo</span></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">printAddr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr * res)</span>;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hints</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> * <span class="hljs-title">result</span>, * <span class="hljs-title">rp</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage: %s host port...\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <br>    <span class="hljs-built_in">memset</span>( &amp; hints, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> addrinfo));<br>    hints.ai_family = AF_UNSPEC; <span class="hljs-comment">/* Allow IPv4 or IPv6 */</span><br>    hints.ai_socktype = SOCK_STREAM; <span class="hljs-comment">/* Stream socket */</span><br>    hints.ai_flags = (AI_CANONNAME | AI_V4MAPPED | AI_ALL);<br>    <span class="hljs-comment">//hints.ai_flags = 0;</span><br>    <span class="hljs-comment">//hints.ai_protocol = 0;          /* Any protocol */</span><br><br>    s = getaddrinfo(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], &amp; hints, &amp; result);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;getaddrinfo: %s\n&quot;</span>, gai_strerror(s));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* getaddrinfo() returns a list of address structures.*/</span><br><br>    <span class="hljs-keyword">for</span> (rp = result; rp != <span class="hljs-literal">NULL</span>; rp = rp -&gt; ai_next) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Received ai_family:%d ai_socktype:%d ai_protocol:%d ai_addrlen:%d\n&quot;</span>,<br>            rp -&gt; ai_family, rp -&gt; ai_socktype, rp -&gt; ai_protocol, rp -&gt; ai_addrlen);<br>        printAddr(rp -&gt; ai_addr);<br>    &#125;<br><br>    freeaddrinfo(result); <span class="hljs-comment">/* No longer needed */</span><br><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">printAddr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr * res)</span> &#123;<br>    <span class="hljs-type">char</span> * s = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">switch</span> (res -&gt; sa_family) &#123;<br>    <span class="hljs-keyword">case</span> AF_INET: &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> * <span class="hljs-title">addr_in</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr_in * ) res;<br>        s = <span class="hljs-built_in">malloc</span>(INET_ADDRSTRLEN);<br>        inet_ntop(AF_INET, &amp; (addr_in -&gt; sin_addr), s, INET_ADDRSTRLEN);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> AF_INET6: &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in6</span> * <span class="hljs-title">addr_in6</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr_in6 * ) res;<br>        s = <span class="hljs-built_in">malloc</span>(INET6_ADDRSTRLEN);<br>        inet_ntop(AF_INET6, &amp; (addr_in6 -&gt; sin6_addr), s, INET6_ADDRSTRLEN);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IP address: %s\n&quot;</span>, s);<br>    <span class="hljs-built_in">free</span>(s);<br>&#125;<br></code></pre></td></tr></table></figure><h3><span id="613-python">6.1.3. python</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><br><span class="hljs-keyword">import</span> urllib<br><span class="hljs-keyword">import</span> urllib2<br><br>url = <span class="hljs-string">&#x27;http://www.example.org:8080&#x27;</span><br>values = &#123;<span class="hljs-string">&#x27;name&#x27;</span> : <span class="hljs-string">&#x27;Michael&#x27;</span>&#125;<br>data = urllib.urlencode(values)<br>req = urllib2.Request(url, data)<br>response = urllib2.urlopen(req,timeout=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span> response.read()<br><span class="hljs-number">6.1</span><span class="hljs-number">.4</span>. node.js<br>var http = require(<span class="hljs-string">&#x27;http&#x27;</span>);<br><br>var options = &#123;<br>  host: <span class="hljs-string">&#x27;www.example.org&#x27;</span>,<br>  path: <span class="hljs-string">&#x27;/&#x27;</span>,<br>  port: <span class="hljs-string">&#x27;8080&#x27;</span>,<br>  method: <span class="hljs-string">&#x27;POST&#x27;</span><br>&#125;;<br><br>callback = function(response) &#123;<br>  var <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span><br>  response.on(<span class="hljs-string">&#x27;data&#x27;</span>, function (chunk) &#123;<br>    <span class="hljs-built_in">str</span> += chunk;<br>  &#125;);<br><br>  response.on(<span class="hljs-string">&#x27;end&#x27;</span>, function () &#123;<br>    console.log(<span class="hljs-built_in">str</span>);<br>  &#125;);<br>&#125;<br><br>var req = http.request(options, callback);<br>req.write(<span class="hljs-string">&quot;hello world!&quot;</span>);<br>req.end();<br><span class="hljs-number">6.1</span><span class="hljs-number">.5</span>. java<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.URI;<br><span class="hljs-keyword">import</span> java.net.http.HttpClient;<br><span class="hljs-keyword">import</span> java.net.http.HttpRequest;<br><span class="hljs-keyword">import</span> java.net.http.HttpResponse;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetRequestJava11</span> &#123;<br><br>    public static void main(String[] args) throws IOException, InterruptedException &#123;<br><br>        HttpClient client = HttpClient.newHttpClient();<br>        HttpRequest request = HttpRequest.newBuilder()<br>                .uri(URI.create(<span class="hljs-string">&quot;http://www.example.org:8080/&quot;</span>))<br>                .build();<br><br>        HttpResponse&lt;String&gt; response = client.send(request,<br>                HttpResponse.BodyHandlers.ofString());<br><br>        System.out.println(response.body());<br>    &#125;<br>&#125;<br><span class="hljs-number">6.1</span><span class="hljs-number">.6</span>. nginx<br>server &#123;<br>    listen       [::]:<span class="hljs-number">9901</span>;<br>    listen       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">9901</span>;<br>    server_name  localhost;<br><br>    location / &#123;<br>        proxy_pass   http://www.example.org:<span class="hljs-number">8080</span>;<br>    &#125;<br>&#125;<br><br>upstream myserver &#123;<br>    server  www.example.org:<span class="hljs-number">8080</span>;<br>&#125;<br><br>server &#123;<br>    listen       [::]:<span class="hljs-number">9902</span>;<br>    listen       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">9902</span>;<br>    server_name  localhost;<br><br>    location / &#123;<br>        proxy_pass   http://myserver;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>原文链接： <a href="https://www.yuque.com/dogbrother-5valv/tzhl7q/rpuusg#tImdq">https://www.yuque.com/dogbrother-5valv/tzhl7q/rpuusg#tImdq</a></p><h1><span id="参考文献">参考文献</span></h1><p><a href="https://tools.ietf.org/html/rfc3484">https://tools.ietf.org/html/rfc3484</a><br><a href="https://tools.ietf.org/html/rfc6724">https://tools.ietf.org/html/rfc6724</a><br><a href="https://tools.ietf.org/html/rfc6555">https://tools.ietf.org/html/rfc6555</a><br><a href="https://tools.ietf.org/html/rfc8305">https://tools.ietf.org/html/rfc8305</a></p>]]></content>
    
    
    <categories>
      
      <category>技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>dns</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>工具大全</title>
    <link href="/2023/08/29/%E5%B7%A5%E5%85%B7/%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%85%A8/"/>
    <url>/2023/08/29/%E5%B7%A5%E5%85%B7/%E5%B7%A5%E5%85%B7%E5%A4%A7%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>要想下班早，工具用的好。</p>          </div><h1><span id="iterm2-跳板机避免重复验证">iterm2 跳板机避免重复验证</span></h1><p>比如登陆公司跳板机每次需要输入验证码，对开发很不友好，可以在本地环境 ~&#x2F;.ssh&#x2F;config 文件中加上下面配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Host</span> <span class="hljs-string">ujump</span><br>     <span class="hljs-string">HostName</span> <span class="hljs-string">jump1.xxxx.com</span><br>     <span class="hljs-string">Port</span> <span class="hljs-number">22</span><br>     <span class="hljs-string">User</span> <span class="hljs-string">lee</span><br>     <span class="hljs-string">IdentityFile</span> <span class="hljs-string">~/.ssh/id_rsa</span><br>     <span class="hljs-string">ServerAliveInterval</span> <span class="hljs-number">300</span><br>     <span class="hljs-string">ControlMaster</span> <span class="hljs-string">auto</span><br>     <span class="hljs-string">ControlPath</span> <span class="hljs-string">~/.ssh/master-%r@%h:%p</span><br>     <span class="hljs-string">StrictHostKeyChecking</span> <span class="hljs-literal">no</span><br></code></pre></td></tr></table></figure><p>这样就可以免验证登陆，但在使用时还是不友好，因为每次新打开的窗口仍然需要输入ssh xxxx，Mac 可以在iTerm2中进行配置new profile</p><p><img src="iterm.png"></p><h1><span id="ssh-免密登陆">ssh 免密登陆</span></h1><h2><span id="本地">本地</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 生成公钥</span><br>$ ssh-keygen<br></code></pre></td></tr></table></figure><p>cat ~&#x2F;.ssh&#x2F;id_rsa.pub</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCkHYTZDNfsSbanDwlJODoGAx9py6sQpdf/bfR<br></code></pre></td></tr></table></figure><h2><span id="服务器">服务器</span></h2><p>将上一步的key 放入 ~&#x2F;.ssh&#x2F;authorized_keys</p><h1><span id="屏蔽浏览器网络请求">屏蔽浏览器网络请求</span></h1><div class="note note-warning">            <p>在 F12 调试时很不方便，故屏蔽掉不相关的请求。</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">-/.*.js|.*.php|.*.png|.*.ico|.*.css|.*.gif/<br></code></pre></td></tr></table></figure><h1><span id="mac-工具推荐">Mac 工具推荐</span></h1><h4><span id="翻译工具">翻译工具</span></h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">沙拉查词<br></code></pre></td></tr></table></figure><h4><span id="截屏">截屏</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">snipaste</span><br></code></pre></td></tr></table></figure><h4><span id="剪切板复制多个">剪切板（复制多个）</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">icopy</span><br></code></pre></td></tr></table></figure><h4><span id="内存-cpu-磁盘占用">内存、CPU、磁盘占用</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">iStat Menus</span><br></code></pre></td></tr></table></figure><h1><span id="vscode-插件">Vscode 插件</span></h1><h4><span id="markdone-预览">markdone 预览</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Markdown Preview Enhanced</span><br></code></pre></td></tr></table></figure><h4><span id="git-查看历史提交">git 查看历史提交</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Git History</span><br></code></pre></td></tr></table></figure><h4><span id="yaml自动补全">yaml自动补全</span></h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">* </span>git: line<br><span class="hljs-bullet">* </span>kubernetes、yaml<br></code></pre></td></tr></table></figure><h4><span id="自动生成图">自动生成图</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">markmap</span><br></code></pre></td></tr></table></figure><h4><span id="远程开发">远程开发</span></h4><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-comment">Remote - SSH</span><br></code></pre></td></tr></table></figure><h4><span id="html-预览">html 预览</span></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">HTML</span> Preview<br></code></pre></td></tr></table></figure><h4><span id="生成脑图">生成脑图</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">MarkMap</span><br></code></pre></td></tr></table></figure><h4><span id="粘贴图片">粘贴图片</span></h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">Pasts Image</span><br></code></pre></td></tr></table></figure><h4><span id="坤坤鼓励师">坤坤鼓励师</span></h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">坤坤鼓励师<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Sql 操作</title>
    <link href="/2023/08/28/linux/Sql-%E6%93%8D%E4%BD%9C/"/>
    <url>/2023/08/28/linux/Sql-%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>sql整理</p>          </div><h2><span id="1-mysql">1. Mysql</span></h2><h3><span id="删除数据库">删除数据库</span></h3><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">database</span> &lt;数据库名&gt;;<br></code></pre></td></tr></table></figure><h3><span id="创建表">创建表</span></h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-built_in">table_name</span> (<span class="hljs-built_in">column_name</span> column_type)<br></code></pre></td></tr></table></figure><h3><span id="插入数据">插入数据</span></h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso">INSERT <span class="hljs-keyword">INTO</span> table_name ( field1, field2,<span class="hljs-params">...</span>fieldN ) values( value1, value2,<span class="hljs-params">...</span>valueN );<br></code></pre></td></tr></table></figure><h3><span id="更新数据">更新数据</span></h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">SET</span> field1=<span class="hljs-built_in">new</span>-value1, field2=<span class="hljs-built_in">new</span>-value2 [<span class="hljs-keyword">WHERE</span> Clause]<br></code></pre></td></tr></table></figure><h3><span id="删除数据">删除数据</span></h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-built_in">table_name</span> [<span class="hljs-keyword">WHERE</span> Clause]<br></code></pre></td></tr></table></figure><h3><span id="like">like</span></h3><p>address 表中获取 domain 字段中以 COM 为结尾的的所有记录</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> address <span class="hljs-keyword">where</span> <span class="hljs-keyword">domain</span> <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%COM&#x27;</span>;<br></code></pre></td></tr></table></figure><h3><span id="order-by-排序">order by (排序)</span></h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">ASC</span>;<br></code></pre></td></tr></table></figure><p>ASC: 升序       DESC:降序</p><p>默认为 ASC</p><h3><span id="alert">alert</span></h3><table><thead><tr><th>Field</th><th>Type</th><th>Null</th><th>Key</th><th>Default</th><th>Extra</th></tr></thead><tbody><tr><td>i</td><td>int(11)</td><td>YES</td><td></td><td>NULL</td><td></td></tr><tr><td>c</td><td>char(1)</td><td>YES</td><td></td><td>NULL</td><td></td></tr></tbody></table><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">alert <span class="hljs-selector-tag">table</span> leesin  drop <span class="hljs-selector-tag">i</span>;    删除表的 <span class="hljs-selector-tag">i</span> 字段<br>alert <span class="hljs-selector-tag">table</span> leesin  aaa <span class="hljs-selector-tag">i</span> INT; 增加表的 <span class="hljs-selector-tag">i</span> 字段<br></code></pre></td></tr></table></figure><h3><span id="mysqldump-mysql-外部执行">mysqldump (mysql 外部执行)</span></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">mysqldump -u <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span> -h <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span> -P <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span> -p<span class="hljs-tag">&lt;<span class="hljs-name">passward</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span> &gt; text.sql<br></code></pre></td></tr></table></figure><h3><span id="导入-db">导入 DB</span></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">mysql -u <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span> -h <span class="hljs-tag">&lt;<span class="hljs-name">host</span>&gt;</span> -P <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span> -p<span class="hljs-tag">&lt;<span class="hljs-name">passward</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span> &lt; text.sql<br></code></pre></td></tr></table></figure><h2><span id="2-postgres">2. Postgres</span></h2><h3><span id="备份">备份</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">pg_dumpall -U postgres &gt; /var/lib/postgresql/dump.sql<br></code></pre></td></tr></table></figure><h3><span id="恢复">恢复</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">psql -U postgres -f /var/lib/postgresql/dump.sql<br></code></pre></td></tr></table></figure><h3><span id="删除数据库">删除数据库</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">dropdb -U postgres postgres<br></code></pre></td></tr></table></figure><h3><span id="新建数据库">新建数据库</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">createdb  -U postgres postgres<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>sql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>frp 内网穿透</title>
    <link href="/2023/08/19/linux/frp-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"/>
    <url>/2023/08/19/linux/frp-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>公网服务器上安装 frp 服务端，内网服务器安装 frp 客户端。</p>          </div><span id="more"></span><h2><span id="1-服务端">1. 服务端</span></h2><p>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;frps.service</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">[Unit]<br><span class="hljs-comment"># 服务名称，可自定义</span><br>Description = frp server<br>After = network.target syslog.target<br>Wants = network.target<br><br>[Service]<br>Type = simple<br><span class="hljs-comment"># 启动frps的命令，需修改为您的frps的安装路径</span><br>ExecStart = /root/frp/frps -c /root/frp/frps.ini<br><br>[Install]<br>WantedBy = multi-user.target<br></code></pre></td></tr></table></figure><p>&#x2F;frp&#x2F;.frp&#x2F;frps.ini</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">[common]<br>bind_port = 7000<br>dashboard_port = 7500<br>token = abcdefg<br>dashboard_user = xx<br>dashboard_pwd = xx<br>vhost_http_port = 10080<br>vhost_https_port = 10443<br></code></pre></td></tr></table></figure><h2><span id="2-客户端">2. 客户端</span></h2><p>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;frpc.service</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">[Unit]<br><span class="hljs-comment"># 服务名称，可自定义</span><br>Description = frp client<br>After = network.target syslog.target<br>Wants = network.target<br><br>[Service]<br>Type = simple<br><span class="hljs-comment"># 启动frps的命令，需修改为您的frpc的安装路径</span><br>ExecStart = /root/frp/frpc -c /root/frp/frpc.ini<br><br>[Install]<br>WantedBy = multi-user.target<br></code></pre></td></tr></table></figure><p>&#x2F;root&#x2F;frp&#x2F;frpc.ini</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh">[common]<br>server_addr = 100.100.100.100<br>server_port = 7000<br>token = abcdefg<br><br>[ssh]<br><span class="hljs-built_in">type</span> = tcp<br>local_ip = 127.0.0.1<br>local_port = 22<br>remote_port = 6000<br><br>[alist]<br><span class="hljs-built_in">type</span> = tcp<br>local_ip = 127.0.0.1<br>local_port = 5244<br>remote_port = 55244<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>frp</tag>
      
      <tag>nas</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>玩客云入门</title>
    <link href="/2023/08/19/linux/%E7%8E%A9%E5%AE%A2%E4%BA%91%E5%85%A5%E9%97%A8/"/>
    <url>/2023/08/19/linux/%E7%8E%A9%E5%AE%A2%E4%BA%91%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>无需短接，直刷。</p>          </div><span id="more"></span><h2><span id="1-刷机">1. 刷机</span></h2><p>网上看了很多刷机教程全都是需要短接电路板。阴差阳错找到了一个直刷包。</p><p><a href>玩客云刷机包</a></p><h2><span id="2-更改apt源为国内">2 更改apt源为国内</span></h2><div class="note note-warning">            <p>Armbian 默认软件源为 Debian 官方的，使用起来速度比较慢，可以更改为国内源加快更新及安装速度。<br>国内Linux源有很多，通常使用 清华大学 的，有详细的使用文档，还有各种系统的国内下载镜像，很方便。</p>          </div><p>首先：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt install apt-transport-https ca-certificates<br></code></pre></td></tr></table></figure><p>Armbian 更改源的时候需要改两个地方：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/apt/sources.list<br></code></pre></td></tr></table></figure><p>将里面内容全部注释掉，添加：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释，“buster”根据版本更改。</span><br>deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free<br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster main contrib non-free</span><br>deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free<br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-updates main contrib non-free</span><br>deb https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free<br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian/ buster-backports main contrib non-free</span><br>deb https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free<br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/debian-security buster/updates main contrib non-free</span><br></code></pre></td></tr></table></figure><p>然后还有一个地方需要更改，是Armbian自身的内容更新源</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/apt/sources.list.d/armbian.list<br></code></pre></td></tr></table></figure><p>注释掉原来内容，添加：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># “buster”根据版本更改</span><br>deb http://mirrors.tuna.tsinghua.edu.cn/armbian/ buster main buster-utils buster-desktop<br></code></pre></td></tr></table></figure><p>之后就可以愉快的</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ sudo apt update<br>$ sudo apt upgrade<br>or<br>$ sudo apt dist-upgrade<br></code></pre></td></tr></table></figure><h2><span id="3-安装最新版docker">3. 安装最新版docker</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget -qO- https://get.docker.com/ | sh<br></code></pre></td></tr></table></figure><h2><span id="4-固定ip">4. 固定IP</span></h2><h3><span id="41-玩客云">4.1 玩客云</span></h3><ol><li>修改 &#x2F;etc&#x2F;network&#x2F;interfaces</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /etc/network/interfaces.d/*<br><br>allow-hotplug eth0<br>no-auto-down eth0<br>iface eth0 inet static<br>hwaddress ether 1e:d8:3d:b7:45:54<br>pre-up ifconfig eth0 hw ether 1e:d8:3d:b7:45:54<br>address 192.168.31.131<br>netmask 255.255.255.0<br>gateway 192.168.31.1<br>dns-nameservers 192.168.31.1<br>pre-up /sbin/ifconfig eth0 mtu 3838<br></code></pre></td></tr></table></figure><ol start="2"><li><p>修改 &#x2F;etc&#x2F;network&#x2F;interfaces.default 内容和 &#x2F;etc&#x2F;network&#x2F;interfaces 一致</p></li><li><p>重启网络</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">reboot<br></code></pre></td></tr></table></figure><h3><span id="42-树莓派">4.2 树莓派</span></h3><h4><span id="421-更改文件-etcdhcpcdconf">4.2.1 更改文件 <code>/etc/dhcpcd.conf</code></span></h4><p>在文件的末尾添加以下内容，替换成适合你的网络配置：</p><div class="note note-warning">            <p>如果你使用 Wi-Fi 连接，请将 interface 替换为 wlan0。</p>          </div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs conf">interface eth0<br>static ip_address=&lt;固定 IP 地址&gt;/24<br>static routers=&lt;默认网关 IP 地址&gt;<br>static domain_name_servers=&lt;DNS 服务器 IP 地址&gt;<br></code></pre></td></tr></table></figure><h4><span id="422-重新启动网络服务以应用更改">4.2.2 重新启动网络服务以应用更改：</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo service dhcpcd restart<br></code></pre></td></tr></table></figure><h4><span id="423-wifi固定ip">4.2.3 wifi固定IP</span></h4><p>如果你需要通过 Wi-Fi 连接，可以使用 wpa_supplicant.conf 文件配置 Wi-Fi 设置并设置固定 IP 地址。以下是一个示例的 wpa_supplicant.conf 文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs conf">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev<br>update_config=1<br>country=&lt;你的国家代码&gt;<br><br>network=&#123;<br>   ssid=&quot;&lt;无线网络名称&gt;&quot;<br>   psk=&quot;&lt;无线网络密码&gt;&quot;<br>   id_str=&quot;%wpa_id%&quot;<br>   priority=15<br>&#125;<br></code></pre></td></tr></table></figure><h2><span id="5-挂载磁盘">5. 挂载磁盘</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">mount /dev/sda1 /data<br></code></pre></td></tr></table></figure><h2><span id="6-安装vim">6. 安装vim</span></h2><h3><span id="61-卸载-vim-common">6.1 卸载 vim-common</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt-get remove vim-common<br></code></pre></td></tr></table></figure><h3><span id="62-安装vim">6.2 安装vim</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo apt-get remove --auto-remove vim-common<br></code></pre></td></tr></table></figure><h2><span id="7-允许root登陆">7. 允许root登陆</span></h2><h3><span id="71-设置-root-密码">7.1 设置 root 密码：</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo passwd root<br></code></pre></td></tr></table></figure><h3><span id="72-允许-root-远程登陆">7.2 允许 root 远程登陆：</span></h3><p>修改 &#x2F;etc&#x2F;ssh&#x2F;sshd_config 文件，允许 root 登录。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo vim /etc/ssh/sshd_config<br></code></pre></td></tr></table></figure><p>找到 PermitRootLogin 一行，并将其值修改为 yes：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">PermitRootLogin</span> <span class="hljs-literal">yes</span><br></code></pre></td></tr></table></figure><h3><span id="73-重启-sshd-服务">7.3 重启 sshd 服务：</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo service ssh restart<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>玩客云</tag>
      
      <tag>armbian</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fzf-搜索神器</title>
    <link href="/2023/08/17/linux/fzf-%E6%90%9C%E7%B4%A2%E7%A5%9E%E5%99%A8/"/>
    <url>/2023/08/17/linux/fzf-%E6%90%9C%E7%B4%A2%E7%A5%9E%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>模糊搜索神器</p>          </div><span id="more"></span><h2><span id="1-配合history">1. 配合history</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">history</span> | fzf | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs -r -I &#123;&#125; sh -c <span class="hljs-string">&quot;&#123;&#125;&quot;</span><br></code></pre></td></tr></table></figure><h2><span id="2-搜索到文件后查看内容">2. 搜索到文件后查看内容</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ls</span> -l | fzf | awk <span class="hljs-string">&#x27;&#123;print $9&#125;&#x27;</span> | xargs -r -I &#123;&#125; sh -c <span class="hljs-string">&quot;cat &#123;&#125;&quot;</span><br></code></pre></td></tr></table></figure><h2><span id="3-查看git提交状态">3. 查看git提交状态</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git <span class="hljs-built_in">log</span> --oneline | fzf | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs -r -I &#123;&#125; git show &#123;&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>fzf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang垃圾回收</title>
    <link href="/2023/08/16/golang/golang%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
    <url>/2023/08/16/golang/golang%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>golang是通过 <span class="label label-primary">三色标记法</span> 来进行垃圾回收。</p>          </div><span id="more"></span><h2><span id="1-标记过程">1. 标记过程</span></h2><p><img src="1.png" alt="image"></p><ul><li>初始状态下所有对象都是白色的。</li><li>从根节点开始遍历所有对象，把遍历到的对象变成灰色对象</li><li>遍历灰色对象，将灰色对象引用的对象也变成灰色对象，然后将遍历过的灰色对象变成黑色对象。</li><li>循环步骤3，直到灰色对象全部变黑色。</li><li>通过写屏障(write-barrier)检测对象有变化，重复以上操作</li><li>回收所有白色对象（垃圾）。</li></ul><h2><span id="2-根对象是什么">2. 根对象是什么？</span></h2><p>根对象在垃圾回收的术语中又叫做根集合，它是垃圾回收器在标记过程时最先检查的对象，包括：</p><ul><li>全局变量：程序在编译期就能确定的那些存在于程序整个生命周期的变量。</li><li>执行栈：每个 goroutine 都包含自己的执行栈，这些执行栈上包含栈上的变量及指向分配的堆内存区块的指针。</li><li>寄存器：寄存器的值可能表示一个指针，参与计算的这些指针可能指向某些赋值器分配的堆内存区块。</li></ul><h2><span id="3-stwstop-the-world">3. STW（Stop The World）</span></h2><ul><li>为了避免在 GC 的过程中，对象之间的引用关系发生新的变更，使得GC的结果发生错误（如GC过程中新增了一个引用，但是由于未扫描到该引用导致将被引用的对象清除了），停止所有正在运行的协程。</li><li>STW对性能有一些影响，Golang目前已经可以做到1ms以下的STW。</li></ul><h2><span id="4-写屏障write-barrier">4. 写屏障(Write Barrier)</span></h2><p>为了避免GC的过程中新修改的引用关系到GC的结果发生错误，我们需要进行STW。但是STW会影响程序的性能，所以我们要<span class="label label-danger">通过写屏障技术尽可能地缩短STW的时间。</span></p><h3><span id="41-写屏障的原理">4.1 写屏障的原理</span></h3><p>造成引用对象丢失的条件:</p><ul><li>一个黑色A新增了指向白色C的引用，</li><li>白色C没有其他灰色的引用(除A之外)。</li></ul><p>以上两个条件需要同时满足：满足条件1时说明A已扫描完毕，A指向C的引用无法再被扫描到；满足条件2时说明C无其他灰色的引用了，即扫描结束后会被忽略 。</p><span class="label label-danger">写屏障破坏两个条件其一即可</span><h4><span id="42-如何破坏">4.2 如何破坏？</span></h4><ul><li><strong>Dijistra写屏障</strong></li></ul><p>满足强三色不变性：黑色节点不允许引用白色节点，当黑色节点新增了白色节点的引用时，将对应的白色节点改为灰色</p><ul><li><strong>Yuasa写屏障</strong></li></ul><p>满足弱三色不变性：黑色节点允许引用白色节点，但是该白色节点有其他灰色节点间接的引用（确保不会被遗漏），当白色节点被删除了一个引用时，悲观地认为它一定会被一个黑色节点新增引用，所以将它置为灰色</p><h2><span id="5-gc-触发时机">5. GC 触发时机</span></h2><p><strong>内存分配量达到阈值触发GC</strong></p><p>每次内存分配时都会检查当前内存分配量是否已达到阈值，如果达到阈值立即启动GC，</p><span class="label label-primary">阈值 = 上次GC内存分配量 × 内存增长率</span><p><strong>定期触发GC</strong></p><p>默认情况下，最长2分钟触发一次GC，这个时间间隔由 runtime.forcegcperiod变量声明</p><p><strong>主动触发</strong></p><p>程序代码中可以调用 runtime.GC() 来触发GC，主要用于GC的性能测试和统计。</p>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Markdown使用</title>
    <link href="/2023/08/16/%E5%B7%A5%E5%85%B7/markdown%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/08/16/%E5%B7%A5%E5%85%B7/markdown%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>有一些语法可能只能在 hexo fluid 主题中使用。</p>          </div><span id="more"></span><h2><span id="1-文本颜色">1. 文本颜色</span></h2><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs md"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: green;&quot;</span>&gt;</span></span>green<span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: red;&quot;</span>&gt;</span></span>red<span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h2><span id="2-页面内实现目录">2. 页面内实现目录</span></h2><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs md"><span class="hljs-section">### 目录</span><br>[<span class="hljs-string">1. 章节1</span>](<span class="hljs-link">#1</span>)<br><br>&lt;!-- 这里 p 标签必须和下面一行隔开 --&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span></span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h2><span id="3-标签">3. 标签</span></h2><h3><span id="31-便签">3.1 便签</span></h3><p>参考：<a href="https://fluid-dev.github.io/hexo-fluid-docs/guide/#tag-%E6%8F%92%E4%BB%B6">https://fluid-dev.github.io/hexo-fluid-docs/guide/#tag-%E6%8F%92%E4%BB%B6</a></p><p>在 markdown 中加入如下的代码来使用便签：</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs md">&#123;% note success %&#125;<br>文字 或者 <span class="hljs-code">`markdown`</span> 均可<br>&#123;% endnote %&#125;<br></code></pre></td></tr></table></figure><p>或者使用 HTML 形式：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;note note-primary&quot;</span>&gt;</span>标签<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br></code></pre></td></tr></table></figure><p>可选便签：</p><div class="note note-primary">            <p>primary</p>          </div><div class="note note-secondary">            <p>secondary</p>          </div><div class="note note-success">            <p>success</p>          </div><div class="note note-danger">            <p>danger</p>          </div><div class="note note-warning">            <p>warning</p>          </div><div class="note note-info">            <p>info</p>          </div><div class="note note-light">            <p>light</p>          </div><h3><span id="32-行内标签">3.2 行内标签</span></h3><p>在 markdown 中加入如下的代码来使用 Label：</p><span class="label label-primary">text</span><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs md">&#123;% label primary @text %&#125;<br></code></pre></td></tr></table></figure><p>或者使用 HTML 形式：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;label label-primary&quot;</span>&gt;</span>Label<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br></code></pre></td></tr></table></figure><p>可选 Label：</p><span class="label label-primary">primary</span><span class="label label-default">default</span><span class="label label-info">info</span><span class="label label-success">success</span><span class="label label-warning">warning</span><span class="label label-danger">danger</span><div class="note note-warning">            <p>警告：</p><p>若使用 <span class="label label-primary">text</span>，text 不能以 @ 开头</p>          </div><h3><span id="33-勾选框">3.3 勾选框</span></h3><p>在 markdown 中加入如下的代码来使用 Checkbox：</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs md">&#123;% cb text, checked?, incline? %&#125;<br></code></pre></td></tr></table></figure><ul><li>text：显示的文字</li><li>checked：默认是否已勾选，默认 false</li><li>incline: 是否内联（可以理解为后面的文字是否换行），默认 false</li></ul><p>示例：</p><div>            <input type="checkbox" disabled>普通示例          </div><div>            <input type="checkbox" disabled checked="checked">默认选中          </div>            <input type="checkbox" disabled>内联示例           后面文字不换行<input type="checkbox" disabled> 也可以只传入一个参数，文字写在后边（这样不支持外联）<p></p><p>示例代码：</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs md">&#123;% cb 普通示例 %&#125;<br>&#123;% cb 默认选中, true %&#125;<br>&#123;% cb 内联示例, false, true %&#125; 后面文字不换行<br>&#123;% cb false %&#125; 也可以只传入一个参数，文字写在后边（这样不支持外联）<br></code></pre></td></tr></table></figure><h2><span id="4-文章概要">4. 文章概要</span></h2><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs md">&lt;!-- more --&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>markdown</tag>
      
      <tag>fluid</tag>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux 命令大全</title>
    <link href="/2023/08/16/linux/linux-%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8/"/>
    <url>/2023/08/16/linux/linux-%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>分为文件操作、网络管理、系统管理、进程管理、安全性来归纳linux基本使用</p>          </div><span id="more"></span><h1><span id="1-文件操作">1. 文件操作</span></h1><h2><span id="文件权限">文件权限</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 以数字形式输出文件权限，0644</span><br><span class="hljs-built_in">stat</span> -c <span class="hljs-string">&#x27;%a&#x27;</span> example.txt<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ls</span> -l example.txt<br><br><span class="hljs-comment"># 输出将类似于以下内容：</span><br>-rw-r--r-- 1 user group 12345 Jan 1 10:00 example.txt<br><br><span class="hljs-comment"># 在这个示例中，-rw-r--r--表示文件的权限。</span><br><span class="hljs-comment"># 第一个字符表示文件类型，- 表示普通文件。剩余的九个字符分为三组，每组三个字符表示所有者、所属组和其他人的权限。</span><br><span class="hljs-comment"># 每组中的三个字符表示读（r）、写（w）和执行（x）权限。如果对应位置有权限，字符表示对应的权限，否则用 - 来表示缺少权限。</span><br><span class="hljs-comment"># 在这个例子中，-rw-r--r-- 表示文件所有者有读、写权限，所属组和其他人只有读权限。</span><br></code></pre></td></tr></table></figure><h2><span id="解压-压缩">解压、压缩</span></h2><h3><span id="解压">解压</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -xzvf test.tar.gz<br></code></pre></td></tr></table></figure><h3><span id="压缩">压缩</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -czvf test.tar.gz README.md<br></code></pre></td></tr></table></figure><h3><span id="解压到指定文件夹">解压到指定文件夹</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -xzvf test.tar.gz -C /home/test<br></code></pre></td></tr></table></figure><h3><span id="列出压缩文件内容">列出压缩文件内容</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -tzvf test.tar.gz <br></code></pre></td></tr></table></figure><div class="note note-warning">            <p><strong>参数说明</strong></p><ul><li>-v 显示指令执行过程。</li><li>-c 建立新的备份文件。</li><li>-f 指定备份文件。</li><li>-z 通过gzip指令处理备份文件。</li><li>-x 从备份文件中还原文件。</li></ul>          </div><h3><span id="使用密码">使用密码</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 将当前目录下的files文件夹打包压缩，密码为password</span><br><span class="hljs-comment"># -iter 10000参数来指定迭代次数为10000次。这将提高密钥派生的强度，增加加密的安全性。</span><br>tar -czvf - files | openssl des3 -salt -k password  -iter 10000 -out files.tar.gz<br><br><span class="hljs-comment"># 将当前目录下的files.tar.gz进行解密解压</span><br>openssl des3 -d -salt -k password -iter 10000 -<span class="hljs-keyword">in</span> files.tar.gz | tar -xzf -<br></code></pre></td></tr></table></figure><h3><span id="分割文件">分割文件</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 分割</span><br><span class="hljs-built_in">split</span> -b 1M file.tar.gz file_bakcup.<br><br><span class="hljs-comment"># 合并</span><br><span class="hljs-built_in">cat</span> file_backup* &gt; file.tar.gz<br></code></pre></td></tr></table></figure><h2><span id="软-硬链接">软、硬链接</span></h2><p>删除源文件，硬链接没有影响，软链接不可用。</p><h3><span id="软链接">软链接</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ln</span> -s README.md README.soft.md<br></code></pre></td></tr></table></figure><h3><span id="硬链接">硬链接</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">ln</span> README.md README.hard.md<br></code></pre></td></tr></table></figure><h2><span id="dd">dd</span></h2><p>生成100M文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=file_100M bs=1M count=100<br></code></pre></td></tr></table></figure><p>随机生成1百万个1K的文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=100M bs=1M count=100<br></code></pre></td></tr></table></figure><h2><span id="内存-cpu-io">内存、cpu、io</span></h2><h3><span id="内存">内存</span></h3><ol><li>输入 <code>top</code> 命令，按下 <code>M</code> 键可以按照内存使用量进行排序。</li><li>查看内存使用最多的5个进程</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps aux --<span class="hljs-built_in">sort</span>=-%mem | <span class="hljs-built_in">head</span> -n 6<br></code></pre></td></tr></table></figure><h4><span id="查看指定进程内存占用">查看指定进程内存占用</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps -o rss= -p &lt;pid&gt;<br></code></pre></td></tr></table></figure><h3><span id="cpu">CPU</span></h3><ol><li>输入 <code>top</code> 命令，按下 <code>P</code> 键可以按照内存使用量进行排序。</li><li>查看CPU使用最多的5个进程</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -n 6<br></code></pre></td></tr></table></figure><h3><span id="io">IO</span></h3><div class="note note-warning">            <p>请注意，<code>iotop</code> 和 <code>pidstat</code> 可能需要先安装，在终端输入以下命令可以安装它们：</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># centos</span><br>yum -y install iotop<br><br><span class="hljs-comment"># ubuntu</span><br>apt-get install iotop sysstat<br></code></pre></td></tr></table></figure><h4><span id="iotop">iotop</span></h4><span class="label label-primary">iotop</span> 命令可以 <span class="label label-danger">实时</span> 显示系统中进程的磁盘IO使用情况。打开终端并输入 iotop 命令，然后按下O键可以按照IO使用量进行排序。按q可以退出iotop 命令<h4><span id="pidstat">pidstat</span></h4><span class="label label-success">pidstat</span> 命令可以显示特定进程的IO使用情况。输入以下命令来查看IO使用最多的5个进程：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">pidstat -d | <span class="hljs-built_in">sort</span> -nrk 2 | <span class="hljs-built_in">head</span> -n 6<br></code></pre></td></tr></table></figure><h4><span id="iostat">iostat</span></h4><span class="label label-primary">iostat</span> 命令可以提供关于系统设备和分区的IO统计信息。输入以下命令来查看整个系统的IO情况：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 瞬时数据</span><br>iostat -d<br><br><span class="hljs-comment"># 每隔5s采样一次</span><br>iostat -d -t 5<br><br><span class="hljs-comment"># 输出</span><br>Linux 4.19.xxx.x86_64 (10-11-xx-xx) 202x年0x月1x日 _x86_64_(2 CPU)<br><br>Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn<br>vda               2.70        19.13        36.54  102409528  195610326<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>设备名称：显示连接到系统的硬盘和存储设备的设备名称。</p><p>tps（Transactions Per Second）：每秒处理的 I&#x2F;O 事务数。</p><p>kB_read&#x2F;s 和 kB_wrtn&#x2F;s：每秒从设备读取和写入的数据量（以 KB 为单位）。</p><p>kB_read 和 kB_wrtn：自系统启动以来已经读取和写入的总数据量（以 KB 为单位）。</p><p>kB_read&#x2F;s 和 kB_wrtn&#x2F;s：每秒从设备读取和写入的数据量（以 KB 为单位）。</p><p>svctm（Service Time）：每个 I&#x2F;O 操作花费的平均时间。</p><p>%util：设备使用率的百分比，即设备每秒钟的 I&#x2F;O 请求占总容量的百分比。</p>          </div><h2><span id="top">top</span></h2><h3><span id="前五行">前五行</span></h3><p><img src="top-01.png" alt="Alt text"></p><h4><span id="1-输出系统任务队列信息">1. 输出系统任务队列信息</span></h4><div class="note note-warning">            <p><strong>10:38:45</strong>：系统当前时间<br><strong>up 2days 18:57</strong>：系统开机后到现在的总运行时间<br><strong>1 user</strong>：当前登录用户数<br><strong>load average</strong>: 0.10, 0.12, 0.09：系统负载，系统运行队列的平均利用率，可认为是可运行进程的平均数；三个数值分别为 1分钟、5分钟、15分钟前到现在的平均值；单核CPU中load average的值&#x3D;1时表示满负荷状态，多核CPU中4代表4核满负荷状态。</p>          </div><h4><span id="2-任务进程信息">2. 任务进程信息</span></h4><div class="note note-warning">            <p><strong>total</strong>：系统全部进程的数量<br><strong>running</strong>：运行状态的进程数量<br><strong>sleeping</strong>：睡眠状态的进程数量<br><strong>stoped</strong>：停止状态的进程数量<br><strong>zombie</strong>：僵尸进程数量</p>          </div><h4><span id="3-cpu信息">3. CPU信息</span></h4><div class="note note-warning">            <p><strong>us</strong>：用户空间占用CPU百分比<br><strong>sy</strong>：内核空间占用CPU百分比<br><strong>ni</strong>：已调整优先级的用户进程的CPU百分比<br><strong>id</strong>：空闲CPU百分比，越低说明CPU使用率越高<br><strong>wa</strong>：等待IO完成的CPU百分比<br><strong>hi</strong>：处理硬件中断的占用CPU百分比<br><strong>si</strong>：处理软中断占用CPU百分比<br><strong>st</strong>：虚拟机占用CPU百分比</p>          </div><h4><span id="4-物理内存信息">4. 物理内存信息</span></h4><div class="note note-warning">            <p>以下内存单位均为MB</p><p>在 top 命令界面上，可以按下 e 键来进入设置界面，然后按下 E 键来切换内存单位为 GB。你可以在 top 的设置界面中选择其他显示选项，按需进行更改。</p><p>在设置界面中，你也可以使用 W 命令将当前的设置保存为个人配置文件，以便下次启动 top 时自动应用这些设置。</p><p><strong>total</strong>：物理内存总量<br><strong>free</strong>：空闲内存总量<br><strong>used</strong>：使用中内存总量<br><strong>buff&#x2F;cache</strong>：用于内核缓存的内存量</p>          </div><h4><span id="5-交互区内存信息">5. 交互区内存信息</span></h4><p>swap 分区通常被称为交换分区，这是一块特殊的硬盘空间，即当实际内存不够用的时候，操作系统会从内存中取出一部分暂时不用的数据，放在交换分区中，从而为当前运行的程序腾出足够的内存空间。</p><div class="note note-warning">            <p><strong>total</strong>：交换区总量<br><strong>free</strong>：空闲交换区总量<br><strong>used</strong>：使用的交换区总量<br><strong>avail Mem</strong>：可用交换区总量</p>          </div><h3><span id="进程列表">进程列表</span></h3><p><img src="top-02.png" alt="进程列表"></p><div class="note note-warning">            <p><strong>PID</strong>：进程号<br><strong>USER</strong>：运行进程的用户<br><strong>PR</strong>：优先级<br><strong>NI</strong>：nice值。负值表示高优先级，正值表示低优先级<br><strong>VIRT</strong>：占用虚拟内存，单位kb。VIRT&#x3D;SWAP+RES<br><strong>RES</strong>：占用真实内存，单位kb<br><strong>SHR</strong>：共享内存大小，单位kb<br><strong>S</strong>：进程状态（I&#x3D;空闲状态，R&#x3D;运行状态，S&#x3D;睡眠状态，D&#x3D;不可中断的睡眠状态，T&#x3D;跟踪&#x2F;停止，Z&#x3D;僵尸进程）<br><strong>%CPU</strong>：占用CPU百分比<br><strong>%MEM</strong>：占用内存百分比<br>**TIME+**：上次启动后至今的总运行时间<br><strong>COMMAND</strong>：命令名or命令行</p>          </div><h3><span id="使用方法">使用方法</span></h3><h4><span id="更换内存单位">更换内存单位</span></h4><div class="note note-warning">            <p>在 top 命令界面上，可以按下 e 键来进入设置界面，然后按下 E 键来切换内存单位为 GB。你可以在 top 的设置界面中选择其他显示选项，按需进行更改。</p><p>在设置界面中，你也可以使用 W 命令将当前的设置保存为个人配置文件，以便下次启动 top 时自动应用这些设置。</p>          </div><h2><span id="磁盘">磁盘</span></h2><h3><span id="du">du</span></h3><div class="note note-warning">            <p>直接输入 du 没有加任何选项时，则 du 会分析当前所在目录里的子目录所占用的硬盘空间。</p>          </div><p>选项与参数：</p><p>-a ：列出所有的文件与目录容量，因为默认仅统计目录底下的文件量而已。<br>-h ：以人们较易读的容量格式 (G&#x2F;M) 显示；<br>-s ：列出总占用量；<br>-S ：不包括子目录下的总计，与 -s 有点差别。<br>-k ：以 KBytes 列出容量显示；<br>-m ：以 MBytes 列出容量显示；</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 查看指定目录</span><br><span class="hljs-built_in">du</span> -sh .<br>3.8G.<br><span class="hljs-comment"># ====================================</span><br><br><span class="hljs-comment"># 查看指定目录下的所有文件大小，深度为1</span><br><span class="hljs-built_in">du</span> -h <span class="hljs-variable">$DIR</span> --max-depth=1 | <span class="hljs-built_in">sort</span> -h<br><br><span class="hljs-comment"># 部分输出</span><br>...<br>388M./k3s<br>570M./.npm<br>1.4G./CAI.bak<br>3.8G.<br><br><span class="hljs-comment"># ====================================</span><br><span class="hljs-comment"># 参数解析</span><br><span class="hljs-comment"># --max-depth 深度</span><br><span class="hljs-comment"># sort -h 从小到大排序</span><br><span class="hljs-comment"># sort -rh 从大到小排序</span><br></code></pre></td></tr></table></figure><h4><span id></span></h4><h3><span id="df">df</span></h3><p>显示系统中每个文件系统的磁盘使用情况</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">df</span> -h<br></code></pre></td></tr></table></figure><h3><span id="lsblk">lsblk</span></h3><p>显示系统中所有的块设备，包括硬盘和分区。通常，系统盘的挂载点是根目录 &#x2F;，而数据盘则可能挂载在其他目录上，如&#x2F;home、&#x2F;mnt等。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">lsblk<br></code></pre></td></tr></table></figure><p>显示所有在启动时挂载的文件系统，包括系统盘和数据盘的信息。一般情况下，系统盘的挂载信息会在此文件中。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> /etc/fstab<br></code></pre></td></tr></table></figure><h3><span id="fdisk">fdisk</span></h3><p>列出所有分区信息</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdisk<br></code></pre></td></tr></table></figure><h3><span id="mount">mount</span></h3><div class="note note-warning">            <p>目的：向linux系统新增一块硬盘，并挂载到指定目录。</p>          </div><ol><li>进入设备分区</li></ol><p>lsblk 查看对应的磁盘名称，比如为 vdb。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">fdisk /dev/vdb<br></code></pre></td></tr></table></figure><ol start="2"><li><p>进入交互终端后，使用 n 命令创建新分区。根据提示，选择主分区类型（p）。</p></li><li><p>提供分区号。</p></li><li><p>提供新分区的结束位置。输入 +250G 以指定分区大小为250GB。默认为全部。</p></li><li><p>使用 p 命令确认分区表是否正确。</p></li><li><p>使用 w 命令保存新的分区表。</p></li><li><p>格式化分区</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">mkfs.ext4 /dev/vdb1<br>mkfs.ext4 /dev/vdb2<br></code></pre></td></tr></table></figure><ol start="8"><li>创建两个挂载点。运行以下命令：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo <span class="hljs-built_in">mkdir</span> /mnt/partition1<br>sudo <span class="hljs-built_in">mkdir</span> /mnt/partition2<br></code></pre></td></tr></table></figure><ol start="9"><li>挂载分区</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo mount /dev/vdb1 /mnt/partition1<br>sudo mount /dev/vdb2 /mnt/partition2<br></code></pre></td></tr></table></figure><ol start="10"><li>开机自动挂载</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/fstab<br><br>/dev/vdb1   /mnt/partition1   ext4   defaults   0   0<br>/dev/vdb2   /mnt/partition2   ext4   defaults   0   0<br></code></pre></td></tr></table></figure><h2><span id="命令行快捷键">命令行快捷键</span></h2><div class="note note-warning">            <p>请注意，某些快捷键可能会因终端和操作系统的不同而有所差异。</p>          </div><table><thead><tr><th>快捷键</th><th>操作</th></tr></thead><tbody><tr><td>Ctrl + 左右键</td><td>在单词之间跳转</td></tr><tr><td>Ctrl + a</td><td>跳到本行的行首</td></tr><tr><td>Ctrl + e</td><td>跳到页尾</td></tr><tr><td>Ctrl + u</td><td>删除当前光标前面的文字 （还有剪切功能）</td></tr><tr><td>Ctrl + k</td><td>删除当前光标后面的文字 （还有剪切功能）</td></tr><tr><td>Ctrl + L</td><td>进行清屏操作</td></tr><tr><td>Ctrl + y</td><td>粘贴 Ctrl+u 或 Ctrl+k 剪切的内容</td></tr><tr><td>Ctrl + w</td><td>删除光标前面的单词的字符（以空格隔开的字符串）</td></tr><tr><td>Alt + d</td><td>由光标位置开始，往右删除单词，往行尾删</td></tr><tr><td>Ctrl + r</td><td>搜索执行过的命令</td></tr><tr><td>! + 字符</td><td>快速执行最近执行过的命令，其中包含该字符</td></tr><tr><td>history</td><td>显示部分历史命令</td></tr></tbody></table><h1><span id="2-网络管理">2. 网络管理</span></h1><h2><span id="端口查看">端口查看</span></h2><h3><span id="netstat">netstat</span></h3><div class="note note-success">            <p>netstat、lsof、nmap可能漏掉某些端口，最直接的就是使用 curl 或者 telnet。</p>          </div><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">netstat -nplt<br></code></pre></td></tr></table></figure><p>参数说明:</p><div class="note note-warning">            <p>-n 将字母转化为数字</p><p>-p 显示进程相关信息</p><p>-l 列出状态为监听</p><p>-t 只查看tcp协议</p><p>-a 查看全部协议(netstat -an)</p>          </div><h3><span id="lsof">lsof</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">lsof -i :30001<br></code></pre></td></tr></table></figure><h3><span id="telnet">telnet</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">telnet 127.0.0.1 30001<br></code></pre></td></tr></table></figure><h2><span id="路由">路由</span></h2><p><strong>查看默认路由表信息</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip r<br>ip -6 r<br>route<br></code></pre></td></tr></table></figure><p><strong>查看路由表信息</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip rule<br>ip -6 rule <br>ip rule list<br></code></pre></td></tr></table></figure><p><strong>查看走哪条路由</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ip route get 8.8.8.8<br></code></pre></td></tr></table></figure><p><strong>路由追踪</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">traceroute 8.8.8.8<br></code></pre></td></tr></table></figure><h2><span id="网速测试">网速测试</span></h2><p><strong>安装</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo yum - y install speedtest-cli<br><br>sudo apt install speedtest-cli<br><br>sudo pip3 install speedtest-cli<br></code></pre></td></tr></table></figure><p><strong>执行 speedtest-cli</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ speedtest-cli<br>Retrieving speedtest.net configuration...<br>Testing from Unknown (165.154.145.190)...<br>Retrieving speedtest.net server list...<br>Selecting best server based on ping...<br>Hosted by Enzu.com (Los Angeles, CA) [11654.37 km]: 3.173 ms<br>Testing download speed................................................................................<br>Download: 56.57 Mbit/s<br>Testing upload speed......................................................................................................<br>Upload: 34.54 Mbit/s<br></code></pre></td></tr></table></figure><div class="note note-warning">            <ul><li>MB：字节</li><li>Mbit：比特</li></ul><p>1 字节 &#x3D; 8 bit，所以 1MB&#x2F;s &#x3D; 8Mbit&#x2F;s。</p><p>下载网速为 1MB&#x2F;s ，这里指的是网速每秒可以下载1M。</p>          </div><h2><span id="快速开启http服务">快速开启http服务</span></h2><p>这将监听本地 80 端口，响应 OK</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&#x27;HTTP/1.1 200 OK\r\n\r\nOK&#x27;</span> | sudo socat - TCP-LISTEN:80<br></code></pre></td></tr></table></figure><h1><span id="3-进程管理">3. 进程管理</span></h1><h1><span id="4-系统管理">4. 系统管理</span></h1><h2><span id="cronjob-定时任务">cronjob 定时任务</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># crontab -e 命令以编辑当前用户的cron表。</span><br>crontab -e<br><br><span class="hljs-comment"># 每分钟执行一次 ls</span><br>*/1 * * * * <span class="hljs-built_in">ls</span><br></code></pre></td></tr></table></figure><p><strong>查看日志</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">tail</span> -f /var/spool/mail/root<br></code></pre></td></tr></table></figure><h1><span id="5-安全性">5. 安全性</span></h1><h2><span id="更换密码">更换密码</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">passwd<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git使用指南</title>
    <link href="/2023/08/16/%E5%B7%A5%E5%85%B7/git%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"/>
    <url>/2023/08/16/%E5%B7%A5%E5%85%B7/git%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>git 不仅仅是 pull 和 push。</p>          </div><span id="more"></span><h2><span id="1-一键提交当前分支">1. 一键提交当前分支</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git add .;git commit -m <span class="hljs-string">&quot;test&quot;</span>;git push origin $(git symbolic-ref --short HEAD)<br></code></pre></td></tr></table></figure><h2><span id="2-删除分支">2. 删除分支</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 删除本地分支</span><br>git branch -D xxx<br><br><span class="hljs-comment"># 删除远程分支</span><br>git push origin --delete xxx<br></code></pre></td></tr></table></figure><h2><span id="3-开发分支落后时如何同步-master-分支">3. 开发分支落后时，如何同步 master 分支。</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 1. 获取master分支的最新变更。可以使用以下命令来更新您本地的master分支</span><br>git checkout master<br>git pull origin master<br><br><span class="hljs-comment"># 2. 切换回开发分支，并将master分支的变更合并到开发分支上：</span><br>git checkout feature/test<br>git merge master<br><br><span class="hljs-comment"># 3. 如果有冲突出现，您需要解决这些冲突后再提交变更。</span><br><br><span class="hljs-comment"># 4. 推送开发分支到远程仓库</span><br>git push origin feature/test<br></code></pre></td></tr></table></figure><h2><span id="4-git-reset">4. git reset</span></h2><p>放弃所有更改并回到上一次提交的状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git reset --hard HEAD^<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>这将删除所有的未提交更改，将HEAD指向父提交，并将工作区和暂存区恢复到上一次提交的状态。</p>          </div><p>保留更改但将其从暂存区中移除：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">git reset HEAD<br></code></pre></td></tr></table></figure><p>这将将所有已暂存的更改重置，但保留在工作区中，这样你就可以重新提交或进行进一步的更改。</p><div class="note note-warning">            <p>请注意，git reset 是一个潜在的危险操作，因为它会从版本历史中移除提交。在执行这些命令之前，请确保你理解这些操作的副作用，并且在对你的代码产生重大影响之前，最好进行备份或咨询团队中的其他成员。</p>          </div><h2><span id="5-git-stash">5. git stash</span></h2><p><code>git stash</code> 是一个Git命令，用于将当前未提交的修改保存为一个临时的存储状态，以便你可以切换到其他分支或执行其他操作。</p><div class="note note-warning">            <p>当你在进行代码开发时，可能会遇到以下情况之一：</p><p>你正在一个分支上进行开发，但突然需要切换到另一个分支上处理紧急修复或其他任务。<br>你正在进行一些尝试性的修改，但暂时不想提交它们。<br>在这些情况下，你可以使用 git stash 命令将当前的修改保存起来，以便稍后恢复。</p>          </div><p>使用 <code>git stash</code> 命令时，Git会将未提交的修改保存为一个堆栈（stack），每次调用 <code>git stash</code> 都会将当前的修改添加到堆栈的栈顶。可以使用 <code>git stash list</code> 命令查看当前所有的存储状态。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 将当前的未提交修改保存为一个新的存储状态。</span><br>git stash<br><br><span class="hljs-comment"># 恢复保存的修改</span><br>git stash apply<br><br><span class="hljs-comment"># 查看所有状态</span><br>git stash list<br><br><span class="hljs-comment"># 恢复特定的存储状态</span><br>git stash apply stash@&#123;number&#125;<br><br><span class="hljs-comment"># 删除存储状态</span><br>git stash drop<br><br><span class="hljs-comment"># 可以给存储状态添加一个描述</span><br>git stash save<br><br><span class="hljs-comment"># 可以直接将保存的修改应用到一个新的分支上</span><br>git stash branch<br><br><span class="hljs-comment"># 命令查看所有可用的选项和详细的说明</span><br>git stash --<span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nas整理</title>
    <link href="/2023/08/08/linux/nas%E6%95%B4%E7%90%86/"/>
    <url>/2023/08/08/linux/nas%E6%95%B4%E7%90%86/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>目前使用该脚本来将 alist 中某个项目下的文件由 xx.1.xx 改为 xx.01.xx</p>          </div><span id="more"></span><h2><span id="重命名">重命名</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">dir</span>=<span class="hljs-variable">$1</span>  <span class="hljs-comment"># 指定目录路径</span><br><br><span class="hljs-comment"># 进入目录</span><br><span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$dir</span>&quot;</span> || <span class="hljs-built_in">exit</span><br><br><span class="hljs-comment"># 替换文件名中的abcd1至abcd9为abcd01至abcd09</span><br><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> *S01E[1-9].*; <span class="hljs-keyword">do</span><br>  new_file=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span> | sed <span class="hljs-string">&#x27;s/S01E\([1-9]\)/S01E0\1/&#x27;</span>)<br>  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$new_file</span><br>  <span class="hljs-built_in">mv</span> <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$new_file</span>&quot;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2><span id="备份">备份</span></h2><h3><span id="alist脚本">alist脚本</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># demo: bash tar.sh test test.tar.gz /local/data /百度网盘/数据冷备 http://localhost:5244 &lt;alist-token&gt;</span><br><br><span class="hljs-comment"># 判断参数个数是否为7个</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 7 ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Error: Expected 7 arguments.&quot;</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$0</span> &lt;filename&gt; &lt;src&gt; &lt;dst&gt; &lt;alist_host&gt; &lt;alist_token&gt;&quot;</span><br>  <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br>FILE_PATH=<span class="hljs-variable">$1</span><br>FILE_NAME_TAR_GZ=<span class="hljs-variable">$2</span><br><span class="hljs-comment"># 使用awk命令分割字符串并输出最后一个部分</span><br>FILE_NAME=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$FILE_PATH</span> | awk -F<span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span>)<br>ALIST_SRC=<span class="hljs-variable">$3</span><br>ALIST_DST=<span class="hljs-variable">$4</span><br>ALIST_HOST=<span class="hljs-variable">$5</span><br>ALIST_DATA_DIR=<span class="hljs-variable">$6</span><br>ALIST_TOKEN=<span class="hljs-variable">$7</span><br><br><span class="hljs-keyword">if</span> [ ! -e <span class="hljs-variable">$FILE_PATH</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;文件不存在&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 以下是你希望执行的操作，当参数个数为三个时执行</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;文件名: <span class="hljs-variable">$FILE_NAME</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;打包文件名: <span class="hljs-variable">$FILE_NAME_TAR_GZ</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Alist src: <span class="hljs-variable">$ALIST_SRC</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Alist dst: <span class="hljs-variable">$ALIST_DST</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Alist Host: <span class="hljs-variable">$ALIST_HOST</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Alist Data dir: <span class="hljs-variable">$ALIST_DATA_DIR</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Alist Token: <span class="hljs-variable">$ALIST_TOKEN</span>&quot;</span><br><br><span class="hljs-comment"># TIME=$(date +&quot;%Y-%m-%d-%H%M&quot;)</span><br><span class="hljs-comment"># echo 当前时间: $TIME</span><br><span class="hljs-comment"># FILE_NAME_TAR_GZ=&quot;$&#123;TIME&#125;-$&#123;FILE_NAME&#125;.tar.gz&quot;</span><br><br><span class="hljs-built_in">echo</span> 备份文件名: <span class="hljs-variable">$FILE_NAME_TAR_GZ</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;undone&quot;</span> &gt; /root/tar_status.txt<br><br><span class="hljs-comment"># tar -czf $/&#123;ALIST_DATA_DIR&#125;/$&#123;FILE_NAME_TAR_GZ&#125; $FILE_PATH</span><br>tar -cjf <span class="hljs-variable">$&#123;ALIST_DATA_DIR&#125;</span>/<span class="hljs-variable">$&#123;FILE_NAME_TAR_GZ&#125;</span> <span class="hljs-variable">$FILE_PATH</span><br><br>curl <span class="hljs-string">&quot;<span class="hljs-variable">$ALIST_HOST</span>/api/fs/copy&quot;</span> \<br>  -H <span class="hljs-string">&#x27;Accept: application/json, text/plain, */*&#x27;</span> \<br>  -H <span class="hljs-string">&quot;Authorization: <span class="hljs-variable">$ALIST_TOKEN</span>&quot;</span> \<br>  -H <span class="hljs-string">&#x27;Connection: keep-alive&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;Content-Type: application/json;charset=UTF-8&#x27;</span> \<br>  -H <span class="hljs-string">&quot;Origin: <span class="hljs-variable">$ALIST_HOST</span>&quot;</span> \<br>  -H <span class="hljs-string">&quot;Referer: <span class="hljs-variable">$ALIST_HOST</span>/local/data&quot;</span> \<br>  -H <span class="hljs-string">&#x27;Sec-Fetch-Dest: empty&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;Sec-Fetch-Mode: cors&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;Sec-Fetch-Site: same-origin&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;sec-ch-ua: &quot;Not/A)Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;115&quot;, &quot;Chromium&quot;;v=&quot;115&quot;&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;sec-ch-ua-mobile: ?0&#x27;</span> \<br>  -H <span class="hljs-string">&#x27;sec-ch-ua-platform: &quot;macOS&quot;&#x27;</span> \<br>  --data-raw <span class="hljs-string">&#x27;&#123;&quot;src_dir&quot;:&quot;&#x27;</span><span class="hljs-string">&quot;<span class="hljs-variable">$ALIST_SRC</span>&quot;</span><span class="hljs-string">&#x27;&quot;,&quot;dst_dir&quot;:&quot;&#x27;</span><span class="hljs-string">&quot;<span class="hljs-variable">$ALIST_DST</span>&quot;</span><span class="hljs-string">&#x27;&quot;,&quot;names&quot;:[&quot;&#x27;</span><span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME_TAR_GZ</span>&quot;</span><span class="hljs-string">&#x27;&quot;]&#125;&#x27;</span> \<br>  --compressed<br><br><span class="hljs-built_in">sleep</span> 10<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;done&quot;</span> &gt; /root/tar_status.txt<br></code></pre></td></tr></table></figure><h3><span id="压缩">压缩</span></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;encoding/json&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;io&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;os/exec&quot;</span><br><span class="hljs-string">&quot;path&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;github.com/robfig/cron&quot;</span><br><span class="hljs-string">&quot;gopkg.in/yaml.v2&quot;</span><br><span class="hljs-string">&quot;k8s.io/klog/v2&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>Alist <span class="hljs-keyword">struct</span> &#123;<br>Host    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;host&quot;`</span><br>DataDir <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;data_dir&quot;`</span><br>Token   <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;token&quot;`</span><br>&#125; <span class="hljs-string">`yaml:&quot;alist&quot;`</span><br><br>CronTime         <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;cron_time&quot;`</span><br>TarShellFilePath <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;tar_shell_filepath&quot;`</span><br><br>Clouds []<span class="hljs-keyword">struct</span> &#123;<br>Name      <span class="hljs-type">string</span>   <span class="hljs-string">`yaml:&quot;name&quot;`</span><br>Backup    <span class="hljs-type">bool</span>     <span class="hljs-string">`yaml:&quot;backup&quot;`</span><br>AlistSrc  <span class="hljs-type">string</span>   <span class="hljs-string">`yaml:&quot;alist_src&quot;`</span><br>AlistDst  <span class="hljs-type">string</span>   <span class="hljs-string">`yaml:&quot;alist_dst&quot;`</span><br>FilePaths []<span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;filepaths&quot;`</span><br>&#125; <span class="hljs-string">`yaml:&quot;clouds&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> RequestAlistUndone <span class="hljs-keyword">struct</span> &#123;<br>Code    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;code&quot;`</span><br>Message <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;message&quot;`</span><br>Data    []<span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>&#125; <span class="hljs-string">`json:&quot;data&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := initConfig()<br><br>klog.Info(<span class="hljs-string">&quot;checking... &quot;</span>)<br>c.Check()<br><br><span class="hljs-keyword">var</span> tarfilepath []<span class="hljs-type">string</span><br>tarfilename := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)<br><br>backup := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>klog.Info(<span class="hljs-string">&quot;start backuping... &quot;</span>)<br><span class="hljs-keyword">for</span> _, cloud := <span class="hljs-keyword">range</span> c.Clouds &#123;<br><span class="hljs-keyword">if</span> !cloud.Backup &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">for</span> _, filepath := <span class="hljs-keyword">range</span> cloud.FilePaths &#123;<br>startTime := time.Now()<br><span class="hljs-keyword">var</span> tarfile <span class="hljs-type">string</span><br><span class="hljs-keyword">if</span> tarfilename[filepath] == <span class="hljs-string">&quot;&quot;</span> &#123;<br>tarfile = getTarfile(filepath)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>tarfile = tarfilename[filepath]<br>&#125;<br><br>klog.Infof(<span class="hljs-string">&quot;tarfile is %v&quot;</span>, tarfile)<br><span class="hljs-keyword">if</span> err := run(c.TarShellFilePath, filepath, tarfile, cloud.AlistSrc, cloud.AlistDst, c.Alist.Host, c.Alist.DataDir, c.Alist.Token); err != <span class="hljs-literal">nil</span> &#123;<br>klog.Errorf(<span class="hljs-string">&quot;[%v]: backup %v failed, %v&quot;</span>, cloud.Name, tarfile, err)<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// wait alist task done</span><br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(<span class="hljs-number">5</span> * time.Second)<br><span class="hljs-keyword">if</span> c.TaskDone() &amp;&amp; c.TarDone() &#123;<br>klog.Infof(<span class="hljs-string">&quot;[%v]: backup %v success %v\n&quot;</span>, cloud.Name, tarfile, time.Since(startTime))<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>tarfilepath = <span class="hljs-built_in">append</span>(tarfilepath, path.Join(c.Alist.DataDir, tarfile))<br>tarfilename[filepath] = tarfile<br>&#125;<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;\n&quot;</span>)<br>&#125;<br><br>remove := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> _, tarfile := <span class="hljs-keyword">range</span> tarfilepath &#123;<br><span class="hljs-keyword">if</span> err := os.Remove(path.Join(c.Alist.DataDir, tarfile)); err != <span class="hljs-literal">nil</span> &#123;<br>klog.Warningf(<span class="hljs-string">&quot;delete %v failed&quot;</span>, tarfile)<br>&#125;<br>&#125;<br><span class="hljs-comment">// reset</span><br>tarfilepath = []<span class="hljs-type">string</span>&#123;&#125;<br>tarfilename = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)<br>&#125;<br><br>cronjob := cron.New()<br><br>cronjob.AddFunc(c.CronTime, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> c.TaskDone() &#123;<br>backup()<br>remove()<br>&#125;<br>&#125;)<br><br>cronjob.Start()<br><br>stopCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>&lt;-stopCh<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">run</span><span class="hljs-params">(shellPath, filePath, tarfile, alistSrc, alistDst, alistHost, alistDataDir, alistToken <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>klog.Info([]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;sh&quot;</span>, shellPath, filePath, tarfile, alistSrc, alistDst, alistHost, alistDataDir, alistToken&#125;)<br><br>cmd := exec.Command(<span class="hljs-string">&quot;sh&quot;</span>, shellPath, filePath, tarfile, alistSrc, alistDst, alistHost, alistDataDir, alistToken)<br>_, err := cmd.Output()<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Config)</span></span> Check() &#123;<br><span class="hljs-keyword">if</span> c.Alist.Host == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;empty alist host&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">if</span> c.Alist.DataDir == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;empty alist data dir&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">if</span> c.Alist.Token == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;empty alist token&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> c.CronTime == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;empty cron time&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, cloud := <span class="hljs-keyword">range</span> c.Clouds &#123;<br><span class="hljs-keyword">if</span> !cloud.Backup &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> cloud.AlistSrc == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;empty alist %v src&quot;</span>, cloud.Name))<br>&#125;<br><span class="hljs-keyword">if</span> cloud.AlistDst == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;empty alist %v dst&quot;</span>, cloud.Name))<br>&#125;<br><br><span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> cloud.FilePaths &#123;<br>_, err := os.Stat(v)<br><span class="hljs-keyword">if</span> os.IsNotExist(err) &#123;<br><span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;%v %v file not exist&quot;</span>, cloud.Name, v))<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initConfig</span><span class="hljs-params">()</span></span> *Config &#123;<br>yamlFile, err := os.ReadFile(<span class="hljs-string">&quot;./config.yaml&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br>config := Config&#123;&#125;<br><span class="hljs-keyword">if</span> err := yaml.Unmarshal(yamlFile, &amp;config); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><span class="hljs-keyword">return</span> &amp;config<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Config)</span></span> TarDone() <span class="hljs-type">bool</span> &#123;<br>b, err := os.ReadFile(<span class="hljs-string">&quot;/root/tar_status.txt&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>klog.Error(err)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(b) == <span class="hljs-string">&quot;done&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Config)</span></span> TaskDone() <span class="hljs-type">bool</span> &#123;<br>req, err := http.NewRequest(<span class="hljs-string">&quot;GET&quot;</span>, fmt.Sprintf(<span class="hljs-string">&quot;%v/api/admin/task/copy/undone&quot;</span>, c.Alist.Host), <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>klog.Error(err)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>req.Header.Set(<span class="hljs-string">&quot;Authorization&quot;</span>, c.Alist.Token)<br><br>resp, err := http.DefaultClient.Do(req)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>klog.Error(err)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">defer</span> resp.Body.Close()<br><br>body, err := io.ReadAll(resp.Body)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>klog.Error(err)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br>response := RequestAlistUndone&#123;&#125;<br><span class="hljs-keyword">if</span> err := json.Unmarshal(body, &amp;response); err != <span class="hljs-literal">nil</span> &#123;<br>klog.Error(err)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> response.Code == <span class="hljs-number">200</span> &amp;&amp; <span class="hljs-built_in">len</span>(response.Data) == <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getTarfile</span><span class="hljs-params">(filepath <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>timelocal, err := time.LoadLocation(<span class="hljs-string">&quot;Asia/Shanghai&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>time.Local = timelocal<br>t := time.Now().Local().Format(<span class="hljs-string">&quot;2006-01-02_1504&quot;</span>)<br>filename := strings.Split(filepath, <span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-built_in">len</span>(strings.Split(filepath, <span class="hljs-string">&quot;/&quot;</span>))<span class="hljs-number">-1</span>]<br><span class="hljs-comment">// return fmt.Sprintf(&quot;%v-%v.tar.gz&quot;, t, filename)</span><br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%v-%v.tar.bz2&quot;</span>, t, filename)<br>&#125;<br></code></pre></td></tr></table></figure><h3><span id="配置">配置</span></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">alist:</span><br>  <span class="hljs-attr">data_dir:</span> <span class="hljs-string">&quot;/alist-data&quot;</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-string">&quot;http://192.xxx.187.61:5244&quot;</span><br>  <span class="hljs-attr">token:</span> <span class="hljs-string">&quot;alist-e5630ef4-5fa2-4264-a256-323900236728&quot;</span><br><br><span class="hljs-attr">cron_time:</span> <span class="hljs-string">&quot;0 40 18 * *&quot;</span><br><span class="hljs-attr">tar_shell_filepath:</span> <span class="hljs-string">&quot;/root/tar.sh&quot;</span><br><br><span class="hljs-attr">clouds:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">阿里云盘</span><br>    <span class="hljs-attr">backup:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">alist_src:</span> <span class="hljs-string">&quot;/本地/opt/alist/data&quot;</span> <span class="hljs-comment"># 本地local盘</span><br>    <span class="hljs-attr">alist_dst:</span> <span class="hljs-string">&quot;/阿里云盘/数据冷备&quot;</span>     <span class="hljs-comment"># 本地阿里盘</span><br>    <span class="hljs-attr">filepaths:</span>                       <span class="hljs-comment"># 备份哪些文件</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/Users/Desktop/github/blog&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/Desktop/github/k3s&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">百度网盘</span><br>    <span class="hljs-attr">backup:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">alist_src:</span> <span class="hljs-string">&quot;/本地/opt/alist/data&quot;</span><br>    <span class="hljs-attr">alist_dst:</span> <span class="hljs-string">&quot;/百度网盘/数据冷备&quot;</span><br>    <span class="hljs-attr">filepaths:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/data/歌曲&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nas</tag>
      
      <tag>shell</tag>
      
      <tag>alist</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>buildx构建多版本镜像</title>
    <link href="/2023/08/03/docker/buildx%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%89%88%E6%9C%AC%E9%95%9C%E5%83%8F/"/>
    <url>/2023/08/03/docker/buildx%E6%9E%84%E5%BB%BA%E5%A4%9A%E7%89%88%E6%9C%AC%E9%95%9C%E5%83%8F/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>目前大部分使用docker的场景中不单单只是 amd64 平台了有时我们需要再 arm 和 adm64 上都能运行</p>          </div><span id="more"></span><p><a href="http://blog.naturelr.cc/2023/06/16/%E4%BD%BF%E7%94%A8buildx%E7%BC%96%E8%AF%91%E5%A4%9A%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F/">参考资料</a></p><p>新版本的docker默认自带 buildx</p><h2><span id="1-创建buildx">1. 创建buildx</span></h2><h3><span id="11-查看当前buildx实例">1.1 查看当前buildx实例</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ docker buildx <span class="hljs-built_in">ls</span><br>NAME/NODE DRIVER/ENDPOINT STATUS  BUILDKIT PLATFORMS<br>default * docker<br>  default default         running 23.0.5   linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/386<br></code></pre></td></tr></table></figure><blockquote><p>默认会有个实例叫default，default实例下有一个default的node，一个实例下可以有多个node,星号是默认使用的实例,node有很多种类型</p></blockquote><h3><span id="12-创建buildx">1.2 创建buildx</span></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker buildx create --name all --node local --driver docker-container --platform linux/amd64,linux/arm64,linux/arm/v8 --use<br></code></pre></td></tr></table></figure><ul><li>使用这个实例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker buildx use all<br></code></pre></td></tr></table></figure><ul><li>当我们执行编译的时候会先下载buildx镜像并运行起来，然后使用这个容器运行的buildx来编译镜像</li></ul><h2><span id="2-编译">2. 编译</span></h2><p><strong>–platform执行要编译的平台，其他的参数和普通的build差不多</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 直接上传到仓库</span><br>docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t bearking0425/m3u8-downloader -o <span class="hljs-built_in">type</span>=registry .<br><br><span class="hljs-comment"># 输出本地</span><br>docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t bearking0425/m3u8-downloader -o <span class="hljs-built_in">type</span>=<span class="hljs-built_in">local</span>,dest=./output .<br><br><span class="hljs-comment"># tar包</span><br>docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t bearking0425/m3u8-downloader --output <span class="hljs-built_in">type</span>=tar,dest=./output.tar .<br><br><span class="hljs-comment"># 直接导入到本地 docker 中，只支持单平台架构</span><br>docker buildx build --platform linux/arm64 -t bearking0425/m3u8-downloader --load . <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>grpc如何使用</title>
    <link href="/2023/07/31/golang/grpc%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/"/>
    <url>/2023/07/31/golang/grpc%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>grpc 最基本的使用。</p>          </div><span id="more"></span><!-- toc --><pre><code class="hljs">  - [安装grpc](#安装grpc)  - [安装Protocol Buffers v3](#安装protocol-buffers-v3)  - [安装插件](#安装插件)</code></pre><ul><li><a href="#%E5%85%A5%E9%97%A8%E7%A4%BA%E4%BE%8B">入门示例</a><ul><li><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF">服务端</a><ul><li><a href="#%E7%BC%96%E5%86%99proto%E4%BB%A3%E7%A0%81">编写proto代码</a></li><li><a href="#%E7%BC%96%E5%86%99server%E7%AB%AFgo%E4%BB%A3%E7%A0%81">编写Server端Go代码</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84">代码结构</a></li><li><a href="#%E8%BF%90%E8%A1%8C">运行</a></li></ul></li><li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF">客户端</a><ul><li><a href="#%E7%BC%96%E5%86%99proto%E4%BB%A3%E7%A0%81-1">编写proto代码</a></li><li><a href="#client-%E7%AB%AF%E4%BB%A3%E7%A0%81">client 端代码</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84-1">代码结构</a></li></ul></li><li><a href="#%E7%BB%93%E6%9E%9C">结果</a></li></ul></li></ul><!-- tocstop --><h4><span id="安装grpc">安装grpc</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">go get google.golang.org/grpc@latest<br></code></pre></td></tr></table></figure><h4><span id="安装protocol-buffers-v3">安装Protocol Buffers v3</span></h4><p>protoc <a href="https://github.com/google/protobuf/releases">下载</a></p><h4><span id="安装插件">安装插件</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28<br>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2<br></code></pre></td></tr></table></figure><h1><span id="入门示例">入门示例</span></h1><p><a href="https://github.com/oldwang12/grpc-demo">代码实现</a></p><h2><span id="服务端">服务端</span></h2><h4><span id="编写proto代码">编写proto代码</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt; pb/hello.proto</span><br><span class="hljs-string">syntax = &quot;proto3&quot;; // 版本声明，使用Protocol Buffers v3版本</span><br><span class="hljs-string"></span><br><span class="hljs-string">option go_package = &quot;server/pb&quot;;  // 指定生成的Go代码在你项目中的导入路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">package pb; // 包名</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">// 定义服务</span><br><span class="hljs-string">service Greeter &#123;</span><br><span class="hljs-string">    // SayHello 方法</span><br><span class="hljs-string">    rpc SayHello (HelloRequest) returns (HelloResponse) &#123;&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// 请求消息</span><br><span class="hljs-string">message HelloRequest &#123;</span><br><span class="hljs-string">    string name = 1;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// 响应消息</span><br><span class="hljs-string">message HelloResponse &#123;</span><br><span class="hljs-string">    string reply = 1;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><ul><li>执行命令：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative pb/hello.proto<br></code></pre></td></tr></table></figure></li></ul><h4><span id="编写server端go代码">编写Server端Go代码</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;hello_server/pb&quot;</span><br><span class="hljs-string">&quot;net&quot;</span><br><br><span class="hljs-string">&quot;google.golang.org/grpc&quot;</span><br>)<br><br><span class="hljs-comment">// hello server</span><br><br><span class="hljs-keyword">type</span> server <span class="hljs-keyword">struct</span> &#123;<br>pb.UnimplementedGreeterServer<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *server)</span></span> SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloResponse, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> &amp;pb.HelloResponse&#123;Reply: <span class="hljs-string">&quot;Hello &quot;</span> + in.Name&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// 监听本地的8972端口</span><br>lis, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:8972&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;failed to listen: %v&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>s := grpc.NewServer()                  <span class="hljs-comment">// 创建gRPC服务器</span><br>pb.RegisterGreeterServer(s, &amp;server&#123;&#125;) <span class="hljs-comment">// 在gRPC服务端注册服务</span><br><span class="hljs-comment">// 启动服务</span><br>err = s.Serve(lis)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;failed to serve: %v&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4><span id="代码结构">代码结构</span></h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">server<br>├── go<span class="hljs-selector-class">.mod</span><br>├── go<span class="hljs-selector-class">.sum</span><br>├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.go</span><br>└── pb<br>    ├── hello<span class="hljs-selector-class">.pb</span><span class="hljs-selector-class">.go</span><br>    ├── hello<span class="hljs-selector-class">.proto</span><br>    └── hello_grpc<span class="hljs-selector-class">.pb</span>.go<br></code></pre></td></tr></table></figure><h4><span id="运行">运行</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">go run main.go<br></code></pre></td></tr></table></figure><h2><span id="客户端">客户端</span></h2><h4><span id="编写proto代码">编写proto代码</span></h4><p>新建 client 项目</p><p>将 go_package 改为 “client&#x2F;db”</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt; pb/hello.proto</span><br><span class="hljs-string">syntax = &quot;proto3&quot;; // 版本声明，使用Protocol Buffers v3版本</span><br><span class="hljs-string"></span><br><span class="hljs-string">option go_package = &quot;client/pb&quot;;  // 指定生成的Go代码在你项目中的导入路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">package pb; // 包名</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">// 定义服务</span><br><span class="hljs-string">service Greeter &#123;</span><br><span class="hljs-string">    // SayHello 方法</span><br><span class="hljs-string">    rpc SayHello (HelloRequest) returns (HelloResponse) &#123;&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// 请求消息</span><br><span class="hljs-string">message HelloRequest &#123;</span><br><span class="hljs-string">    string name = 1;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// 响应消息</span><br><span class="hljs-string">message HelloResponse &#123;</span><br><span class="hljs-string">    string reply = 1;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><ul><li>执行命令<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative pb/hello.proto<br></code></pre></td></tr></table></figure></li></ul><h4><span id="client-端代码">client 端代码</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;flag&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;hello_client/pb&quot;</span><br><br><span class="hljs-string">&quot;google.golang.org/grpc&quot;</span><br><span class="hljs-string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span><br>)<br><br><span class="hljs-comment">// hello_client</span><br><br><span class="hljs-keyword">const</span> (<br>defaultName = <span class="hljs-string">&quot;world&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>addr = flag.String(<span class="hljs-string">&quot;addr&quot;</span>, <span class="hljs-string">&quot;127.0.0.1:8972&quot;</span>, <span class="hljs-string">&quot;the address to connect to&quot;</span>)<br>name = flag.String(<span class="hljs-string">&quot;name&quot;</span>, defaultName, <span class="hljs-string">&quot;Name to greet&quot;</span>)<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>flag.Parse()<br><span class="hljs-comment">// 连接到server端，此处禁用安全传输</span><br>conn, err := grpc.Dial(*addr, grpc.WithTransportCredentials(insecure.NewCredentials()))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;did not connect: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> conn.Close()<br>c := pb.NewGreeterClient(conn)<br><br><span class="hljs-comment">// 执行RPC调用并打印收到的响应数据</span><br>ctx, cancel := context.WithTimeout(context.Background(), time.Second)<br><span class="hljs-keyword">defer</span> cancel()<br>r, err := c.SayHello(ctx, &amp;pb.HelloRequest&#123;Name: *name&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;could not greet: %v&quot;</span>, err)<br>&#125;<br>log.Printf(<span class="hljs-string">&quot;Greeting: %s&quot;</span>, r.GetReply())<br>&#125;<br></code></pre></td></tr></table></figure><h4><span id="代码结构">代码结构</span></h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">http_client<br>├── go<span class="hljs-selector-class">.mod</span><br>├── go<span class="hljs-selector-class">.sum</span><br>├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.go</span><br>└── pb<br>    ├── hello<span class="hljs-selector-class">.pb</span><span class="hljs-selector-class">.go</span><br>    ├── hello<span class="hljs-selector-class">.proto</span><br>    └── hello_grpc<span class="hljs-selector-class">.pb</span>.go<br></code></pre></td></tr></table></figure><h2><span id="结果">结果</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ go run main.go -name=李四<br>Greeting: Hello 李四<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang 看这一篇就够了</title>
    <link href="/2023/07/29/golang/golang%E9%9D%A2%E8%AF%95/"/>
    <url>/2023/07/29/golang/golang%E9%9D%A2%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>日积月累便封神</p>          </div><span id="more"></span><h1><span id="常用">常用</span></h1><h1><span id="1-time-包">1. time 包</span></h1><div class="note note-primary">            <p>时间格式、超时处理、定时器。</p>          </div><!--more--><h3><span id="11-时间格式">1.1 时间格式</span></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">timelocal, err := time.LoadLocation(<span class="hljs-string">&quot;Asia/Shanghai&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>time.Local = timelocal<br>fmt.Println(time.Now().Local().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br></code></pre></td></tr></table></figure><h3><span id="12-超时处理">1.2 超时处理</span></h3><h4><span id="121-使用select">1.2.1. 使用select</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">c1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>    time.Sleep(time.Second * <span class="hljs-number">2</span>)<br>    c1 &lt;- <span class="hljs-string">&quot;result 1&quot;</span><br>&#125;()<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> res := &lt;-c1:<br>    fmt.Println(res)<br><span class="hljs-keyword">case</span> &lt;-time.After(time.Second * <span class="hljs-number">1</span>):<br>    fmt.Println(<span class="hljs-string">&quot;timeout 1&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4><span id="122-使用-timesince">1.2.2. 使用 time.Since</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">startTime := time.Now()<br>timeout := <span class="hljs-number">5</span> * time.Second<br><br>   time.Sleep(<span class="hljs-number">10</span> * time.Second)<br><br>   <span class="hljs-keyword">if</span> time.Since(startTime) &gt; timeout &#123;<br>       <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;timeout&quot;</span>)<br>   &#125;<br></code></pre></td></tr></table></figure><h3><span id="13-定时器">1.3 定时器</span></h3><h4><span id="131-timer">1.3.1. timer</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// NewTimer 创建一个 Timer，它会在最少过去时间段 d 后到期，向其自身的 C 字段发送当时的时间</span><br>timer1 := time.NewTimer(<span class="hljs-number">5</span> * time.Second)<br><br>fmt.Println(<span class="hljs-string">&quot;开始时间：&quot;</span>, time.Now().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *time.Timer)</span></span> &#123;<br>times := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> &#123;<br>&lt;-t.C<br>fmt.Println(<span class="hljs-string">&quot;timer&quot;</span>, time.Now().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br><br>times++<br>fmt.Println(<span class="hljs-string">&quot;调用 reset 重新设置一次timer定时器，并将时间修改为2秒&quot;</span>)<br>t.Reset(<span class="hljs-number">2</span> * time.Second)<br><span class="hljs-keyword">if</span> times &gt; <span class="hljs-number">3</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;调用 stop 停止定时器&quot;</span>)<br>t.Stop()<br>&#125;<br>&#125;<br>&#125;(timer1)<br><br>time.Sleep(<span class="hljs-number">30</span> * time.Second)<br>fmt.Println(<span class="hljs-string">&quot;结束时间：&quot;</span>, time.Now().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><h4><span id="132-ticker">1.3.2. ticker</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ticker1 := time.NewTicker(<span class="hljs-number">5</span> * time.Second)<br><span class="hljs-keyword">defer</span> ticker1.Stop() <span class="hljs-comment">// 一定要调用Stop()，回收资源</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *time.Ticker)</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// 每5秒中从chan t.C 中读取一次</span><br>&lt;-t.C<br>fmt.Println(<span class="hljs-string">&quot;Ticker:&quot;</span>, time.Now().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br>&#125;<br>&#125;(ticker1)<br><br>time.Sleep(<span class="hljs-number">30</span> * time.Second)<br>fmt.Println(<span class="hljs-string">&quot;ok&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h1><span id="2-gin-跨域问题">2 gin 跨域问题</span></h1><div class="note note-warning">            <p>解决跨域问题</p>          </div><p>代码加入这一段就可以了</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">r := gin.Default()<br>r.Use(Cors())<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Cors</span><span class="hljs-params">()</span></span> gin.HandlerFunc &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>method := c.Request.Method<br>origin := c.Request.Header.Get(<span class="hljs-string">&quot;Origin&quot;</span>)<br><span class="hljs-keyword">if</span> origin != <span class="hljs-string">&quot;&quot;</span> &#123;<br>c.Header(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>) <span class="hljs-comment">// 可将将 * 替换为指定的域名</span><br>c.Header(<span class="hljs-string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="hljs-string">&quot;POST, GET, OPTIONS, PUT, DELETE, UPDATE&quot;</span>)<br>c.Header(<span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="hljs-string">&quot;Origin, X-Requested-With, Content-Type, Accept, Authorization&quot;</span>)<br>c.Header(<span class="hljs-string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="hljs-string">&quot;Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers, Cache-Control, Content-Language, Content-Type&quot;</span>)<br>c.Header(<span class="hljs-string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> method == <span class="hljs-string">&quot;OPTIONS&quot;</span> &#123;<br>c.AbortWithStatus(http.StatusNoContent)<br>&#125;<br>c.Next()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1><span id="3-分配-ip">3. 分配 IP</span></h1><div class="note note-warning">            <p>当我们有一段或者多段IP时，如何从IP池中分配出一个IP？</p>          </div><p><strong>创建配置文件</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt; ipam.json</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;ranges&quot;: [</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;start&quot;: &quot;10.172.16.2&quot;,</span><br><span class="hljs-string">      &quot;end&quot;: &quot;10.172.16.3&quot;</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;start&quot;: &quot;10.172.17.2&quot;,</span><br><span class="hljs-string">      &quot;end&quot;: &quot;10.172.17.3&quot;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><p><strong>代码实现</strong></p><p><a href="https://github.com/oldwang12/ipam">ipam</a></p><h1><span id="4-无法下载kubernetes包">4. 无法下载kubernetes包</span></h1><div class="note note-warning">            <p>解决无法直接下载 k8s.io&#x2F;kubernetes 包问题</p>          </div><p>如果我们直接 go get k8s.io&#x2F;<a href="mailto:&#x6b;&#117;&#98;&#101;&#x72;&#x6e;&#101;&#x74;&#101;&#x73;&#64;&#118;&#49;&#46;&#x31;&#x39;&#46;&#50;">&#x6b;&#117;&#98;&#101;&#x72;&#x6e;&#101;&#x74;&#101;&#x73;&#64;&#118;&#49;&#46;&#x31;&#x39;&#46;&#50;</a> 下载依赖，会出现以下错误:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get k8s.io/kubernetes@v1<span class="hljs-number">.19</span><span class="hljs-number">.2</span><br><span class="hljs-keyword">go</span>: downloading k8s.io/kubernetes v1<span class="hljs-number">.19</span><span class="hljs-number">.2</span><br><span class="hljs-keyword">go</span>: k8s.io/kubernetes@v1<span class="hljs-number">.19</span><span class="hljs-number">.2</span> requires<br>        k8s.io/api@v0<span class="hljs-number">.0</span><span class="hljs-number">.0</span>: reading k8s.io/api/<span class="hljs-keyword">go</span>.mod at revision v0<span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<br></code></pre></td></tr></table></figure><p>错误的原因是在kubernetes主仓中，也使用了公共库，不过go.mod文件中所有公共库版本都指定为了v0.0.0（显然这个版本不存在）， 然后通过Go Module的replace机制，将版本替换为子目录.&#x2F;staging&#x2F;src&#x2F;k8s.io对应的依赖。</p><p>保存内容为 go-get-kubernetes.sh, 执行 .&#x2F;go-get-kubernetes.sh v1.19.2，会自动在go.mod中替换。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">set</span> -euo pipefail<br><br>VERSION=<span class="hljs-variable">$&#123;1#&quot;v&quot;&#125;</span><br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$VERSION</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Must specify version!&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br>MODS=($(<br>    curl -sS https://raw.githubusercontent.com/kubernetes/kubernetes/v<span class="hljs-variable">$&#123;VERSION&#125;</span>/go.mod |<br>    sed -n <span class="hljs-string">&#x27;s|.*k8s.io/\(.*\) =&gt; ./staging/src/k8s.io/.*|k8s.io/\1|p&#x27;</span><br>))<br><span class="hljs-keyword">for</span> MOD <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MODS[@]&#125;</span>&quot;</span>; <span class="hljs-keyword">do</span><br><br>    V=$(<br>        go mod download -json <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;MOD&#125;</span>@kubernetes-<span class="hljs-variable">$&#123;VERSION&#125;</span>&quot;</span> |<br>        sed -n <span class="hljs-string">&#x27;s|.*&quot;Version&quot;: &quot;\(.*\)&quot;.*|\1|p&#x27;</span><br>    )<br>    go mod edit <span class="hljs-string">&quot;-replace=<span class="hljs-variable">$&#123;MOD&#125;</span>=<span class="hljs-variable">$&#123;MOD&#125;</span>@<span class="hljs-variable">$&#123;V&#125;</span>&quot;</span><br><span class="hljs-keyword">done</span><br>go get <span class="hljs-string">&quot;k8s.io/kubernetes@v<span class="hljs-variable">$&#123;VERSION&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><h1><span id="面试">面试</span></h1><h2><span id="21-结构体打印时v-和-v-的区别">2.1 结构体打印时，%v 和 %+v 的区别</span></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printStruct</span><span class="hljs-params">()</span></span>&#123;<br>people := People&#123;<br>Name: <span class="hljs-string">&quot;lisi&quot;</span>,<br>Age:  <span class="hljs-number">18</span>,<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;%v\n&quot;</span>, people)<br>fmt.Printf(<span class="hljs-string">&quot;%+v\n&quot;</span>, people)<br>fmt.Printf(<span class="hljs-string">&quot;%#v\n&quot;</span>, people)<br>&#125;<br><span class="hljs-comment">// 输出:</span><br><span class="hljs-comment">// &#123;lisi 18&#125;</span><br><span class="hljs-comment">// &#123;Name:lisi Age:18&#125;</span><br><span class="hljs-comment">// People&#123;Name:&quot;lisi&quot;, Age:18&#125;</span><br></code></pre></td></tr></table></figure><p id="2"></p> <h2><span id="22-new-和-make的区别">2.2 new 和 make的区别</span></h2><ul><li>new只用于分配内存，返回一个指向地址的指针。它为每个新类型分配一片内存，初始化为0且返回类型*T的内存地址，它相当于&amp;T{}</li><li>make只可用于slice,map,channel的初始化,返回的是引用。</li></ul><h2><span id="23-什么是协程">2.3 什么是协程？</span></h2><p>协程是用户态轻量级线程，它是线程调度的基本单位。通常在函数前加上go关键字就能实现并发。一个Goroutine会以一个很小的栈启动2KB或4KB，当遇到栈空间不足时，栈会自动伸缩， 因此可以轻易实现成千上万个goroutine同时启动。</p><h2><span id="24-defer执行顺序">2.4 defer执行顺序</span></h2><p>后进先出</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>i := <span class="hljs-number">0</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;defer1&quot;</span>)<br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>i += <span class="hljs-number">1</span><br>fmt.Println(<span class="hljs-string">&quot;defer2&quot;</span>)<br>&#125;()<br><span class="hljs-keyword">return</span> i<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;return&quot;</span>, test())<br>&#125;<br><span class="hljs-comment">// 输出:</span><br><span class="hljs-comment">// defer2</span><br><span class="hljs-comment">// defer1</span><br><span class="hljs-comment">// return 0</span><br></code></pre></td></tr></table></figure><p>上面这个例子中，test返回值并没有修改，这是由于Go的返回机制决定的，执行Return语句后，Go会创建一个临时变量保存返回值。如果是有名返回（也就是指明返回值func test() (i int)）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> (i <span class="hljs-type">int</span>) &#123;<br>i = <span class="hljs-number">0</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>i += <span class="hljs-number">1</span><br>fmt.Println(<span class="hljs-string">&quot;defer2&quot;</span>)<br>&#125;()<br><span class="hljs-keyword">return</span> i<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;return&quot;</span>, test())<br>&#125;<br><span class="hljs-comment">// defer2</span><br><span class="hljs-comment">// return 1</span><br></code></pre></td></tr></table></figure><p>这个例子中，返回值被修改了。对于有名返回值的函数，执行 return 语句时，并不会再创建临时变量保存，因此，defer 语句修改了 i，即对返回值产生了影响。</p><h2><span id="25-如何判断-map-中是否包含某个-key">2.5 如何判断 map 中是否包含某个 key ？</span></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> sample <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span><br><span class="hljs-keyword">if</span> _, ok := sample[<span class="hljs-number">10</span>]; ok &#123;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2><span id="26-如何获取一个结构体的所有tag">2.6 如何获取一个结构体的所有tag？</span></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;reflect&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Author <span class="hljs-keyword">struct</span> &#123;<br>Name         <span class="hljs-type">int</span>      <span class="hljs-string">`json:Name`</span><br>Publications []<span class="hljs-type">string</span> <span class="hljs-string">`json:Publication,omitempty`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>t := reflect.TypeOf(Author&#123;&#125;)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.NumField(); i++ &#123;<br>name := t.Field(i).Name<br>s, _ := t.FieldByName(name)<br>fmt.Println(name, s.Tag)<br>&#125;<br>&#125;<br><span class="hljs-comment">// Name json:Name</span><br><span class="hljs-comment">// Publications json:Publication,omitempty</span><br></code></pre></td></tr></table></figure><h2><span id="27-如何判断-2-个字符串切片slice-是相等的">2.7 如何判断 2 个字符串切片（slice) 是相等的？</span></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>x := <span class="hljs-string">&quot;abcd&quot;</span><br>y := <span class="hljs-string">&quot;abcde&quot;</span><br>fmt.Println(reflect.DeepEqual(x, y))<br><span class="hljs-comment">// Output: false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2><span id="28-go里面的int和int32是同一个概念吗">2.8 go里面的int和int32是同一个概念吗？</span></h2><p>不是一个概念！千万不能混淆。go语言中的int的大小是和操作系统位数相关的，如果是32位操作系统，int类型的大小就是4字节。如果是64位操作系统，int类型的大小就是8个字节。除此之外uint也与操作系统有关。</p><p>int8占1个字节，int16占2个字节，int32占4个字节，int64占8个字节。</p><h2><span id="29-init-函数">2.9 init() 函数</span></h2><ul><li>init()函数是go初始化的一部分，由runtime初始化每个导入的包，初始化不是按照从上到下的导入顺序，而是按照解析的依赖关系，没有依赖的包最先初始化。</li><li>每个包首先初始化包作用域的常量和变量（常量优先于变量），然后执行包的init()函数。同一个包，甚至是同一个源文件可以有多个init()函数。</li><li>init()函数没有入参和返回值，不能被其他函数调用，</li><li><span style="color: green;">同一个包内多个init()函数的执行顺序不作保证。</span></li><li>一个文件可以有多个init()函数！</li><li>执行顺序：import –&gt; const –&gt; var –&gt;init()–&gt;main()</li></ul><h2><span id="210-2-个-nil-可能不相等吗">2.10 2 个 nil 可能不相等吗？</span></h2><p>可能不等。interface在运行时绑定值，只有值为nil接口值才为nil，但是与指针的nil不相等。举个例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> p *<span class="hljs-type">int</span> = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">var</span> i <span class="hljs-keyword">interface</span>&#123;&#125; = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">if</span>(p == i)&#123;<br>fmt.Println(<span class="hljs-string">&quot;Equal&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>两者并不相同。总结：<span style="color: green;">两个nil只有在类型相同时才相等。</span></p>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>viper配置文件</title>
    <link href="/2023/07/29/golang/viper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    <url>/2023/07/29/golang/viper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>viper配置文件，为项目的启动提速。</p>          </div><span id="more"></span><h4><span id="配置文件">配置文件</span></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">mysql:</span><br>  <span class="hljs-attr">url:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span><br><span class="hljs-attr">isvalid:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h4><span id="代码示例">代码示例</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// 设置配置文件的名字</span><br>viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)<br><span class="hljs-comment">// 设置配置文件的类型</span><br>viper.SetConfigType(<span class="hljs-string">&quot;yaml&quot;</span>)<br><span class="hljs-comment">// 添加配置文件的路径，指定 config 目录下寻找</span><br>viper.AddConfigPath(<span class="hljs-string">&quot;./config&quot;</span>)<br><span class="hljs-comment">// 寻找配置文件并读取</span><br>err := viper.ReadInConfig()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(fmt.Errorf(<span class="hljs-string">&quot;fatal error config file: %w&quot;</span>, err))<br>&#125;<br>fmt.Println(viper.Get(<span class="hljs-string">&quot;mysql&quot;</span>))<br>fmt.Println(viper.GetString(<span class="hljs-string">&quot;mysql.url&quot;</span>))<br>fmt.Println(viper.GetInt(<span class="hljs-string">&quot;mysql.port&quot;</span>))<br>fmt.Println(viper.GetBool(<span class="hljs-string">&quot;isvalid&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>oh my zsh 让终端飞</title>
    <link href="/2023/07/27/%E5%B7%A5%E5%85%B7/oh-my-zsh-%E8%AE%A9%E7%BB%88%E7%AB%AF%E9%A3%9E/"/>
    <url>/2023/07/27/%E5%B7%A5%E5%85%B7/oh-my-zsh-%E8%AE%A9%E7%BB%88%E7%AB%AF%E9%A3%9E/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>oh my zsh 让终端飞。</p>          </div><span id="more"></span><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># yum先安装，如果是ubuntu使用 apt-get install zsh </span><br>yum -y install zsh<br><br><span class="hljs-comment"># 安装脚本</span><br>sh -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>&quot;</span><br><br><span class="hljs-comment"># 插件安装</span><br><br><span class="hljs-comment">## 高亮插件</span><br>git <span class="hljs-built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="hljs-variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting<br><br><span class="hljs-comment">## 自动补全</span><br>git <span class="hljs-built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="hljs-variable">$ZSH_CUSTOM</span>/plugins/zsh-autosuggestions<br></code></pre></td></tr></table></figure><h4><span id="手动更改插件配置">手动更改插件配置</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ vim ~/.zshrc<br><br><span class="hljs-comment"># plugins 更改如下</span><br>plugins=(<br>  git<br>  zsh-autosuggestions<br>  zsh-syntax-highlighting<br>)<br><br><span class="hljs-comment"># 更换主题</span><br>ZSH_THEME=<span class="hljs-string">&quot;ys&quot;</span><br><br><span class="hljs-comment"># 重新加载</span><br><span class="hljs-built_in">source</span> ~/.zshrc<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工具</tag>
      
      <tag>oh my zsh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dockerfile 命令</title>
    <link href="/2023/07/27/docker/Dockerfile%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/07/27/docker/Dockerfile%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>一个适用于我自己的模板，附带一些命令讲解。</p>          </div><span id="more"></span><h2><span id="1-模板">1. 模板</span></h2><h2><span id="2-copy-vs-add">2. COPY vs ADD</span></h2><p>没有特殊需求情况下，建议使用<code>COPY</code></p><p><strong>ADD会自动解压压缩文件</strong></p><p><strong>ADD 支持源文件URL形式</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">ADD</span><span class="language-bash"> http://example.com/example.txt /app/</span><br></code></pre></td></tr></table></figure><h2><span id="3-cmd-vs-entrypoint">3. CMD vs ENTRYPOINT</span></h2><p><strong>docker run 如果指定了命令会覆盖</strong></p><p><strong>下面是等价的</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;python&quot;</span>, <span class="hljs-string">&quot;app.py&quot;</span>]</span><br></code></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;python&quot;</span>, <span class="hljs-string">&quot;app.py&quot;</span>]</span><br></code></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 由 CMD 指令指定默认的可选参数：</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;python&quot;</span>]</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;app.py&quot;</span>]</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>dockerfile</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>容器网络接口（CNI）</title>
    <link href="/2023/07/27/k8s/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%EF%BC%88CNI%EF%BC%89/"/>
    <url>/2023/07/27/k8s/%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%EF%BC%88CNI%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>详解 cni 中 flannel、calico 的原理实现。</p>          </div><span id="more"></span><h1><span id="1-cni交互逻辑">1. CNI交互逻辑</span></h1><h2><span id="11-pod-ip地址分配机制">1.1 Pod IP地址分配机制</span></h2><p><img src="pod-allow-ip.png" alt="image"></p><h2><span id="12-cri插件与cni插件的交互">1.2 CRI插件与CNI插件的交互</span></h2><p><img src="cri-cni.png" alt="cri-cni"></p><h2><span id="13-cni插件间的交互">1.3 CNI插件间的交互</span></h2><p><img src="cni-plugins.png" alt="cni"></p><h1><span id="2-flannel-3种模式">2. flannel 3种模式</span></h1><p><img src="flannel-modes.jpg" alt="flannel"></p><p>UDP、VXLAN模式基于三层网络，host-gateway需要在二层网络同一个交换机下才能实现。</p><h2><span id="21-vxlan模式">2.1 vxlan模式</span></h2><p>VXLAN是Flannel默认和推荐的模式。当我们使用默认配置安装Flannel时，它会为每个节点分配一个24位子网，并在每个节点上创建两张虚机网卡： cni0 和 flannel.1 。 cni0 是一个网桥设备，类似于 docker0 ，节点上所有的Pod都通过veth pair的形式与 cni0 相连。 flannel.1 则是一个VXLAN类型的设备，充当VTEP的角色，实现对VXLAN报文的封包解包。</p><h3><span id="211-节点内通信">2.1.1 节点内通信</span></h3><p><img src="flannel-vxlan-1.png" alt="flannel-vxlan-1"></p><h3><span id="212-跨节点通信">2.1.2 跨节点通信</span></h3><p><img src="flannel-vxlan-2.png" alt="flannel-vxlan-2"></p><p><strong>大致过程:</strong></p><ul><li>发送端：在PodA中发起 ping 10.244.1.21 ，ICMP 报文经过 cni0 网桥后交由 flannel.1 设备处理。 flannel.1 设备是一个VXLAN类型的设备，负责VXLAN封包解包。 因此，在发送端，flannel.1 将原始L2报文封装成VXLAN UDP报文，然后从 eth0 发送。</li><li>接收端：Node2收到UDP报文，发现是一个VXLAN类型报文，交由 flannel.1 进行解包。根据解包后得到的原始报文中的目的IP，将原始报文经由 cni0 网桥发送给PodB。</li></ul><p><strong>哪些IP要交由 flannel.1 处理?</strong></p><p>flanneld 从 etcd 中可以获取所有节点的子网情况，以此为依据为各节点配置路由，将属于非本节点的子网IP都路由到 flannel.1 处理，本节点的子网路由到 cni0 网桥处理。</p><p><strong>flannel 封包过程</strong></p><p>VXLAN的封包是将二层以太网帧封装到四层UDP报文中的过程。</p><p><strong>原始L2帧</strong><br>要生成原始的L2帧， flannel.1 需要得知：</p><ul><li>内层源&#x2F;目的IP地址</li><li>内层源&#x2F;目的MAC地址</li></ul><p>内层的源&#x2F;目的IP地址是已知的，即为PodA&#x2F;PodB的PodIP，在图例中，分别为10.224.0.20和10.224.1.20。<br>内层源&#x2F;目的MAC地址要结合路由表和ARP表来获取。根据路由表①得知：</p><p>下一跳地址是10.224.1.0，关联ARP表②，得到下一跳的MAC地址，也就是目的MAC地址：Node2_flannel.1_MAC；<br>报文要从 flannel.1 虚拟网卡发出，因此源MAC地址为 flannel.1 的MAC地址。</p><p>要注意的是，这里ARP表的表项②并不是通过ARP学习得到的，而是 flanneld 预先为每个节点设置好的，由 flanneld负责维护，没有过期时间。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 查看ARP表</span><br>[root@Node1 ~]<span class="hljs-comment"># ip n | grep flannel.1</span><br>10.244.1.0 dev flannel.1 lladdr ba:74:f9:db:69:c1 PERMANENT <span class="hljs-comment"># PERMANENT 表示永不过期</span><br></code></pre></td></tr></table></figure><p>有了上面的信息， flannel.1 就可以构造出内层的2层以太网帧：</p><p><img src="flannel-vxlan-3.png" alt="flannel_packet_1.png"></p><p><strong>外层VXLAN UDP报文</strong><br>要将原始L2帧封装成VXLAN UDP报文， flannel.1 还需要填充源&#x2F;目的IP地址。前面提到，VTEP是VXLAN隧道的起点或终点。因此，目的IP地址即为对端VTEP的IP地址，通过FDB表获取。在FDB表③中，dst字段表示的即为VXLAN隧道目的端点（对端VTEP）的IP地址，也就是VXLAN DUP报文的目的IP地址。FDB表也是由 flanneld 在每个节点上预设并负责维护的。</p><p>FDB表（Forwarding database）用于保存二层设备中MAC地址和端口的关联关系，就像交换机中的MAC地址表一样。在二层设备转发二层以太网帧时，根据FDB表项来找到对应的端口。例如cni0网桥上连接了很多veth pair网卡，当网桥要将以太网帧转发给Pod时，FDB表根据Pod网卡的MAC地址查询FDB表，就能找到其对应的veth网卡，从而实现联通。</p><p>可以使用 bridge fdb show 查看FDB表：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Node1 ~]<span class="hljs-comment"># bridge fdb show | grep flannel.1</span><br>ba:74:f9:db:69:c1 dev flannel.1 dst 192.168.50.3 self permanent<br></code></pre></td></tr></table></figure><p>源IP地址信息来自于 flannel.1 网卡设置本身，根据 local 192.168.50.2 可以得知源IP地址为192.168.50.2。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Node1 ~]<span class="hljs-comment"># ip -d a show flannel.1</span><br>6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default<br>    <span class="hljs-built_in">link</span>/ether 32:02:78:2f:02:cb brd ff:ff:ff:ff:ff:ff promiscuity 0<br>    vxlan <span class="hljs-built_in">id</span> 1 <span class="hljs-built_in">local</span> 192.168.50.2 dev eth0 srcport 0 0 dstport 8472 nolearning ageing 300 noudpcsum noudp6zerocsumtx noudp6zerocsumrx numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535<br>    inet 10.244.0.0/32 brd 10.244.0.0 scope global flannel.1<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::3002:78ff:fe2f:2cb/64 scope <span class="hljs-built_in">link</span><br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>至此， flannel.1 已经得到了所有完成VXLAN封包所需的信息，最终通过 eth0 发送一个VXLAN UDP报文：</p><p>Flannel的VXLAN模式通过静态配置路由表，ARP表和FDB表的信息，结合VXLAN虚拟网卡 flannel.1 ，实现了一个所有Pod同属一个大二层网络的VXLAN网络模型。</p><h2><span id="22-host-gw模式">2.2 host-gw模式</span></h2><p><img src="flannel-host-gw-1.png" alt="host-gw模式"></p><p>在host-gw模式下，由于不涉及VXLAN的封包解包，不再需要<code>flannel.1</code>虚机网卡。 <code>flanneld</code> 负责为各节点设置路由 ，将对应节点Pod子网的下一跳地址指向对应的节点的IP，如图中<code>路由表①</code>所示。</p><p>要使用<code>host-gw</code>模式，需要修改 ConfigMap <code>kube-flannel-cfg</code> ，将 <code>Backend.Type</code> 从 <code>vxlan</code>改为<code>host-gw</code>，然后重启所有<code>kube-flannel Pod</code>即可：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl -n kube-flannel edit configmap kube-flannel-cfg<br><br>...<br>  net-conf.json: |<br>    &#123;<br>      <span class="hljs-string">&quot;Network&quot;</span>: <span class="hljs-string">&quot;10.244.0.0/16&quot;</span>,<br>      <span class="hljs-string">&quot;Backend&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;Type&quot;</span>: <span class="hljs-string">&quot;host-gw&quot;</span> // &lt;- 改成host-gw<br>      &#125;<br>    &#125;<br>...<br></code></pre></td></tr></table></figure><h1><span id="3-calico-两种网络模式">3. calico 两种网络模式</span></h1><h2><span id="31-ipip-模式">3.1 IPIP 模式</span></h2><h4><span id="311-概要">3.1.1 概要</span></h4><p>IPIP模式是calico的默认网络架构，calico中用环境变量<code>CALICO_IPV4POOL_IPIP</code>来标识是否开启<code>IPIP Mode</code>， 如果该变量的值为<code>Always</code>那么就是开启<code>IPIP</code>，如果关闭需要设置为<code>Never</code>(大小写不敏感，代码里有strings.ToLower操作)。</p><ul><li>从字面来理解，就是把一个IP数据包又套在一个IP包里，即把 IP 层封装到 IP 层的一个 tunnel，看起来似乎是浪费，实则不然。</li><li>它的作用其实基本上就相当于一个基于IP层的网桥！</li><li>一般来说，普通的网桥是基于mac层的，根本不需 IP，而这个 ipip 则是通过两端的路由做一个 tunnel，把两个本来不通的网络通过点对点连接起来。</li><li>ipip 的源代码在内核 net&#x2F;ipv4&#x2F;ipip.c 中可以找到。</li></ul><h4><span id="312-工作原理">3.1.2 工作原理</span></h4><p><img src="calico-ipip-1.png" alt="ipip"></p><p>Calico使用的这个tunl0设备，是一个IP隧道（IP tunnel）设备</p><p>在上面的例子中，IP包进入IP隧道设备之后，就会被Linux内核的IPIP驱动接管。IPIP驱动会将这个IP包直接封装在一个宿主机网络的IP包中，如下所示：</p><p><img src="calico-ipip-2.png" alt="ipip"></p><h2><span id="32-bgp-模式">3.2 BGP 模式</span></h2><h4><span id="321-概要">3.2.1 概要</span></h4><ul><li>边界网关协议（Border Gateway Protocol, BGP）是互联网上一个核心的去中心化自治路由协议。</li><li>它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。</li><li>BGP不使用传统的内部网关协议（IGP）的指标，而使用基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议。</li><li>BGP，通俗的讲就是讲接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP，BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统。</li><li>BGP网络相比较IPIP网络，最大的不同之处就是没有了隧道设备 tunl0。前面介绍过<code>IPIP</code>网络pod之间的流量发送tunl0，然后tunl0发送对端设备。BGP网络中，pod之间的流量直接从网卡发送目的地，减少了<code>tunl0</code>这个环节。</li></ul><h4><span id="322-工作原理">3.2.2 工作原理</span></h4><p><img src="calico-bgp-1.png" alt="bgp"></p><h1><span id="参考文章">参考文章</span></h1><p><a href="https://ost.51cto.com/posts/15845">https://ost.51cto.com/posts/15845</a><br><a href="https://juejin.cn/post/6994825163757846565">https://juejin.cn/post/6994825163757846565</a></p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
      <tag>cni</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用kubeadm安装集群</title>
    <link href="/2023/07/26/k8s/%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4/"/>
    <url>/2023/07/26/k8s/%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>目前最主流的安装方式，使用kubeadm安装集群。</p>          </div><span id="more"></span><h2><span id="图解k8s">图解k8s</span></h2><p><img src="master-worker.png" alt="master-worker"></p><h2><span id="1-containerd">1. containerd</span></h2><p><strong>1.1 使用 tar 包安装</strong><br><a href="https://github.com/containerd/containerd/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/containerd/containerd/releases/download/v1.7.2/containerd-1.7.2-linux-amd64.tar.gz<br>tar Cxzvf /usr/local containerd-1.7.2-linux-amd64.tar.gz<br><span class="hljs-built_in">mkdir</span> -p /usr/local/lib/systemd/system<br>wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service<br><span class="hljs-built_in">mv</span> containerd.service /usr/local/lib/systemd/system/containerd.service<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now containerd<br></code></pre></td></tr></table></figure><p><strong>1.2 rpm、deb 包安装</strong></p><ul><li>Centos <a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/">下载地址</a></li><li>Ubuntu <a href="https://download.docker.com/linux/ubuntu/dists/bionic/pool/stable/amd64">下载地址</a></li></ul><h2><span id="2-runc">2. runc</span></h2><p><a href="https://github.com/opencontainers/runc/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/opencontainers/runc/releases/download/v1.1.8/runc.amd64<br>install -m 755 runc.amd64 /usr/local/sbin/runc<br></code></pre></td></tr></table></figure><h2><span id="3-ctrctl">3. ctrctl</span></h2><p><a href="https://github.com/kubernetes-sigs/cri-tools/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 注意: 下载对应的集群版本，crictl版本列表：https://github.com/kubernetes-sigs/cri-tools/tags</span><br>VERSION=<span class="hljs-string">&quot;v1.26.0&quot;</span> <span class="hljs-comment"># check latest version in /releases page</span><br>curl -L https://github.com/kubernetes-sigs/cri-tools/releases/download/<span class="hljs-variable">$VERSION</span>/crictl-<span class="hljs-variable">$&#123;VERSION&#125;</span>-linux-amd64.tar.gz --output crictl-<span class="hljs-variable">$&#123;VERSION&#125;</span>-linux-amd64.tar.gz<br>sudo tar zxvf crictl-<span class="hljs-variable">$VERSION</span>-linux-amd64.tar.gz -C /usr/local/bin<br><span class="hljs-built_in">rm</span> -f crictl-<span class="hljs-variable">$VERSION</span>-linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><p><strong>3.1 ctrctl 报错文件找不到</strong></p><ul><li>不同的部署方式，文件路径可能不同。</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 以 k3s 为例，指定 .sock 文件</span><br>crictl --runtime-endpoint /var/run/k3s/containerd/containerd.sock ps -a<br></code></pre></td></tr></table></figure><p><strong>3.2 查看 ctrctl 配置</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">cat</span> /etc/crictl.yaml<br></code></pre></td></tr></table></figure><h2><span id="4-kubeadm-kubelet-kubectl">4. kubeadm、kubelet、kubectl</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">DOWNLOAD_DIR=<span class="hljs-string">&quot;/usr/local/bin&quot;</span><br>sudo <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$DOWNLOAD_DIR</span>&quot;</span><br><br><span class="hljs-comment"># 安装最新版</span><br>RELEASE=<span class="hljs-string">&quot;<span class="hljs-subst">$(curl -sSL https://dl.k8s.io/release/stable.txt)</span>&quot;</span><br><br><span class="hljs-comment"># 安装指定版本</span><br><span class="hljs-comment"># RELEASE=&quot;v1.26.7&quot;</span><br><br>ARCH=<span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$DOWNLOAD_DIR</span><br>sudo curl -L --remote-name-all https://dl.k8s.io/release/<span class="hljs-variable">$&#123;RELEASE&#125;</span>/bin/linux/<span class="hljs-variable">$&#123;ARCH&#125;</span>/&#123;kubeadm,kubelet,kubectl&#125;<br>sudo <span class="hljs-built_in">chmod</span> +x &#123;kubeadm,kubelet,kubectl&#125;<br><br>RELEASE_VERSION=<span class="hljs-string">&quot;v0.15.1&quot;</span><br>curl -sSL <span class="hljs-string">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class="hljs-variable">$&#123;RELEASE_VERSION&#125;</span>/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&quot;</span> | sed <span class="hljs-string">&quot;s:/usr/bin:<span class="hljs-variable">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/kubelet.service<br>sudo <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/kubelet.service.d<br>curl -sSL <span class="hljs-string">&quot;https://raw.githubusercontent.com/kubernetes/release/<span class="hljs-variable">$&#123;RELEASE_VERSION&#125;</span>/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&quot;</span> | sed <span class="hljs-string">&quot;s:/usr/bin:<span class="hljs-variable">$&#123;DOWNLOAD_DIR&#125;</span>:g&quot;</span> | sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<br><br><span class="hljs-comment"># 激活并启动 kubelet</span><br>systemctl <span class="hljs-built_in">enable</span> --now kubelet<br></code></pre></td></tr></table></figure><h2><span id="5-conntrack">5. conntrack</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install conntrack-tools -y<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">conntrack -L<br></code></pre></td></tr></table></figure><h2><span id="6-设置内核参数">6. 设置内核参数</span></h2><div class="note note-primary">            <p>如果不设置参数，使用 kubeadm join 时可能会导致报错。</p>          </div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs log">W0726 10:29:26.474684    8216 checks.go:1064] [preflight] WARNING: Couldn&#x27;t create the interface used for talking to the container runtime: crictl is required by the container runtime: executable file not found in $PATH<br>[WARNING FileExisting-socat]: socat not found in system path<br>error execution phase preflight: [preflight] Some fatal errors occurred:<br>[ERROR FileExisting-crictl]: crictl not found in system path<br>[ERROR FileExisting-conntrack]: conntrack not found in system path<br>[ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridge-nf-call-iptables does not exist<br>[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1<br>[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`<br></code></pre></td></tr></table></figure><h3><span id="61-加载-bridge-内核模块">6.1 加载 bridge 内核模块</span></h3><p>查看是否加载 br_netfilter 模块</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">lsmod | grep br_netfilter<br></code></pre></td></tr></table></figure><p>如果没加载执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo modprobe br_netfilter<br></code></pre></td></tr></table></figure><h3><span id="62-更改内核参数">6.2 更改内核参数</span></h3><p>打开 &#x2F;etc&#x2F;sysctl.conf 文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">net.ipv4.ip_forward = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br></code></pre></td></tr></table></figure><h4><span id="63-重新加载-sysctl-配置">6.3 重新加载 sysctl 配置</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sysctl -p<br></code></pre></td></tr></table></figure><h2><span id="7-部署集群">7. 部署集群</span></h2><h3><span id="71-master">7.1 master</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubeadm init --v=5<br></code></pre></td></tr></table></figure><p>此时，正常情况下你应该看到master安装成功提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs log">kubeadm join 10.7.130.29:6443 --token kqi9ve.dvcyddrn9527rvnu \<br>--discovery-token-ca-cert-hash sha256:67c19abd79fhjkl1cc5a04e2192bf3bc335d41f2f4a76084adcc4cda3d48804<br></code></pre></td></tr></table></figure><h3><span id="72-node">7.2 node</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubeadm <span class="hljs-built_in">join</span> 10.7.130.29:6443 --token kqi9ve.dvcyddrn9527rvnu \<br>--discovery-token-ca-cert-hash sha256:67c19abd79fhjkl1cc5a04e2192bf3bc335d41f2f4a76084adcc4cda3d48804<br></code></pre></td></tr></table></figure><h3><span id="73-参数说明">7.3 参数说明</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 指定版本</span><br>--kubernetes-version=v1.26.7<br><br><span class="hljs-comment"># 指定镜像源为阿里</span><br>--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers<br><br><span class="hljs-comment"># 指定pod网段</span><br>--pod-network-cidr=10.244.0.0/16<br></code></pre></td></tr></table></figure><h3><span id="74-重新生成-token">7.4 重新生成 token</span></h3><p>当忘记kubeadm join命令时，可以重新生成token。以此来获得 kubeadm join 命令。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo kubeadm token create --print-join-command<br></code></pre></td></tr></table></figure><h3><span id="75-查看-token">7.5 查看 token</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo kubeadm token list<br></code></pre></td></tr></table></figure><h2><span id="8-kubeconfig-配置文件">8. kubeconfig 配置文件</span></h2><p>默认生成的 kubeconfig 文件在 &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$HOME</span>/.kube<br><span class="hljs-built_in">cp</span> /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>kubectl get no<br></code></pre></td></tr></table></figure><h2><span id="9-安装网络插件">9. 安装网络插件</span></h2><div class="note note-danger">            <p>不安装官方插件会报错，忘记了什么原因导致的。</p>          </div><h3><span id="91-先安装官方插件">9.1 先安装官方插件</span></h3><p><a href="https://github.com/containernetworking/plugins/releases">下载地址</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz<br>tar -zxvf cni-plugins-linux-amd64-v1.3.0.tgz -C /opt/cni/bin<br><span class="hljs-built_in">rm</span> -f cni-plugins-linux-amd64-v1.3.0.tgz<br></code></pre></td></tr></table></figure><h3><span id="92-安装-flannel-或-calico">9.2 安装 flannel 或 calico</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># flannel</span><br>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># calico</span><br>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml<br></code></pre></td></tr></table></figure><p>安装完<span class="label label-default">cni</span>后，此时<span class="label label-default">coredns</span>应该为 <span class="label label-success">running</span></p><h4><span id="921-查看flannel模式">9.2.1 查看flannel模式</span></h4><span class="label label-success">flannel</span> 默认的模式为 <span class="label label-primary">vxlan</span>，如果需要修改，可以修改 <span class="label label-default">configmap</span>  <span class="label label-default">kube-flannel-cfg</span><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl -n kube-flannel get configmap kube-flannel-cfg -oyaml<br></code></pre></td></tr></table></figure><h4><span id="922-创建测试pod">9.2.2 创建测试pod</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl run my-pod --image=nginx:latest<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用client-go操作自定义CRD</title>
    <link href="/2023/07/25/k8s/%E4%BD%BF%E7%94%A8client-go%E6%93%8D%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89CRD/"/>
    <url>/2023/07/25/k8s/%E4%BD%BF%E7%94%A8client-go%E6%93%8D%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89CRD/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>简洁、高效、无需定义 CR 相关结构体，实现了四种方法： Get、List、Update、Delete 来操作 CR。</p><p>个人觉得这只适合对 CR 字段更改不是很多的环境，如果参数过多可能会有些繁琐。</p>          </div><span id="more"></span><h4><span id="代码实现">代码实现</span></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;path/filepath&quot;</span><br><br>metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br><span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1/unstructured&quot;</span><br><span class="hljs-string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/dynamic&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/util/homedir&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> KubernetesCrdExec <span class="hljs-keyword">interface</span> &#123;<br>Get(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="hljs-type">string</span>) (*unstructured.Unstructured, <span class="hljs-type">error</span>)<br>List(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace <span class="hljs-type">string</span>) (*unstructured.UnstructuredList, <span class="hljs-type">error</span>)<br>Update(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, result *unstructured.Unstructured, namespace, name <span class="hljs-type">string</span>) (*unstructured.Unstructured, <span class="hljs-type">error</span>)<br>Delete(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="hljs-type">string</span>) <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Alertmanager <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>resource := schema.GroupVersionResource&#123;<br>Group:    <span class="hljs-string">&quot;monitoring.coreos.com&quot;</span>,<br>Version:  <span class="hljs-string">&quot;v1&quot;</span>,<br>Resource: <span class="hljs-string">&quot;alertmanagers&quot;</span>, <span class="hljs-comment">// 这里必须是复数形式</span><br>&#125;<br><br>namespace := <span class="hljs-string">&quot;default&quot;</span><br>name := <span class="hljs-string">&quot;my-alertmanager&quot;</span><br><br>dynamicClient, err := getClient()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err.Error())<br>&#125;<br><br><span class="hljs-keyword">var</span> crd KubernetesCrdExec<br>crd = Alertmanager&#123;&#125;<br><br>result, err := crd.Get(dynamicClient, resource, namespace, name)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br>fmt.Println(result.Object[<span class="hljs-string">&quot;spec&quot;</span>].(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)[<span class="hljs-string">&quot;externalUrl&quot;</span>])<br><br>resultLists, err := crd.List(dynamicClient, resource, namespace)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br><span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> resultLists.Items &#123;<br>name := item.Object[<span class="hljs-string">&quot;metadata&quot;</span>].(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)[<span class="hljs-string">&quot;name&quot;</span>]<br>namespace := item.Object[<span class="hljs-string">&quot;metadata&quot;</span>].(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)[<span class="hljs-string">&quot;namespace&quot;</span>]<br>fmt.Printf(<span class="hljs-string">&quot;%v/%v\n&quot;</span>, namespace, name)<br>&#125;<br><br><span class="hljs-comment">// 在这里对 Object 进行修改，更新字段值。这里相当于更新了 spec.externalUrl = http://127.0.0.1:9093</span><br>result.Object[<span class="hljs-string">&quot;spec&quot;</span>].(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)[<span class="hljs-string">&quot;externalUrl&quot;</span>] = <span class="hljs-string">&quot;http://127.0.0.1:9093&quot;</span><br>result, err = crd.Update(dynamicClient, resource, result, namespace, name)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br>err = crd.Delete(dynamicClient, resource, namespace, name)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Alertmanager)</span></span> Get(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="hljs-type">string</span>) (*unstructured.Unstructured, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).Get(context.TODO(), name, metav1.GetOptions&#123;&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Alertmanager)</span></span> List(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace <span class="hljs-type">string</span>) (*unstructured.UnstructuredList, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).List(context.TODO(), metav1.ListOptions&#123;&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Alertmanager)</span></span> Update(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, result *unstructured.Unstructured, namespace, name <span class="hljs-type">string</span>) (*unstructured.Unstructured, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).Update(context.TODO(), result, metav1.UpdateOptions&#123;&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Alertmanager)</span></span> Delete(dynamicClient dynamic.Interface, resource schema.GroupVersionResource, namespace, name <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">return</span> dynamicClient.Resource(resource).Namespace(namespace).Delete(context.TODO(), name, metav1.DeleteOptions&#123;&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getClient</span><span class="hljs-params">()</span></span> (dynamic.Interface, <span class="hljs-type">error</span>) &#123;<br>kubeconfig := filepath.Join(homedir.HomeDir(), <span class="hljs-string">&quot;.kube&quot;</span>, <span class="hljs-string">&quot;config&quot;</span>)<br>config, err := clientcmd.BuildConfigFromFlags(<span class="hljs-string">&quot;&quot;</span>, kubeconfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> dynamic.NewForConfig(config)<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>安装kubectl快捷命令</title>
    <link href="/2023/07/23/k8s/%E5%AE%89%E8%A3%85kubectl%E5%BF%AB%E6%8D%B7%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/07/23/k8s/%E5%AE%89%E8%A3%85kubectl%E5%BF%AB%E6%8D%B7%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2><span id="1-简介">1. 简介</span></h2><div class="note note-primary">            <p>k8s 的命令不长，也很好记，但身为一个懒人，我想我可以更简洁、高效。</p>          </div><span id="more"></span><p>默认快捷命令保存在 ~&#x2F;.bashrc 文件。</p><h2><span id="2-安装">2. 安装</span></h2><p>你可以通过该命令一键安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_install.sh | sh -<br></code></pre></td></tr></table></figure><p>如果你的环境默认并不是 <span class="label label-primary">~/.bashrc</span>，可以通过下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_install.sh | bash -s ~/.zshrc<br></code></pre></td></tr></table></figure><p>执行完记得 <span class="label label-primary">source <～ file_name></～></span>，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><h2><span id="3-测试">3. 测试</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 获取pod</span><br>$ p<br>NAME                              READY   STATUS    RESTARTS   AGE<br>test-deployment-d5b769945-q29d4   1/1     Running   0          6d7h<br><br><span class="hljs-comment"># 进入pod</span><br>$ ke test-deployment-d5b769945-q29d4<br>kubectl <span class="hljs-built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="hljs-keyword">in</span> a future version. Use kubectl <span class="hljs-built_in">exec</span> [POD] -- [COMMAND] instead.<br><br><span class="hljs-comment"># 查看日志</span><br>$ kl<br><br><span class="hljs-comment"># 查看帮助</span><br>$ kh<br><span class="hljs-built_in">alias</span> k=<span class="hljs-string">&quot;kubectl&quot;</span><br><span class="hljs-built_in">alias</span> kk=<span class="hljs-string">&quot;kubectl -n kube-system&quot;</span><br><span class="hljs-built_in">alias</span> kl=<span class="hljs-string">&quot;kubectl logs -f&quot;</span><br><span class="hljs-built_in">alias</span> kd=<span class="hljs-string">&quot;kubectl describe&quot;</span><br><span class="hljs-built_in">alias</span> p=<span class="hljs-string">&quot;kubectl get po&quot;</span><br><span class="hljs-built_in">alias</span> svc=<span class="hljs-string">&quot;kubectl get svc&quot;</span><br><span class="hljs-built_in">alias</span> no=<span class="hljs-string">&quot;kubectl get no&quot;</span><br><span class="hljs-built_in">alias</span> pvc=<span class="hljs-string">&quot;kubectl get pvc&quot;</span><br><span class="hljs-built_in">alias</span> sa=<span class="hljs-string">&quot;kubectl get sa&quot;</span><br><span class="hljs-built_in">alias</span> ds=<span class="hljs-string">&quot;kubectl get ds&quot;</span><br><span class="hljs-built_in">alias</span> rs=<span class="hljs-string">&quot;kubectl get rs&quot;</span><br><span class="hljs-built_in">alias</span> ep=<span class="hljs-string">&quot;kubectl get ep&quot;</span><br>ke=kubectl <span class="hljs-built_in">exec</span> -it POD_NAME sh<br></code></pre></td></tr></table></figure><div class="note note-primary">            <p>至此，已经完成了设置kubectl快捷命令。如果你没有多集群切换需求或者关于namespace高效切换，那么到这里就结束了。</p>          </div><h2><span id="4-卸载">4. 卸载</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_uninstall.sh | sh -<br></code></pre></td></tr></table></figure><p>如果你的文件不是 ~&#x2F;.bashrc，需要替换为对应文件，以 ~&#x2F;.zshrc 为例</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/k8s_alias_uninstall.sh | bash -s ~/.zshrc<br></code></pre></td></tr></table></figure><p>执行完记得 <span class="label label-primary">source <～ file_name></～></span>，例如：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>如果你卸载成功了，重新source后，发现kubectl快捷命令继续可以使用。此时终端重新连接即可。</p>          </div><h2><span id="5-kubens-kubectx">5. kubens、kubectx</span></h2><h3><span id="51-安装">5.1 安装</span></h3><p>安装脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/kubectx_kubens_install.sh | sh -<br></code></pre></td></tr></table></figure><p>你可以通过修改对应文件更改 fzf 的背景颜色和字体颜色</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># vim ~/.bashrc</span><br><span class="hljs-comment"># 颜色对照表参考: https://github.com/medikoo/cli-color</span><br><span class="hljs-built_in">export</span> KUBECTX_CURRENT_FGCOLOR=$(tput setaf 6) <span class="hljs-comment"># blue text</span><br><span class="hljs-built_in">export</span> KUBECTX_CURRENT_BGCOLOR=$(tput setab 7) <span class="hljs-comment"># white background</span><br></code></pre></td></tr></table></figure><h3><span id="52-卸载">5.2 卸载</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/kubectx_kubens_uninstall.sh | sh -<br></code></pre></td></tr></table></figure><p>如果你的文件不是 ~&#x2F;.bashrc，需要替换为对应文件，以 ~&#x2F;.zshrc 为例</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/kubectx_kubens_uninstall.sh | bash -s ~/.zshrc<br></code></pre></td></tr></table></figure><p>执行完记得 <span class="label label-primary">source <～ file_name></～></span>，例如：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/.bashrc<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>如果你卸载成功了，重新source后，发现kubectl快捷命令继续可以使用。此时终端重新连接即可。</p>          </div>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
      <tag>kubectl</tag>
      
      <tag>alias</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s记不住的命令</title>
    <link href="/2023/07/23/k8s/k8s%E8%AE%B0%E4%B8%8D%E4%BD%8F%E7%9A%84%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/07/23/k8s/k8s%E8%AE%B0%E4%B8%8D%E4%BD%8F%E7%9A%84%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>懒人笔记</p>          </div><span id="more"></span><h2><span id="1-创建pod">1. 创建pod</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl run my-pod --image=nginx:latest<br></code></pre></td></tr></table></figure><h2><span id="2-更新镜像">2. 更新镜像</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl <span class="hljs-built_in">set</span> image deployment/provider provider=provider:latest<br></code></pre></td></tr></table></figure><h2><span id="3-scale">3. scale</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl scale deployment/provider --replicas=0<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl scale deployment my-deployment --replicas=0<br></code></pre></td></tr></table></figure><h2><span id="4-给-nodex2fpod-打标签">4. 给 node&#x2F;pod 打标签</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl label nodes kube-node node=kube-node<br></code></pre></td></tr></table></figure><h2><span id="5-通过标签过滤">5. 通过标签过滤</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl get node -l <span class="hljs-string">&quot;node=kube-node&quot;</span><br></code></pre></td></tr></table></figure><h2><span id="6-cp">6. cp</span></h2><h3><span id="61-拷贝pod数据到本地">6.1 拷贝pod数据到本地</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl <span class="hljs-built_in">cp</span> &lt;some-namespace&gt;/&lt;some-pod&gt;:/tmp/foo /tmp/foo<br></code></pre></td></tr></table></figure><h3><span id="62-拷贝本地数据到pod之中">6.2 拷贝本地数据到pod之中</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl <span class="hljs-built_in">cp</span> /tmp/foo &lt;some-namespace&gt;/&lt;some-pod&gt;:/tmp/foo<br></code></pre></td></tr></table></figure><h2><span id="7-查看支持的-apiversion">7. 查看支持的 apiVersion</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl api-versions<br></code></pre></td></tr></table></figure><h2><span id="8-回滚版本">8. 回滚版本</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 查看历史版本</span><br>kubectl rollout <span class="hljs-built_in">history</span> deployment provider<br><br><span class="hljs-comment"># 回滚到上一个版本</span><br>kubectl rollout undo deployment provider<br><br><span class="hljs-comment"># 回滚到指定版本</span><br>kubectl rollout undo deployment provider --to-revision=2<br></code></pre></td></tr></table></figure><h2><span id="9-污点">9. 污点</span></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl taint nodes &lt;node-name&gt; &lt;taint-key&gt;=&lt;taint-value&gt;:&lt;taint-effect&gt;<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p><code>&lt;node-name&gt;</code> 是要添加污点的节点的名称。<br><code>&lt;taint-key&gt;</code> 是污点的键。<br><code>&lt;taint-value&gt;</code> 是污点的值，可以留空。<br><code>&lt;taint-effect&gt;</code> 是污点的影响效果，可以是以下选项之一：</p><ul><li>NoSchedule：表示不将新的Pod调度到有这个污点的节点上。</li><li>PreferNoSchedule：表示尽量不将新的Pod调度到有这个污点的节点上。</li><li>NoExecute：表示不将新的Pod调度到有这个污点的节点上，并且将已经运行在节点上的Pod驱逐出节点（如果它们不匹配Pod的容忍度）。</li></ul>          </div><h2><span id="10-探测">10. 探测</span></h2><h3><span id="101-livenessprobe-存活探测">10.1 livenessProbe: 存活探测</span></h3><ul><li><strong>failureThreshold</strong>: 表示连续失败探测的次数，认为容器已经死亡，默认为3次</li><li><strong>initialDelaySeconds</strong>: 表示在容器启动后多少秒开始进行探测，默认值为10秒。</li><li><strong>periodSeconds</strong>: 表示多长时间重试一次探测，默认值为10秒</li><li><strong>successThreshold</strong>: 表示连续成功探测的次数，认为容器仍处于健康状态，默认为1次</li><li><strong>timeoutSeconds</strong>: 表示探测请求的超时时间，默认为1秒。</li></ul><h3><span id="102-readinessprobe-就绪探测">10.2 readinessProbe: 就绪探测</span></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">livenessProbe:</span><br>  <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">300</span><br>  <span class="hljs-attr">httpGet:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/-/healthy</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-string">web</span><br>    <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>  <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span><br><span class="hljs-attr">readinessProbe:</span><br>  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">300</span><br>  <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">20</span><br>  <span class="hljs-attr">httpGet:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/-/ready</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-string">web</span><br>    <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span><br>  <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><h2><span id="11-进入pod命名空间">11. 进入pod命名空间</span></h2><h3><span id="111-找到-pod-所在节点">11.1. 找到 pod 所在节点</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">k get po -owide<br><br>ssh root@xx.xx.xx.xx<br></code></pre></td></tr></table></figure><h3><span id="112-获取容器-pid">11.2. 获取容器 pid</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># docker</span><br>docker inspect --format <span class="hljs-string">&#x27;&#123;&#123; .State.Pid &#125;&#125;&#x27;</span> 容器名/ID<br><br><span class="hljs-comment"># containerd</span><br>crictl inspect 容器ID | grep pid<br></code></pre></td></tr></table></figure><h3><span id="113-进入容器网络">11.3. 进入容器网络</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">nsenter -t <span class="hljs-variable">$PID</span> -n<br></code></pre></td></tr></table></figure><h3><span id="12-更改grafana密码">12 更改grafana密码</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">grafana-cli admin reset-admin-password &lt;password&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker记不住的命令</title>
    <link href="/2023/07/23/docker/docker%E8%AE%B0%E4%B8%8D%E4%BD%8F%E7%9A%84%E5%91%BD%E4%BB%A4/"/>
    <url>/2023/07/23/docker/docker%E8%AE%B0%E4%B8%8D%E4%BD%8F%E7%9A%84%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>不想记，也记不住</p>          </div><span id="more"></span><h4><span id="启动一个容器">启动一个容器</span></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># -p: 8888为主机端口，3306为容器端口</span><br><span class="hljs-comment"># -e: 环境变量设置</span><br><span class="hljs-comment"># 最后的 mysql 为镜像 </span><br><span class="hljs-string">docker</span> <span class="hljs-string">run</span> <span class="hljs-string">-itd</span> <span class="hljs-string">--name</span> <span class="hljs-string">mysql-test</span> <span class="hljs-string">-p</span> <span class="hljs-number">8888</span><span class="hljs-string">:3306</span> <span class="hljs-string">-e</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=123456</span> <span class="hljs-string">mysql</span><br></code></pre></td></tr></table></figure><h4><span id="列出所有的容器-id">列出所有的容器 ID</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker ps -aq<br></code></pre></td></tr></table></figure><h4><span id="停止所有的容器">停止所有的容器</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker stop $(docker ps -aq)<br></code></pre></td></tr></table></figure><h4><span id="删除所有的容器">删除所有的容器</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">rm</span> $(docker ps -aq)<br></code></pre></td></tr></table></figure><h4><span id="删除所有的镜像">删除所有的镜像</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker rmi $(docker images -q)<br></code></pre></td></tr></table></figure><h4><span id="删除所有未使用的镜像">删除所有未使用的镜像</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker system prune -a<br></code></pre></td></tr></table></figure><h4><span id="删除-none-相关镜像">删除 none 相关镜像</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker rmi $(docker images | grep none | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span>)     <br></code></pre></td></tr></table></figure><h4><span id="拉取指定版本镜像">拉取指定版本镜像</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker pull tickstep/aliyunpan-sync:v0.2.7 --platform=linux/arm/v7<br></code></pre></td></tr></table></figure><h4><span id="mac-清理镜像层">mac 清理镜像层</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">rm</span> ~/Library/Containers/com.docker.docker<br></code></pre></td></tr></table></figure><h4><span id="复制文件">复制文件</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">cp</span> mycontainer:/opt/file.txt /opt/local/<br>docker <span class="hljs-built_in">cp</span> /opt/local/file.txt mycontainer:/opt/<br></code></pre></td></tr></table></figure><h4><span id="启动-x-ui">启动 x-ui</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -d --net=host --name x-ui -v /etc/x-ui:/etc/x-ui/ xxx/xxx/x-ui:latest<br></code></pre></td></tr></table></figure><h4><span id="安装最新版-docker">安装最新版 docker</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum update -y<br></code></pre></td></tr></table></figure><p>你可以单独执行更新。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 删除旧版本的Docker</span><br>sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine<br><span class="hljs-comment"># 安装依赖软件包</span><br>sudo yum install -y yum-utils device-mapper-persistent-data lvm2<br><span class="hljs-comment"># 添加Docker软件源</span><br>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo<br><span class="hljs-comment"># 更新yum缓存</span><br>sudo yum makecache fast<br><span class="hljs-comment"># 安装最新版Docker</span><br>sudo yum install -y docker-ce<br><span class="hljs-comment"># 启动Docker服务并设置开机自启动</span><br>sudo systemctl start docker<br>sudo systemctl <span class="hljs-built_in">enable</span> docker<br><span class="hljs-comment"># 确认Docker已安装并正在运行</span><br>docker --version<br>sudo docker info<br></code></pre></td></tr></table></figure><h4><span id="查看容器资源占用">查看容器资源占用</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 持续监控</span><br>docker stats<br><br><span class="hljs-comment"># 输出当前</span><br>docker stats --no-stream<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常用服务模板</title>
    <link href="/2023/07/23/linux/%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%A8%A1%E6%9D%BF/"/>
    <url>/2023/07/23/linux/%E5%B8%B8%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%A8%A1%E6%9D%BF/</url>
    
    <content type="html"><![CDATA[<div class="note note-primary">            <p>存放一些常用的模板。</p>          </div><span id="more"></span><h2><span id="1-makefile">1. Makefile</span></h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: git_push docker_build all help</span><br><br><span class="hljs-comment"># 获取 git 项目 COMMIT_HASH</span><br>COMMIT_HASH = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> git rev-parse --short=7 HEAD)</span><br>TAG := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> git describe --exact-match --abbrev=0 --tags 2&gt;/dev/null)</span><br><br><span class="hljs-keyword">ifdef</span> TAG<br>    IMAGE_TAG := <span class="hljs-variable">$(TAG)</span><br><span class="hljs-keyword">else</span><br>    IMAGE_TAG := <span class="hljs-variable">$(COMMIT_HASH)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-section">git_push: ## 上传代码到 Github</span><br>git add .<br>git commit -m <span class="hljs-string">&quot;`date &#x27;+%Y/%m/%d %H:%M:%S&#x27;`&quot;</span><br>git push origin dev<br><br><span class="hljs-section">help: ## 查看帮助</span><br>@awk &#x27;BEGIN &#123;FS = <span class="hljs-string">&quot;:.*?## &quot;</span>&#125; /^[a-zA-Z_-]+:.*?<span class="hljs-comment">## / &#123;sub(&quot;\\\\n&quot;,sprintf(&quot;\n%22c&quot;,&quot; &quot;), $$2);printf &quot; \033[36m%-20s\033[0m  %s\n&quot;, $$1, $$2&#125;&#x27; $(MAKEFILE_LIST)</span><br></code></pre></td></tr></table></figure><p><strong>指定参数</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">commit: </span><br>git commit -m <span class="hljs-string">&quot;<span class="hljs-variable">$(msg)</span>&quot;</span><br></code></pre></td></tr></table></figure><p>使用如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">make commit msg=<span class="hljs-string">&quot;makefile 测试&quot;</span>              <br></code></pre></td></tr></table></figure><h2><span id="2-dockerfile">2. Dockerfile</span></h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> golang:<span class="hljs-number">1.20</span> as builder<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /root/</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> GOOS=linux GOARCH=amd64 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o app main.go</span><br><br><span class="hljs-comment"># =================================== 分层编译 ==============================================</span><br><span class="hljs-keyword">FROM</span> alpine AS final<br><br><span class="hljs-comment"># 国内使用的goproxy</span><br><span class="hljs-keyword">ENV</span> GOPROXY=https://goproxy.cn<br><br><span class="hljs-comment"># 设置时区</span><br><span class="hljs-keyword">ENV</span> TZ=Asia/Shanghai<br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /root/</span><br><br><span class="hljs-comment"># 复制 builder 的产物</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /root/app .</span><br><br><span class="hljs-comment"># 复制本地文件夹</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./mydir/  ./mydir/</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x app \</span><br><span class="language-bash">    &amp;&amp; apk update \</span><br><span class="language-bash">    &amp;&amp; apk add --no-cache tzdata</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/app&quot;</span>]</span><br></code></pre></td></tr></table></figure><h2><span id="3-github-build-action">3. Github Build Action</span></h2><div class="note note-warning">            <p>buildx在编译时巨慢，可以通过docker指定架构去同时编译不同架构镜像并推送至 hub ，然后使用 <code>manifest</code> 来进行合并镜像。</p><p>下面这个实例首先通过 1.20 版本 golang 在不同平台进行 go build，将产生的二进制传递给对应的下一个 job，经过 make build-xx 并 push 镜像后，使用 <code>docker manifest</code> 进行合并镜像。</p><p>可以配合 <code>Makefile</code> 来看。</p>          </div><h3><span id="31-makefile-模板">3.1 Makefile 模板</span></h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: docker-build-amd64 docker-build-arm64 docker-build-armv7 docker-build-armv8 manifest help</span><br><br>COMMIT_HASH = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> git rev-parse --short=7 HEAD)</span><br>TAG := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> git describe --exact-match --abbrev=0 --tags 2&gt;/dev/null)</span><br><br><span class="hljs-keyword">ifdef</span> TAG<br>    IMAGE_TAG := <span class="hljs-variable">$(TAG)</span><br><span class="hljs-keyword">else</span><br>    IMAGE_TAG := <span class="hljs-variable">$(COMMIT_HASH)</span><br><span class="hljs-keyword">endif</span><br><br><span class="hljs-section">docker-build-amd64: ## 编译 amd64 镜像</span><br>docker build --platform linux/amd64 -t oldwang6/cloud-backup:amd64 -f build/Dockerfile .<br>docker push oldwang6/cloud-backup:amd64<br><br><span class="hljs-section">docker-build-arm64: ## 编译 arm64 镜像</span><br>docker build --platform linux/arm64 -t oldwang6/cloud-backup:arm64 -f build/Dockerfile .<br>docker push oldwang6/cloud-backup:arm64<br><br><span class="hljs-section">docker-build-armv7: ## 编译 armv7 镜像</span><br>docker build --platform linux/arm/v7 -t oldwang6/cloud-backup:armv7 -f build/Dockerfile .<br>docker push oldwang6/cloud-backup:armv7<br><br><span class="hljs-section">docker-build-armv8: ## 编译 armv8 镜像</span><br>docker build --platform linux/arm/v8 -t oldwang6/cloud-backup:armv8 -f build/Dockerfile .<br>docker push oldwang6/cloud-backup:armv8<br><br><span class="hljs-comment"># ================================= 本地测试 =================================</span><br><span class="hljs-section">docker-build-amd64-local: ## 编译 amd64 镜像</span><br>GOOS=linux GOARCH=amd64 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o cloud-backup-amd64-local main.go<br>docker build --platform linux/amd64 -t oldwang6/cloud-backup:amd64-local -f build/Dockerfile.local.amd64 .<br>docker push oldwang6/cloud-backup:amd64-local<br>rm -f cloud-backup-amd64-local<br><br><span class="hljs-section">docker-build-arm64-local: ## 编译 arm64 镜像</span><br>GOOS=linux GOARCH=arm64 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o cloud-backup-arm64-local main.go<br>docker build --platform linux/arm64 -t oldwang6/cloud-backup:arm64-local -f build/Dockerfile.local.arm64 .<br>docker push oldwang6/cloud-backup:arm64-local<br>rm -f cloud-backup-arm64-local<br><br><span class="hljs-section">manifest: ## 合并镜像</span><br>docker manifest create oldwang6/cloud-backup:$&#123;IMAGE_TAG&#125; \<br>           oldwang6/cloud-backup:amd64 \<br>   oldwang6/cloud-backup:arm64 \<br>           oldwang6/cloud-backup:armv7 \<br>   oldwang6/cloud-backup:armv8<br><br>docker manifest create oldwang6/cloud-backup:latest \<br>           oldwang6/cloud-backup:amd64 \<br>           oldwang6/cloud-backup:arm64 \<br>           oldwang6/cloud-backup:armv7 \<br>           oldwang6/cloud-backup:armv8<br><br>docker manifest push oldwang6/cloud-backup:$&#123;IMAGE_TAG&#125;<br>docker manifest push oldwang6/cloud-backup:latest<br><br><span class="hljs-section">help: ## 查看帮助</span><br>@awk &#x27;BEGIN &#123;FS = <span class="hljs-string">&quot;:.*?## &quot;</span>&#125; /^[a-zA-Z_-]+:.*?<span class="hljs-comment">## / &#123;sub(&quot;\\\\n&quot;,sprintf(&quot;\n%22c&quot;,&quot; &quot;), $$2);printf &quot; \033[36m%-20s\033[0m  %s\n&quot;, $$1, $$2&#125;&#x27; $(MAKEFILE_LIST)</span><br></code></pre></td></tr></table></figure><h3><span id="32-yaml-模板">3.2 yaml 模板</span></h3><div class="note note-warning">            <p>下面为 .github&#x2F;workflows&#x2F;build.yml 文件内容。</p>          </div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Binary</span><br><br><span class="hljs-attr">on:</span> [<span class="hljs-string">push</span>]<br><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">go-build-amd64:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">go-version:</span> <span class="hljs-string">&quot;1.20&quot;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Go版本信息</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">version</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">amd64</span> <span class="hljs-string">二进制</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          env GOOS=linux GOARCH=amd64 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o cloud-backup-amd64 main.go</span><br><span class="hljs-string">          mkdir -p $&#123;&#123; runner.workspace &#125;&#125;/bin</span><br><span class="hljs-string">          chmod +x cloud-backup-amd64</span><br><span class="hljs-string">          mv cloud-backup-amd64 $&#123;&#123; runner.workspace &#125;&#125;/bin/</span><br><span class="hljs-string"></span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">上传二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-amd64</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.workspace</span> <span class="hljs-string">&#125;&#125;/bin</span><br>  <span class="hljs-attr">go-build-arm64:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">go-version:</span> <span class="hljs-string">&quot;1.20&quot;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Go版本信息</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">version</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">arm64</span> <span class="hljs-string">二进制</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          env GOOS=linux GOARCH=arm64 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o cloud-backup-arm64 main.go</span><br><span class="hljs-string">          mkdir -p $&#123;&#123; runner.workspace &#125;&#125;/bin</span><br><span class="hljs-string">          chmod +x cloud-backup-arm64</span><br><span class="hljs-string">          mv cloud-backup-arm64 $&#123;&#123; runner.workspace &#125;&#125;/bin/</span><br><span class="hljs-string"></span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">上传二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-arm64</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.workspace</span> <span class="hljs-string">&#125;&#125;/bin</span><br><br>  <span class="hljs-attr">go-build-armv7:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">go-version:</span> <span class="hljs-string">&quot;1.20&quot;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Go版本信息</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">version</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">arm</span> <span class="hljs-string">v7</span> <span class="hljs-string">二进制</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          env GOOS=linux GOARCH=arm GOARM=7 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o cloud-backup-armv7 main.go</span><br><span class="hljs-string">          mkdir -p $&#123;&#123; runner.workspace &#125;&#125;/bin</span><br><span class="hljs-string">          chmod +x cloud-backup-armv7</span><br><span class="hljs-string">          mv cloud-backup-armv7 $&#123;&#123; runner.workspace &#125;&#125;/bin/</span><br><span class="hljs-string"></span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">上传二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-armv7</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.workspace</span> <span class="hljs-string">&#125;&#125;/bin</span><br><br>  <span class="hljs-attr">go-build-armv8:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-go@v4</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">go-version:</span> <span class="hljs-string">&quot;1.20&quot;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Go版本信息</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">go</span> <span class="hljs-string">version</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">arm</span> <span class="hljs-string">v8</span> <span class="hljs-string">二进制</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          env GOOS=linux GOARCH=arm GOARM=7 CGO_ENABLED=0 GOFLAGS=-mod=vendor go build -o cloud-backup-armv8 main.go</span><br><span class="hljs-string">          mkdir -p $&#123;&#123; runner.workspace &#125;&#125;/bin</span><br><span class="hljs-string">          chmod +x cloud-backup-armv8</span><br><span class="hljs-string">          mv cloud-backup-armv8 $&#123;&#123; runner.workspace &#125;&#125;/bin/</span><br><span class="hljs-string"></span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">上传二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-armv8</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.workspace</span> <span class="hljs-string">&#125;&#125;/bin</span><br><br>  <span class="hljs-attr">docker-build-amd64:</span><br>    <span class="hljs-attr">needs:</span> <span class="hljs-string">go-build-amd64</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">下载二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-amd64</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">./bin</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">登陆</span> <span class="hljs-string">hub</span> <span class="hljs-string">仓库</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">--username=oldwang6</span> <span class="hljs-string">-p</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HUB_PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">amd64</span> <span class="hljs-string">镜像</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          chmod +x ./bin/cloud-backup-amd64</span><br><span class="hljs-string">          mv ./bin/cloud-backup-amd64 ./bin/cloud-backup</span><br><span class="hljs-string">          make docker-build-amd64</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">docker-build-arm64:</span><br>    <span class="hljs-attr">needs:</span> <span class="hljs-string">go-build-arm64</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">下载二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-arm64</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">./bin</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">登陆</span> <span class="hljs-string">hub</span> <span class="hljs-string">仓库</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">--username=oldwang6</span> <span class="hljs-string">-p</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HUB_PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">arm64</span> <span class="hljs-string">镜像</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          chmod +x ./bin/cloud-backup-arm64</span><br><span class="hljs-string">          mv ./bin/cloud-backup-arm64 ./bin/cloud-backup</span><br><span class="hljs-string">          make docker-build-arm64</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">docker-build-armv7:</span><br>    <span class="hljs-attr">needs:</span> <span class="hljs-string">go-build-armv7</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">下载缓存二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-armv7</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">./bin</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">登陆</span> <span class="hljs-string">hub</span> <span class="hljs-string">仓库</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">--username=oldwang6</span> <span class="hljs-string">-p</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HUB_PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">arm</span> <span class="hljs-string">v7</span> <span class="hljs-string">镜像</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          chmod +x ./bin/cloud-backup-armv7</span><br><span class="hljs-string">          mv ./bin/cloud-backup-armv7 ./bin/cloud-backup</span><br><span class="hljs-string">          make docker-build-armv7</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">docker-build-armv8:</span><br>    <span class="hljs-attr">needs:</span> <span class="hljs-string">go-build-armv8</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">下载缓存二进制</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-backup-armv8</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">./bin</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">登陆</span> <span class="hljs-string">hub</span> <span class="hljs-string">仓库</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">--username=oldwang6</span> <span class="hljs-string">-p</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HUB_PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">编译</span> <span class="hljs-string">arm</span> <span class="hljs-string">v8</span> <span class="hljs-string">镜像</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          chmod +x ./bin/cloud-backup-armv8</span><br><span class="hljs-string">          mv ./bin/cloud-backup-armv8 ./bin/cloud-backup</span><br><span class="hljs-string">          make docker-build-armv8</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">manifest:</span><br>    <span class="hljs-attr">needs:</span><br>      [<br>        <span class="hljs-string">docker-build-amd64</span>,<br>        <span class="hljs-string">docker-build-arm64</span>,<br>        <span class="hljs-string">docker-build-armv7</span>,<br>        <span class="hljs-string">docker-build-armv8</span>,<br>      ]<br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">登陆</span> <span class="hljs-string">hub</span> <span class="hljs-string">仓库</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">login</span> <span class="hljs-string">--username=oldwang6</span> <span class="hljs-string">-p</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HUB_PASSWORD</span> <span class="hljs-string">&#125;&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">使用</span> <span class="hljs-string">manifest</span> <span class="hljs-string">合并镜像并推送</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">make</span> <span class="hljs-string">manifest</span><br></code></pre></td></tr></table></figure><h3><span id="33-慎用缓存">3.3 慎用缓存</span></h3><div class="note note-warning">            <p>慎用缓存！！！真坑。</p><p>如果下面这段缓存，github在传递文件给下一个workflow时，如果这个文件之前存在，就不会上传。</p><p>始作俑者：chatgpt推荐的配置文件。</p><p>排查许久。。。</p>          </div><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">缓存二进制</span><br>  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v2</span><br>  <span class="hljs-attr">with:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.workspace</span> <span class="hljs-string">&#125;&#125;/bin</span><br>    <span class="hljs-attr">key:</span> <span class="hljs-string">binaries-$&#123;&#123;</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure><h2><span id="4-xui-客户端">4. xui 客户端</span></h2><div class="note note-warning">            <p>只适用于linux环境，下载 <a href="https://github.com/v2ray/v2ray-core/releases">v2ray-core</a>，解压后替换 config.yaml 如下。执行 .&#x2F;v2ray</p>          </div><h3><span id="41-客户端配置">4.1. 客户端配置</span></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml">&#123;<br>    <span class="hljs-attr">&quot;log&quot;:</span> &#123;<br>        <span class="hljs-attr">&quot;loglevel&quot;:</span> <span class="hljs-string">&quot;warning&quot;</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;routing&quot;:</span> &#123;<br>        <span class="hljs-attr">&quot;domainStrategy&quot;:</span> <span class="hljs-string">&quot;AsIs&quot;</span>,<br>        <span class="hljs-attr">&quot;rules&quot;:</span> [<br>            &#123;<br>                <span class="hljs-attr">&quot;ip&quot;:</span> [<br>                    <span class="hljs-string">&quot;geoip:private&quot;</span><br>                ],<br>                <span class="hljs-attr">&quot;outboundTag&quot;:</span> <span class="hljs-string">&quot;direct&quot;</span>,<br>                <span class="hljs-attr">&quot;type&quot;:</span> <span class="hljs-string">&quot;field&quot;</span><br>            &#125;<br>        ]<br>    &#125;,<br>    <span class="hljs-attr">&quot;inbounds&quot;:</span> [<br>        &#123;<br>            <span class="hljs-attr">&quot;port&quot;:</span> <span class="hljs-number">1080</span>,<br>            <span class="hljs-attr">&quot;protocol&quot;:</span> <span class="hljs-string">&quot;socks&quot;</span>,<br>            <span class="hljs-attr">&quot;settings&quot;:</span> &#123;<br>                <span class="hljs-attr">&quot;auth&quot;:</span> <span class="hljs-string">&quot;noauth&quot;</span>,<br>                <span class="hljs-attr">&quot;udp&quot;:</span> <span class="hljs-literal">true</span><br>            &#125;,<br>            <span class="hljs-attr">&quot;tag&quot;:</span> <span class="hljs-string">&quot;socks&quot;</span><br>        &#125;<br>    ],<br>    <span class="hljs-attr">&quot;outbounds&quot;:</span> [<br>        &#123;<br>            <span class="hljs-attr">&quot;protocol&quot;:</span> <span class="hljs-string">&quot;vmess&quot;</span>,<br>            <span class="hljs-attr">&quot;settings&quot;:</span> &#123;<br>                <span class="hljs-attr">&quot;vnext&quot;:</span> [<br>                    &#123;<br>                        <span class="hljs-attr">&quot;users&quot;:</span> [<br>                            &#123;<br>                                <span class="hljs-attr">&quot;id&quot;:</span> <span class="hljs-string">&quot;&lt;uuid&gt;&quot;</span><br>                            &#125;<br>                        ],<br>                        <span class="hljs-attr">&quot;port&quot;:</span> <span class="hljs-string">&lt;服务端端口&gt;</span>,<br>                        <span class="hljs-attr">&quot;address&quot;:</span> <span class="hljs-string">&quot;&lt;服务端IP&gt;&quot;</span><br>                    &#125;<br>                ]<br>            &#125;<br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">&quot;protocol&quot;:</span> <span class="hljs-string">&quot;freedom&quot;</span>,<br>            <span class="hljs-attr">&quot;tag&quot;:</span> <span class="hljs-string">&quot;direct&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><h3><span id="42-命令行设置代理">4.2 命令行设置代理</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> https_proxy=http://127.0.0.1:1080 http_proxy=http://127.0.0.1:1080 all_proxy=socks5://127.0.0.1:1080<br></code></pre></td></tr></table></figure><h3><span id="43-取消设置代理">4.3 取消设置代理</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">unset</span> https_proxy<br><span class="hljs-built_in">unset</span> http_proxy<br><span class="hljs-built_in">unset</span> all_proxy<br></code></pre></td></tr></table></figure><h2><span id="5-chatgpt">5. chatgpt</span></h2><h3><span id="51-测试-apikey">5.1 测试 apikey</span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl -sfL https://raw.githubusercontent.com/oldwang12/oldwang12.github.io/master/source/shells/chatgpt_test.sh | bash -s <span class="hljs-variable">$API_KEY</span><br></code></pre></td></tr></table></figure><h3><span id="52-数据库增加卡密">5.2 数据库增加卡密</span></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> apikey (name, count, statu, used, valid)<br><span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;sk-xx&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-string">&#x27;t&#x27;</span>);<br></code></pre></td></tr></table></figure><h2><span id="6-frp">6. frp</span></h2><h3><span id="61-frpc">6.1 frpc</span></h3><h4><span id="611-docker-compose">6.1.1 docker-compose</span></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">frps:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.cn-hangzhou.aliyuncs.com/oldwang12/frpc:latest</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/k3s/frps.ini:/root/frps.ini</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br></code></pre></td></tr></table></figure><h4><span id="612-k8s">6.1.2 k8s</span></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">frps</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">frps</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">frps</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">imagePullSecrets:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hub-ali</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">frps</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.cn-hangzhou.aliyuncs.com/oldwang12/frps:latest</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/root/frps.ini</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/root/k3s/frps.ini</span>  <span class="hljs-comment"># 将 /etc/x-ui 替换为实际的主机路径</span><br></code></pre></td></tr></table></figure><h3><span id="62-frps">6.2 frps</span></h3>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Makefile</tag>
      
      <tag>Dockerfile</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
